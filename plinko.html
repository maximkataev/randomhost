<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>–ü–ª–∏–Ω–∫–æ –ñ–µ—Ä–µ–±—å—ë–≤–∫–∞</title>
  <meta name="description" content="üéØ –ù–∞–±–ª—é–¥–∞–π, –∫–∞–∫ —à–∞—Ä –ø–∞–¥–∞–µ—Ç —á–µ—Ä–µ–∑ –≥–≤–æ–∑–¥–∏–∫–∏ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø–æ —á–µ—Å—Ç–Ω—ã–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º. –§–∏–∑–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!" />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1">
  <link rel="canonical" href="https://randomhost.online/plinko.html">

  <!-- Open Graph -->
  <meta property="og:locale" content="ru_RU">
  <meta property="og:type" content="website">
  <meta property="og:title" content="–ü–ª–∏–Ω–∫–æ –ñ–µ—Ä–µ–±—å—ë–≤–∫–∞ ‚Äî —á–µ—Å—Ç–Ω–∞—è —Ñ–∏–∑–∏–∫–∞ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏">
  <meta property="og:description" content="–®–∞—Ä –ø–∞–¥–∞–µ—Ç —Å–∫–≤–æ–∑—å –≥–≤–æ–∑–¥–∏–∫–∏ –∏ –ø–æ–ø–∞–¥–∞–µ—Ç –∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é. –ù–∞—Å—Ç–æ—è—â–∞—è —Ñ–∏–∑–∏–∫–∞, —á–µ—Å—Ç–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏.">
  <meta property="og:url" content="https://randomhost.online/plinko.html">
  <meta property="og:site_name" content="–†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä-–∏–≥—Ä—ã">

  <!-- Icons -->
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f3af.svg" type="image/svg+xml">
  <meta name="theme-color" content="#764ba2">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
  
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    :root {
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      touch-action: manipulation;
    }

    .top-buttons {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }

    .desktop-menu-toggle {
      position: relative;
      background: #1e2a4d;
      color: #fff;
      border: 2px solid rgba(255,255,255,0.3);
      padding: 0;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow:
        0 4px 15px rgba(0,0,0,0.3),
        0 0 0 0 rgba(255,255,255,0.4);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      overflow: hidden;
      backdrop-filter: none;
    }

    .desktop-menu-toggle::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2, #667eea);
      background-size: 200% 200%;
      animation: gradientSpin 3s ease infinite;
      opacity: 1;
      transition: opacity 0.3s ease;
      z-index: -1;
    }

    @keyframes gradientSpin {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .desktop-menu-toggle:hover::before {
      opacity: 1;
    }

    .desktop-menu-toggle:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow:
        0 8px 25px rgba(0,0,0,0.4),
        0 0 0 8px rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.5);
    }

    .desktop-menu-toggle:active {
      transform: translateY(-1px) scale(0.98);
    }

    .menu-icon {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 24px;
      height: 18px;
      position: relative;
      transition: transform 0.3s ease;
    }

    .menu-icon span {
      display: block;
      width: 100%;
      height: 3px;
      background: #fff;
      border-radius: 2px;
      position: absolute;
      left: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .menu-icon span:nth-child(1) {
      top: 0;
    }

    .menu-icon span:nth-child(2) {
      top: 50%;
      margin-top: -1.5px;
    }

    .menu-icon span:nth-child(3) {
      bottom: 0;
    }

    .desktop-menu-toggle:hover .menu-icon {
      transform: scale(1.1);
    }

    .desktop-menu-toggle.active .menu-icon span:nth-child(1) {
      top: 50%;
      margin-top: -1.5px;
      transform: rotate(45deg);
    }

    .desktop-menu-toggle.active .menu-icon span:nth-child(2) {
      opacity: 0;
      transform: rotate(180deg) scale(0);
    }

    .desktop-menu-toggle.active .menu-icon span:nth-child(3) {
      bottom: auto;
      top: 50%;
      margin-top: -1.5px;
      transform: rotate(-45deg);
    }

    .desktop-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 15px;
      background: linear-gradient(135deg, rgba(20,25,45,0.92), rgba(40,20,55,0.92));
      backdrop-filter: blur(20px);
      border-radius: 16px;
      box-shadow:
        0 10px 40px rgba(0,0,0,0.5),
        0 0 0 1px rgba(255,255,255,0.15) inset,
        0 0 20px rgba(102,126,234,0.2);
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-10px);
      transition:
        max-height 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55),
        opacity 0.3s ease,
        transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      min-width: 240px;
    }

    .desktop-dropdown.active {
      max-height: 600px;
      opacity: 1;
      transform: translateY(0);
    }

    .desktop-dropdown a {
      position: relative;
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      color: #fff;
      text-decoration: none;
      font-size: 16px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .desktop-dropdown a::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      transform: translateX(-4px);
      transition: transform 0.3s ease;
    }

    .desktop-dropdown a::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(102,126,234,0.2), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .desktop-dropdown a:last-child {
      border-bottom: none;
    }

    .desktop-dropdown a:hover {
      background: rgba(102,126,234,0.25);
      padding-left: 24px;
      color: #ffd43b;
      text-shadow: 0 0 10px rgba(255,212,59,0.5);
    }

    .desktop-dropdown a:hover::before {
      transform: translateX(0);
    }

    .desktop-dropdown a:hover::after {
      opacity: 1;
    }

    .desktop-dropdown a:active {
      background: rgba(118,75,162,0.3);
      transform: scale(0.98);
    }

    .desktop-dropdown a span:first-child {
      font-size: 20px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      transition: transform 0.3s ease;
    }

    .desktop-dropdown a:hover span:first-child {
      transform: scale(1.2) rotate(10deg);
    }

    /* ===== MOBILE –ú–ï–ù–Æ (–°–ö–†–´–¢–û –ü–û –î–ï–§–û–õ–¢–£ –ù–ê DESKTOP) ===== */
    .menu-container {
      display: none;
    }

    /* ===== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† ===== */
    .main-container {
      display: flex;
      flex-direction: row-reverse;
      gap: 40px;
      align-items: center;
      max-width: 1200px;
      width: 100%;
    }

    .game-container {
      flex: 1;
      text-align: center;
      perspective: 1000px;
    }

    .settings-panel {
      width: 450px;
      padding: 30px;
      border-radius: 20px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .settings-title {
      color: #fff;
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .settings-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      padding: 0;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
      border-color: rgba(255,255,255,0.5);
    }

    .icon-btn:active {
      transform: translateY(0px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .icon-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.15);
    }

    .icon-btn:disabled:hover {
      transform: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.15);
    }

    .icon-btn svg {
      width: 20px;
      height: 20px;
      transition: all 0.3s ease;
    }

    .icon-btn:hover svg {
      filter: drop-shadow(0 0 4px rgba(255,255,255,0.5));
    }

    .icon-btn:disabled svg {
      opacity: 0.5;
    }

    .collapse-btn {
      display: none;
    }

    .names-list-wrapper {
      transition: max-height 0.3s ease;
    }

    .names-list-wrapper.collapsed {
      max-height: 0;
      overflow: hidden;
    }

    .names-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
      max-height: 500px;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding-right: 5px;
    }
    .names-list::-webkit-scrollbar {
      display: none;
    }

    .headers-row {
      display: flex;
      align-items: center;
      gap: 0px;
      margin-bottom: 10px;
      padding: 0 5px;
    }

    .header-name {
      flex: 1;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      font-weight: 600;
      text-align: left;
    }

    .header-probability {
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      width: 120px;
      flex-shrink: 0;
    }

    .header-remove {
      width: 44px;
    }

    .name-item {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .name-input {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 16px;
      transition: 0.3s;
    }
    .name-input:focus {
      outline: none;
      border-color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.2);
    }
    .name-input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .probability-controls {
      display: flex;
      gap: 5px;
      width: 120px;
      flex-shrink: 0;
    }

    .prob-btn {
      padding: 5px 10px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: 0.2s;
      flex-shrink: 0;
    }

    .prob-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }

    .prob-btn:active {
      transform: scale(0.95);
    }

    .probability-input {
      width: 55px;
      padding: 4px;
      background: rgba(255,255,255,0.1);
      color: #ffd43b;
      border: 2px solid rgba(255,212,59,0.3);
      border-radius: 5px;
      text-align: center;
      font-weight: 800;
      font-size: 14px;
      transition: 0.2s;
      flex-shrink: 0;
    }

    .prob-btn,
    .remove-btn,
    .add-btn-small {
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .equalize-btn {
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .prob-btn:hover,
    .remove-btn:hover,
    .add-btn-small:hover,
    .equalize-btn:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }

    .probability-input:focus {
      outline: none;
      border-color: rgba(255,212,59,0.6);
      background: rgba(255,255,255,0.15);
    }

    .probability-input.error {
      border-color: rgba(239,68,68,0.8);
      background: rgba(239,68,68,0.2);
    }

    .probability-input.manual {
      background: rgba(255,244,204,0.25);
      border-color: #F59E0B;
      box-shadow: 0 0 0 3px rgba(245,158,11,0.25);
    }

    .remove-btn {
      padding: 8px 13px;
      background: rgba(239,68,68,0.7);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      transition: 0.3s;
    }

    .remove-btn:hover {
      background: rgba(239,68,68,0.9);
      transform: scale(1.1);
    }

    .remove-btn:active {
      transform: scale(0.95);
    }

    .add-name-container {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .add-btn-small {
      padding: 10px 15px;
      background: rgba(34,197,94,0.7);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 20px;
      transition: 0.3s;
    }
    .add-btn-small:hover {
      background: rgba(34,197,94,0.9);
      transform: scale(1.1);
    }

    .add-btn-small:active {
      transform: scale(0.95);
    }

    /* ===== –ó–ê–ì–û–õ–û–í–û–ö ===== */
    h1 {
      color: #fff;
      font-size: 48px;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-weight: 800;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.3); }
      to { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.5); }
    }

    /* ===== –ü–õ–ò–ù–ö–û –ü–û–õ–ï ===== */
    .plinko-container {
      position: relative;
      width: min(92vw, 600px);
      height: min(70vh, 620px);
      margin: 0 auto 20px;
      border-radius: 24px;
      background: rgba(0,0,0,0.15);
      box-shadow: 0 0 0 8px rgba(255,255,255,0.15),
                  0 0 0 12px rgba(255,255,255,0.08),
                  0 12px 40px rgba(0,0,0,0.35);
      overflow: hidden;
    }
    canvas#plinkoCanvas {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 24px;
    }

    /* ===== –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===== */
    .controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }

    button:not(.icon-btn):not(.prob-btn):not(.remove-btn):not(.add-btn-small):not(.desktop-menu-toggle) {
      padding: 15px 30px;
      font-size: 18px;
      font-weight: 800;
      border: none;
      border-radius: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: 0.3s;
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }

    button:not(.icon-btn):not(.prob-btn):not(.remove-btn):not(.add-btn-small):not(.desktop-menu-toggle):before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:not(.icon-btn):not(.prob-btn):not(.remove-btn):not(.add-btn-small):hover:before {
      width: 300px;
      height: 300px;
    }

    button:not(.icon-btn):not(.prob-btn):not(.remove-btn):not(.add-btn-small):hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .name-input.error-state {
      border-color: #ef4444 !important;
      background: rgba(239,68,68,0.1) !important;
    }

    .name-input.error-state::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .name-input::placeholder {
      color: rgba(255,255,255,0.5);
      transition: color 0.3s ease;
    }

    .settings-panel {
      transition: opacity 0.3s ease;
    }

    /* ===== –≠–§–§–ï–ö–¢–´ ===== */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      z-index: 0;
      pointer-events: none;
      animation: confetti-fall 3s ease-out forwards;
    }

    @keyframes confetti-fall {
      0% { transform: translateY(0) rotate(300deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .celebration-emoji {
      position: fixed;
      font-size: 60px;
      z-index: 998;
      pointer-events: none;
      animation: emojiCelebrate 3s ease-out forwards;
    }

    @keyframes emojiCelebrate {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      20% { transform: scale(1.5) rotate(180deg); opacity: 1; }
      80% { opacity: 1; }
      100% { transform: scale(0.5) rotate(360deg); opacity: 0; }
    }

    .celebration-word {
      position: fixed;
      font-size: 40px;
      font-weight: 800;
      color: #fff;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
      z-index: 998;
      pointer-events: none;
      opacity: 0.7;
      animation: wordFloat 4s ease-out forwards;
    }

    @keyframes wordFloat {
      0% { transform: scale(0) translateY(0) rotate(-15deg); opacity: 0; }
      15% { transform: scale(1.2) translateY(-20px) rotate(5deg); opacity: 0.9; }
      50% { opacity: 0.8; }
      100% { transform: scale(0.8) translateY(-150px) rotate(15deg); opacity: 0; }
    }

    .winner-announcement {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, rgba(102,126,234,0.95), rgba(118,75,162,0.95));
      padding: 40px 60px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      z-index: 1001;
      display: none;
      text-align: center;
    }

    .winner-announcement.show {
      display: block;
      animation: winnerAppear 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes winnerAppear {
      0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
    }

    .winner-announcement h2 {
      color: #fff;
      font-size: 36px;
      margin: 0;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      line-height: 1.2;
    }

    .winner-name {
      display: block;
      margin: 8px 0 0;
      font-size: 1.4em;
      letter-spacing: 0.03em;
    }

    .winner-emoji {
      font-size: 1.2em;
    }

    button:disabled,
    input:disabled {
      opacity: 0.5;
      cursor: not-allowed !important;
      pointer-events: none;
    }

    /* ===== PREFERS REDUCED MOTION ===== */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ===== MOBILE –ê–î–ê–ü–¢–ò–í ===== */
    @media (max-width: 918px) {
      html, body {
        max-width: 100%;
        overflow-x: hidden;
      }
      body {
        padding: calc(66px + var(--safe-top)) var(--safe-right) calc(20px + var(--safe-bottom)) var(--safe-left);
      }

      /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é, —Å–∫—Ä—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
      .top-buttons {
        display: none;
      }

      .menu-container {
        display: block;
        position: fixed;
        top: var(--safe-top);
        left: var(--safe-left);
        right: var(--safe-right);
        z-index: 1000;
        padding: 12px 16px;
        background: linear-gradient(180deg, rgba(102,126,234,0.95) 0%, rgba(118,75,162,0.85) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }

      .menu-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .menu-title {
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }

      .burger-btn {
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 4px;
        transition: all 0.3s ease;
        min-width: 44px;
        min-height: 44px;
        align-items: center;
        justify-content: center;
      }

      .burger-btn:hover {
        background: rgba(255,255,255,0.3);
      }

      .burger-btn span {
        display: block;
        width: 24px;
        height: 3px;
        background: #fff;
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      .burger-btn.active span:nth-child(1) {
        transform: rotate(45deg) translateY(7px);
      }

      .burger-btn.active span:nth-child(2) {
        opacity: 0;
      }

      .burger-btn.active span:nth-child(3) {
        transform: rotate(-45deg) translateY(-7px);
      }

      .menu-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, rgba(102,126,234,0.98) 0%, rgba(118,75,162,0.98) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .menu-dropdown.active {
        max-height: 500px;
      }

      .menu-dropdown a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        color: #fff;
        text-decoration: none;
        font-size: 16px;
        font-weight: 600;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        transition: background 0.2s ease;
        min-height: 56px;
      }

      .menu-dropdown a:last-child {
        border-bottom: none;
      }

      .menu-dropdown a:hover {
        background: rgba(255,255,255,0.15);
      }

      .menu-dropdown a:active {
        background: rgba(255,255,255,0.25);
      }

      /* –ú–æ–±–∏–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ */
      .main-container {
        flex-direction: column;
        gap: 24px;
        align-items: stretch;
      }

      .game-container {
        order: -1;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
      }

      .add-name-container {
        display: flex;
        gap: 8px;
        margin-top: 15px;
      }

      .add-name-container .name-input {
        flex: 0 1 calc(100% - 60px);
        max-width: calc(100% - 60px);
      }

      .settings-panel {
        width: 100%;
        max-width: 600px;
        padding: 20px 16px;
        margin: 0 auto;
      }

      .settings-header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .settings-actions {
        display: flex;
        gap: 6px;
      }

      .icon-btn {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      .icon-btn svg {
        width: 18px;
        height: 18px;
      }

      .collapse-btn {
        display: none !important;
      }

      .name-item {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
      }

      .names-list-wrapper {
        max-height: none;
      }

      .names-list {
        max-height: none;
        overflow-y: visible;
        overflow: visible;
        width: 100%;
        max-width: 100%;
        flex: 1 1 auto;
      }

      .name-input.invalid,
      #newNameInput.invalid {
        border-color: #ef4444 !important;
        background: rgba(239,68,68,0.1) !important;
      }

      #newNameInput::placeholder {
        transition: color 0.3s ease;
      }

      #newNameInput.invalid::placeholder {
        color: #ef4444;
      }

      h1 {
        font-size: clamp(24px, 6vw, 48px);
        margin-bottom: 30px;
        margin-top: 18px !important;
      }

      .plinko-container {
        width: min(90vw, 400px);
        height: min(62vh, 500px);
        margin: 0 auto 32px;
      }

      .controls {
        gap: 16px;
        flex-wrap: wrap;
        margin-top: 24px;
      }

      .controls button {
        flex: 1 1 220px;
        min-height: 56px;
        max-width: 100%;
      }

      .winner-announcement {
        padding: clamp(24px, 5vw, 40px) clamp(32px, 8vw, 60px);
        max-width: 92%;
        width: 92%;
        padding: 20px 18px;
        border-radius: 16px;
      }

      .winner-announcement h2 {
        font-size: clamp(22px, 5.4vw, 30px);
      }

      .winner-name {
        font-size: clamp(24px, 6vw, 34px);
        margin-top: 6px;
      }

      .winner-emoji {
        font-size: clamp(24px, 6vw, 32px);
      }

      .celebration-word {
        font-size: clamp(22px, 5.5vw, 40px);
      }

      .celebration-emoji {
        font-size: clamp(40px, 10vw, 60px);
      }

      .headers-row {
        padding: 0 2px;
      }

      .header-probability {
        flex: 0 0 170px;
        max-width: 170px;
        display: flex;
        justify-content: center;
        text-align: center;
      }

      .probability-controls {
        flex: 0 0 130px;
        max-width: 130px;
        gap: 4px;
        flex-shrink: 0;
      }

      .probability-input {
        flex: 0 0 50px;
        width: 50px;
        min-width: 50px;
        max-width: 50px;
      }

      .prob-btn {
        flex: 0 0 44px;
        width: 44px;
        min-width: 44px;
        max-width: 44px;
        min-height: 44px;
        padding: 6px 0;
      }

      .name-input {
        min-width: 0;
        padding: 12px 10px;
        min-height: 48px;
        flex: 1 1 auto;
      }

      .remove-btn {
        flex: 0 0 48px;
        width: 48px;
        min-width: 48px;
        max-width: 48px;
        min-height: 48px;
        margin-left: 14px;
      }

      .add-btn-small {
        min-width: 52px;
        min-height: 52px;
        flex-shrink: 0;
      }
    }

    /* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
    @media (max-width: 360px) {
      .plinko-container {
        width: min(85vw, 300px);
        height: min(55vh, 400px);
      }

      .probability-controls,
      .header-probability {
        width: auto;
      }

      .probability-input {
        min-width: 46px;
        font-size: 13px;
        flex-shrink: 0;
      }

      .prob-btn {
        min-width: 40px;
        padding: 5px 7px;
        flex-shrink: 0;
      }
    }

    /* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ hover-—ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –Ω–∞ —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (hover: none) and (pointer: coarse) {
      .prob-btn:hover,
      .add-btn-small:hover,
      .remove-btn:hover,
      .icon-btn:hover,
      button:not(.icon-btn):not(.prob-btn):not(.remove-btn):not(.add-btn-small):hover {
        transform: none !important;
      }
      button:not(.icon-btn):not(.prob-btn):not(.remove-btn):not(.add-btn-small):before {
        display: none;
      }

      /* –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é */
      .menu-container {
        display: block;
        position: fixed;
        top: env(safe-area-inset-top, 0px);
        left: env(safe-area-inset-left, 0px);
        right: env(safe-area-inset-right, 0px);
        z-index: 1000;
        padding: 12px 16px;
        background: linear-gradient(180deg, rgba(102,126,234,0.95) 0%, rgba(118,75,162,0.85) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }

      .menu-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .menu-title {
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }

      .burger-btn {
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 4px;
        transition: all 0.3s ease;
        min-width: 44px;
        min-height: 44px;
        align-items: center;
        justify-content: center;
      }

      .burger-btn:hover {
        background: rgba(255,255,255,0.3);
      }

      .burger-btn span {
        display: block;
        width: 24px;
        height: 3px;
        background: #fff;
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      .burger-btn.active span:nth-child(1) {
        transform: rotate(45deg) translateY(7px);
      }

      .burger-btn.active span:nth-child(2) {
        opacity: 0;
      }

      .burger-btn.active span:nth-child(3) {
        transform: rotate(-45deg) translateY(-7px);
      }

      .menu-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, rgba(102,126,234,0.98) 0%, rgba(118,75,162,0.98) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .menu-dropdown.active {
        max-height: 500px;
      }

      .menu-dropdown a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        color: #fff;
        text-decoration: none;
        font-size: 16px;
        font-weight: 600;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        transition: background 0.2s ease;
        min-height: 56px;
      }

      .menu-dropdown a:last-child {
        border-bottom: none;
      }

      .menu-dropdown a:hover {
        background: rgba(255,255,255,0.15);
      }

      .menu-dropdown a:active {
        background: rgba(255,255,255,0.25);
      }

      /* –°–∫—Ä—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–µ –º–µ–Ω—é –Ω–∞ —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
      .top-buttons {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Desktop Menu -->
  <div class="top-buttons">
  <button class="desktop-menu-toggle" id="desktopMenuToggle" aria-label="–ú–µ–Ω—é">
    <div class="menu-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </button>
    <nav class="desktop-dropdown" id="desktopDropdown">
      <a href="index.html">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      <a href="bingo.html">üé≤ –ë–∏–Ω–≥–æ</a>
      <a href="el-credito.html">üá≤üáΩ –ë–∞–Ω–∫</a>
      <a href="wheel-of-fortune.html">üé° –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</a>
      <a href="lottery-drum.html">üé± –õ–æ—Ç–æ—Ç—Ä–æ–Ω</a>
      <a href="crystal-ball.html">üîÆ –ú–∞–≥–∏—á–µ—Å–∫–∏–π –®–∞—Ä</a>
      <a href="plinko.html">üéØ –ü–ª–∏–Ω–∫–æ</a>
      <a href="racing.html">üèÅ –ì–æ–Ω–∫–∏</a>
      <a href="trading.html">üìà –¢—Ä–µ–π–¥–∏–Ω–≥</a>
      <a href="tournament.html">‚öîÔ∏è –¢—É—Ä–Ω–∏—Ä</a>
    </nav>
  </div>
  <!-- MOBILE –ú–ï–ù–Æ -->
  <div class="menu-container">
    <div class="menu-header">
      <button class="burger-btn" id="burgerBtn" aria-label="–ú–µ–Ω—é">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  <nav class="menu-dropdown" id="menuDropdown">
      <a href="index.html">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      <a href="bingo.html">üé≤ –ë–∏–Ω–≥–æ</a>
      <a href="el-credito.html">üá≤üáΩ –ë–∞–Ω–∫</a>
      <a href="wheel-of-fortune.html">üé° –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</a>
      <a href="lottery-drum.html">üé± –õ–æ—Ç–æ—Ç—Ä–æ–Ω</a>
      <a href="crystal-ball.html">üîÆ –ú–∞–≥–∏—á–µ—Å–∫–∏–π –®–∞—Ä</a>
      <a href="plinko.html">üéØ –ü–ª–∏–Ω–∫–æ</a>
      <a href="racing.html">üèÅ –ì–æ–Ω–∫–∏</a>
      <a href="trading.html">üìà –¢—Ä–µ–π–¥–∏–Ω–≥</a>
      <a href="tournament.html">‚öîÔ∏è –¢—É—Ä–Ω–∏—Ä</a>
  </nav>

  </div>

  <div class="main-container">
    <!-- –ò–ì–†–ê -->
    <div class="game-container">
      <h1>üéØ –ü–õ–ò–ù–ö–û</h1>
      <div class="plinko-container">
        <canvas id="plinkoCanvas"></canvas>
      </div>
      <div class="controls">
        <button id="dropBtn">–ó–∞–ø—É—Å—Ç–∏—Ç—å —à–∞—Ä</button>
      </div>
    </div>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div class="settings-panel">
      <div class="settings-header">
        <h2 class="settings-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
        <div class="settings-actions">
          <button class="icon-btn equalize-btn" id="equalizeBtn" title="–£—Ä–∞–≤–Ω—è—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="4" y="8" width="16" height="3" rx="1.5" fill="white"/>
              <rect x="4" y="13" width="16" height="3" rx="1.5" fill="white"/>
            </svg>
          </button>
          <button class="icon-btn shuffle-btn" id="shuffleBtn" title="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="names-list-wrapper" id="namesListWrapper">
        <div class="headers-row">
          <div class="header-name">–ò–º—è</div>
          <div class="header-probability">üìä –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</div>
          <div class="header-remove"></div>
        </div>
        <div class="names-list" id="namesList"></div>
      </div>

      <div class="add-name-container">
        <input type="text" class="name-input" id="newNameInput" placeholder="–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫" maxlength="15">
        <button class="add-btn-small" id="addNameBtn" title="–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞">‚ûï</button>
      </div>
    </div>
  </div>

  <div class="winner-announcement" id="winnerAnnouncement">
    <h2 id="winnerText"></h2>
  </div>

  <script>
    // ===== –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –£–°–¢–†–û–ô–°–¢–í–ê =====
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
    // ===== –ö–û–ù–°–¢–ê–ù–¢–´ =====
    const colors = [
      '#ff6b6b','#ffd43b','#51cf66','#339af0','#da77f2','#66d9e8',
      '#fb923c','#ec4899','#8b5cf6','#14b8a6','#f97316','#06b6d4'
    ];

    const NAMES_KEY = 'shared_names_v1';
    const PROB_KEY = 'shared_probabilities_v2';
    const LOCKED_KEY = 'shared_locked_v1';

    // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
    let names = ['–î–∏–º–∞','–°–∞—à–∞','–ù–∏–∫–∏—Ç–∞','–ú–∞–∫—Å–∏–º','–ö–∏—Ä–∏–ª–ª','–°–µ–º—ë–Ω'];
    let probabilities = {};
    let lockedParticipants = {};
    let hasCustomProbabilities = false;
    let isLoadingFromStorage = false; // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage

    let animId = null;

    // ===== DOM –≠–õ–ï–ú–ï–ù–¢–´ =====
    const namesList = document.getElementById('namesList');
    const addNameBtn = document.getElementById('addNameBtn');
    const newNameInput = document.getElementById('newNameInput');
    const equalizeBtn = document.getElementById('equalizeBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const dropBtn = document.getElementById('dropBtn');
    const winnerAnnouncement = document.getElementById('winnerAnnouncement');
    const winnerText = document.getElementById('winnerText');
    const canvas = document.getElementById('plinkoCanvas');
    const ctx = canvas.getContext('2d');
    const namesListWrapper = document.getElementById('namesListWrapper');

    const defaultNewNamePlaceholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';

    function resetNewNamePlaceholder() {
      newNameInput.placeholder = defaultNewNamePlaceholder;

      // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ ‚Äî –≤–µ—Ä–Ω—É—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –≤–∏–¥
      if (!newNameInput.value.trim()) {
        newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
        newNameInput.style.background = 'rgba(255,255,255,0.1)';
      }
    }

    newNameInput.addEventListener('focus', resetNewNamePlaceholder);
    newNameInput.addEventListener('click', resetNewNamePlaceholder);

    // ===== –§–£–ù–ö–¶–ò–Ø –ü–û–ö–ê–ó–ê –û–®–ò–ë–ö–ò =====
    function showNewNameInputError(message) {
      newNameInput.style.borderColor = '#ef4444';
      newNameInput.style.background = 'rgba(239,68,68,0.1)';
      const oldPlaceholder = newNameInput.placeholder;
      newNameInput.placeholder = message;
      
      setTimeout(() => {
        newNameInput.placeholder = oldPlaceholder;
        if (!newNameInput.value.trim()) {
          newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
          newNameInput.style.background = 'rgba(255,255,255,0.1)';
        }
      }, 2500);
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫
    newNameInput.addEventListener('keydown', (e) => {
      if (newNameInput.value.length >= 15 && 
          !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'].includes(e.key) &&
          !e.ctrlKey && !e.metaKey) {
        
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
        newNameInput.placeholder = '–ú–∞–∫—Å–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤';
        
        setTimeout(() => {
          newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
          if (newNameInput.value.trim()) {
            const dup = names.some((n) => n.toLowerCase() === newNameInput.value.trim().toLowerCase());
            if (!dup) {
              newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
              newNameInput.style.background = 'rgba(255,255,255,0.1)';
            }
          } else {
            newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
            newNameInput.style.background = 'rgba(255,255,255,0.1)';
          }
        }, 1500);
      }
    });

    function setUILocked(locked) {
      dropBtn.disabled = locked;
      addNameBtn.disabled = locked;
      newNameInput.disabled = locked;
      equalizeBtn.disabled = locked;
      shuffleBtn.disabled = locked;

      const allInputs = namesList.querySelectorAll('.name-input, .probability-input');
      const allButtons = namesList.querySelectorAll('.prob-btn, .remove-btn');

      allInputs.forEach(input => input.disabled = locked);
      allButtons.forEach(button => button.disabled = locked);

      if (locked) {
        document.querySelector('.settings-panel').style.opacity = '0.5';
        document.querySelector('.settings-panel').style.pointerEvents = 'none';
      } else {
        document.querySelector('.settings-panel').style.opacity = '1';
        document.querySelector('.settings-panel').style.pointerEvents = 'auto';
      }
    }

    function validateAllNames() {
      let allValid = true;
      
      const nameInputs = namesList.querySelectorAll('.name-input');
      nameInputs.forEach(input => {
        const value = input.value.trim();
        if (!value || value.length === 0 || input.value.length > 15) {
          allValid = false;
        }
      });
      
      dropBtn.disabled = !allValid || animId !== null;
      
      return allValid;
    }

  // ===== DESKTOP MENU =====
  const desktopMenuToggle = document.getElementById('desktopMenuToggle');
  const desktopDropdown = document.getElementById('desktopDropdown');
  let desktopMenuOpen = false;

  function toggleDesktopMenu() {
    desktopMenuOpen = !desktopMenuOpen;
    desktopDropdown.classList.toggle('active', desktopMenuOpen);
    desktopMenuToggle.classList.toggle('active', desktopMenuOpen);
  }

  if (desktopMenuToggle) {
    desktopMenuToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleDesktopMenu();
    });

    document.addEventListener('click', (e) => {
      if (
        desktopMenuOpen &&
        !desktopDropdown.contains(e.target) &&
        !desktopMenuToggle.contains(e.target)
      ) {
        toggleDesktopMenu();
      }
    });
  }

  // ===== BURGER MENU (MOBILE) =====
  const burgerBtn = document.getElementById('burgerBtn');
  const menuDropdown = document.getElementById('menuDropdown');
  let menuOpen = false;

  function toggleMenu() {
    menuOpen = !menuOpen;
    menuDropdown.classList.toggle('active', menuOpen);
    burgerBtn.classList.toggle('active', menuOpen);
  }

  if (burgerBtn) {
    burgerBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu();
    });

    document.addEventListener('click', (e) => {
      if (
        menuOpen &&
        !menuDropdown.contains(e.target) &&
        !burgerBtn.contains(e.target)
      ) {
        toggleMenu();
      }
    });
  }

    // ===== –ó–í–£–ö =====
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(f, d, v) {
      try {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.value = f;
        g.gain.value = v || 0.1;
        o.connect(g);
        g.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        o.start(t);
        o.stop(t + (d || 0.1));
      } catch(e) {}
    }

    const playTickSound = () => playSound(800, 0.04, 0.12);
    const playWinSound = () => playSound(1200, 0.3, 0.25);
    
    function playFanfare() {
      [523, 659, 784, 1046, 784, 1046, 1319, 1568].forEach((f, i) =>
        setTimeout(() => playSound(f, 0.18, 0.105), i * 150)
      );
    }

    // ===== –ó–ê–ì–†–£–ó–ö–ê –ò–ú–ï–ù =====
    try {
      const saved = JSON.parse(localStorage.getItem(NAMES_KEY) || '[]');
      if (Array.isArray(saved) && saved.length) {
        names = saved;
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è 1: –ï—Å–ª–∏ 1 —É—á–∞—Å—Ç–Ω–∏–∫ - –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–≥–æ
        if (names.length === 1) {
          names.push('–£—á–∞—Å—Ç–Ω–∏–∫ 2');
          // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º - –ø—Ä–æ—Å—Ç–æ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è 2: –ï—Å–ª–∏ –±–æ–ª–µ–µ 20 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ - –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã—Ö 20
        if (names.length > 20) {
          names = names.slice(0, 20);
          // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º - –ø—Ä–æ—Å—Ç–æ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
        }
      } else {
        localStorage.setItem(NAMES_KEY, JSON.stringify(names));
      }
    } catch(e) {}

    const saveNames = () => {
      try {
        localStorage.setItem(NAMES_KEY, JSON.stringify(names));
      } catch(e) {}
    };

    // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ï–†–û–Ø–¢–ù–û–°–¢–Ø–ú–ò =====
    function initProbabilities() {
      isLoadingFromStorage = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
      
      try {
        const saved = JSON.parse(localStorage.getItem(PROB_KEY) || '{}');
        const savedLocked = JSON.parse(localStorage.getItem(LOCKED_KEY) || '{}');

        if (saved?.hasCustomProbabilities && saved?.probabilities && Object.keys(saved.probabilities).length) {
          probabilities = { ...saved.probabilities };
          lockedParticipants = { ...savedLocked };
          hasCustomProbabilities = true;

          // –£–¥–∞–ª—è–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ names
          Object.keys(probabilities).forEach((n) => { if (!names.includes(n)) delete probabilities[n]; });
          Object.keys(lockedParticipants).forEach((n) => { if (!names.includes(n)) delete lockedParticipants[n]; });
          
          // –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–µ—Å–ª–∏ –±—ã–ª–∏ –æ–±—Ä–µ–∑–∞–Ω—ã –¥–æ 20)
          names.forEach((n) => { if (!(n in probabilities)) probabilities[n] = 0.05; });
          
          // –í–∞–ª–∏–¥–∞—Ü–∏—è 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –º–µ–Ω–µ–µ 5%
          validateAndFixProbabilities();
          
          // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º - –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Å—Ç–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã
        } else {
          setEqualProbabilities();
        }
      } catch(_) {
        setEqualProbabilities();
      }
      
      isLoadingFromStorage = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    }
    
    function validateAndFixProbabilities() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –º–µ–Ω–µ–µ 5%
      const belowMin = names.filter(n => (probabilities[n] ?? 0) < 0.05);
      
      if (belowMin.length === 0) {
        // –í—Å—ë –æ–∫, –ø—Ä–æ—Å—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
        const sum = names.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
        if (Math.abs(sum - 1) > 1e-4) {
          const k = 1 / sum;
          names.forEach((nm) => probabilities[nm] = (probabilities[nm] || 0) * k);
        }
        return;
      }
      
      // –ï—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é < 5%
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º 5%
      belowMin.forEach(n => probabilities[n] = 0.05);
      
      // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ 5%
      const fixedSum = belowMin.length * 0.05;
      const others = names.filter(n => !belowMin.includes(n));
      
      if (others.length === 0) {
        // –í—Å–µ –±—ã–ª–∏ –Ω–∏–∂–µ 5% - –¥–µ–ª–∞–µ–º —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
        setEqualProbabilities();
        return;
      }
      
      // –°—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—É–º–º—É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
      const othersSum = others.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
      const remainForOthers = 1 - fixedSum;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ–º –ª–∏ –º—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
      if (othersSum > 0) {
        const scale = remainForOthers / othersSum;
        others.forEach(nm => probabilities[nm] = (probabilities[nm] || 0) * scale);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—Ç–∞–ª –ª–∏ –∫—Ç–æ-—Ç–æ –º–µ–Ω—å—à–µ 5% –ø–æ—Å–ª–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        const stillBelowMin = others.some(nm => (probabilities[nm] ?? 0) < 0.05);
        
        if (stillBelowMin) {
          // –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ - —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
          setEqualProbabilities();
        }
      } else {
        // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–ø–æ—Ä—Ü–∏—è—Ö - —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
        setEqualProbabilities();
      }
    }

    function setEqualProbabilities() {
      const p = 1 / (names.length || 1);
      probabilities = {};
      names.forEach((nm) => probabilities[nm] = p);
      lockedParticipants = {};
      hasCustomProbabilities = false;
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ù–ï –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
      if (!isLoadingFromStorage) {
        saveProbabilities();
      }
    }

    function clampProbabilitiesMin(min = 0.05) {
      names.forEach((nm) => { if ((probabilities[nm] ?? 0) < min) probabilities[nm] = min; });
    }

    function normalizeProbabilities() {
      // –ï—Å–ª–∏ –Ω–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π - –ø—Ä–æ—Å—Ç–æ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
      if (!hasCustomProbabilities) {
        const exact = 1 / (names.length || 1);
        names.forEach((nm) => probabilities[nm] = exact);
        return;
      }

      // –†–∞–∑–¥–µ–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏ –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
      const locked = names.filter(n => lockedParticipants[n]);
      const unlocked = names.filter(n => !lockedParticipants[n]);
      
      // –ï—Å–ª–∏ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã - –ø—Ä–æ—Å—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
      if (unlocked.length === 0) {
        const sum = names.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
        if (sum > 0 && Math.abs(sum - 1) > 1e-4) {
          const k = 1 / sum;
          names.forEach((nm) => probabilities[nm] = (probabilities[nm] || 0) * k);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º—É–º 5% —Å –±–û–ª—å—à–µ–π –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å—é
        const hasViolation = names.some(nm => (probabilities[nm] ?? 0) < 0.049);
        if (hasViolation) {
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å—ë
          setEqualProbabilities();
        }
        return;
      }
      
      // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
      const lockedSum = locked.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–æ–∑–º–æ–∂–Ω–æ –ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
      const minUnlockedTotal = unlocked.length * 0.05; // –º–∏–Ω–∏–º—É–º –¥–ª—è –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
      const remainForUnlocked = 1 - lockedSum;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å –±–û–ª—å—à–µ–π –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å—é
      const lockedViolation = locked.some(nm => (probabilities[nm] ?? 0) < 0.049);
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å 0.001 (0.1%) –≤–º–µ—Å—Ç–æ 1e-6
      if (lockedViolation || remainForUnlocked < minUnlockedTotal - 0.001 || lockedSum > 1.001) {
        // –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–±–ª—é—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ 5% - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∏–∫—Å–∞—Ü–∏–∏
        setEqualProbabilities();
        return;
      }
      
      // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –ø–æ—Ä–æ–≤–Ω—É –º–µ–∂–¥—É –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏
      const sharePerUnlocked = remainForUnlocked / unlocked.length;
      unlocked.forEach(nm => probabilities[nm] = sharePerUnlocked);
      
      // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∏–Ω–∏–º—É–º 5% —Å –±–û–ª—å—à–µ–π –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å—é
      const finalViolation = names.some(nm => (probabilities[nm] ?? 0) < 0.049);
      if (finalViolation) {
        setEqualProbabilities();
      }
    }

    function saveProbabilities() {
      try {
        const cleanP = {};
        names.forEach((nm) => cleanP[nm] = probabilities[nm] ?? 0);

        const cleanLocked = {};
        names.forEach((nm) => { if (lockedParticipants[nm]) cleanLocked[nm] = true; });

        localStorage.setItem(PROB_KEY, JSON.stringify({
          probabilities: cleanP,
          hasCustomProbabilities
        }));
        localStorage.setItem(LOCKED_KEY, JSON.stringify(cleanLocked));
      } catch(_) {}
    }

    function getRealisticMaxPercent(name) {
        // –í—Å–µ –¥—Ä—É–≥–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ
        const otherLocked = names.filter(n => lockedParticipants[n] && n !== name);
        // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ (–æ–Ω –±—É–¥–µ—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ –≤–≤–æ–¥–µ)
        const willBeUnlocked = names.filter(n => !lockedParticipants[n] && n !== name);

        const otherLockedSum = otherLocked.reduce(
          (s, nm) => s + (probabilities[nm] || 0),
          0
        );

        // –ú–∏–Ω–∏–º—É–º –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö (–ø–æ 5%)
        const minUnlockedTotal = willBeUnlocked.length * 0.05;

        // –°–∫–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ –æ—Ç–¥–∞—Ç—å —Ç–µ–∫—É—â–µ–º—É, —á—Ç–æ–±—ã –æ—Å—Ç–∞–ª—å–Ω—ã–º —Ö–≤–∞—Ç–∏–ª–æ –Ω–∞ –∏—Ö 5%
        const rawMax = (1 - otherLockedSum - minUnlockedTotal) * 100;

        // –û–±—Ä–µ–∑–∞–µ–º –æ—Ç 5 –¥–æ 100, —á—Ç–æ–±—ã –Ω–µ —É—Ö–æ–¥–∏—Ç—å –≤ –±—Ä–µ–¥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        return Math.max(5, Math.min(100, rawMax));
      }


    function getProbabilityPercent(name) {
      if (!hasCustomProbabilities && names.length) return (100 / names.length).toFixed(1);
      return (((probabilities[name] || 0) * 100).toFixed(1));
    }

    function adjustProbability(name, delta) {
      const cur = parseFloat(getProbabilityPercent(name)) || 0;
      const maxPossible = 100 - (names.length - 1) * 5;
      const next = Math.max(5, Math.min(maxPossible, cur + delta));
      
      // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º/–º–∏–Ω–∏–º—É–º), –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      if (Math.abs(next - cur) < 0.01) {
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏–≤–µ–¥—ë—Ç –ª–∏ —ç—Ç–æ –∫ –Ω–∞—Ä—É—à–µ–Ω–∏—é –ø—Ä–∞–≤–∏–ª–∞ 5%
      // –¢–µ–∫—É—â–∏–π —É—á–∞—Å—Ç–Ω–∏–∫ –ë–£–î–ï–¢ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è
      const otherLocked = names.filter(n => lockedParticipants[n] && n !== name);
      const willBeUnlocked = names.filter(n => !lockedParticipants[n] && n !== name);
      const otherLockedSum = otherLocked.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
      const newProbForThis = next / 100;
      const remainForUnlocked = 1 - otherLockedSum - newProbForThis;
      const minUnlockedTotal = willBeUnlocked.length * 0.05;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å 0.001 (0.1%) –≤–º–µ—Å—Ç–æ 1e-6
      if (remainForUnlocked < minUnlockedTotal - 0.001) {
        const realisticMax = getRealisticMaxPercent(name);
        showNewNameInputError(`–ú–∏–Ω–∏–º—É–º 5.0%, –º–∞–∫—Å–∏–º—É–º ${realisticMax.toFixed(1)}%`);
        return;
      }

      
      setProbabilityManually(name, next);
      createNameInputs();
      resetNewNamePlaceholder();
    }

    function setProbabilityManually(name, percentValue) {
      const maxPossible = getRealisticMaxPercent(name);

      if (isNaN(percentValue) || percentValue < 5 || percentValue > maxPossible) {
        showNewNameInputError(`–ú–∏–Ω–∏–º—É–º 5.0%, –º–∞–∫—Å–∏–º—É–º ${maxPossible.toFixed(1)}%`);
        return false;
      }

      hasCustomProbabilities = true;

      lockedParticipants[name] = true;
      probabilities[name] = percentValue / 100;

      normalizeProbabilities();
      saveProbabilities();
      resetNewNamePlaceholder();

      return true;
    }

    function equalizeProbabilities() {
      setEqualProbabilities();
      createNameInputs();
      buildBins();
      drawBoard();
    }

    function shuffleParticipants() {
      // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–µ—Ç–æ–¥–æ–º –§–∏—à–µ—Ä–∞-–ô–µ–π—Ç—Å–∞
      for (let i = names.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [names[i], names[j]] = [names[j], names[i]];
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      saveNames();

      // –û–±–Ω–æ–≤–ª—è–µ–º UI –∏ –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
      createNameInputs();
      buildBins();
      drawBoard();
    }

    // ===== UI –ò–ú–Å–ù =====
    function createNameInputs() {
      namesList.innerHTML = '';
      names.forEach((name, idx) => {
        const row = document.createElement('div');
        row.className = 'name-item';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'name-input';
        input.value = name;
        input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
        input.maxLength = 15;
        
        input.addEventListener('keydown', (e) => {
          if (e.key === ' ') {
            e.preventDefault();
          }
          if (input.value.length >= 15 && 
              !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'].includes(e.key) &&
              !e.ctrlKey && !e.metaKey) {
            
            input.classList.add('error-state');
            input.style.borderColor = '#ef4444';
            input.style.background = 'rgba(239,68,68,0.1)';
            const originalPlaceholder = input.placeholder;
            input.placeholder = '‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤';
            
            setTimeout(() => {
              input.placeholder = originalPlaceholder;
              if (input.value.trim()) {
                input.classList.remove('error-state');
                input.style.borderColor = 'rgba(255,255,255,0.2)';
                input.style.background = 'rgba(255,255,255,0.1)';
              }
            }, 1500);
          }
        });

        input.addEventListener('input', () => {
          resetNewNamePlaceholder();
          input.value = input.value.replace(/\s+/g, '');
          const v = input.value.trim();
          
          if (!v || v.length === 0) {
            input.classList.add('error-state');
            input.style.borderColor = '#ef4444';
            input.style.background = 'rgba(239,68,68,0.1)';
            
            const oldName = names[idx];
            if (oldName in probabilities) {
              probabilities[''] = probabilities[oldName];
              delete probabilities[oldName];
            }
            if (oldName in lockedParticipants) {
              lockedParticipants[''] = true;
              delete lockedParticipants[oldName];
            }
            names[idx] = '';
            saveNames();
            saveProbabilities();
            buildBins();
            drawBoard();
            
            validateAllNames();
            return;
          }
          
          const dup = names.some((n, i) => i !== idx && n.toLowerCase() === v.toLowerCase());
          if (dup) {
            input.classList.add('error-state');
            input.style.borderColor = '#ef4444';
            input.style.background = 'rgba(239,68,68,0.1)';
          } else {
            input.classList.remove('error-state');
            input.style.borderColor = 'rgba(255,255,255,0.2)';
            input.style.background = 'rgba(255,255,255,0.1)';
          }
          
          if (dup) {
            validateAllNames();
            return;
          }

          const oldName = names[idx];

          if (v === oldName) {
            validateAllNames();
            return;
          }

          if (oldName in probabilities) {
            probabilities[v] = probabilities[oldName];
            delete probabilities[oldName];
          }
          if (oldName in lockedParticipants) {
            lockedParticipants[v] = true;
            delete lockedParticipants[oldName];
          }

          names[idx] = v;
          saveNames();
          saveProbabilities();
          buildBins();
          drawBoard();
          validateAllNames();

        });

        input.addEventListener('blur', () => {
          const v = input.value.trim();
          
          if (!v || v.length === 0) {
            input.value = '';
            input.classList.add('error-state');
            input.style.borderColor = '#ef4444';
            input.style.background = 'rgba(239,68,68,0.1)';
            input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
            validateAllNames();
            return;
          }
          
          const dup = names.some((n, i) => i !== idx && n.toLowerCase() === v.toLowerCase());
          if (dup) {
            input.value = names[idx];
            input.classList.remove('error-state');
            input.style.borderColor = 'rgba(255,255,255,0.2)';
            input.style.background = 'rgba(255,255,255,0.1)';
            input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
          } else {
            input.classList.remove('error-state');
            input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
          }
          validateAllNames();
        });

        input.addEventListener('focus', () => {
          if (input.placeholder === '–í–≤–µ–¥–∏—Ç–µ –∏–º—è') {
            input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
          }
          if (input.value.trim()) {
            input.classList.remove('error-state');
          }
        });

        const probControls = document.createElement('div');
        probControls.className = 'probability-controls';

        const decreaseBtn = document.createElement('button');
        decreaseBtn.className = 'prob-btn';
        decreaseBtn.textContent = '‚àí';
        decreaseBtn.setAttribute('aria-label', '–£–º–µ–Ω—å—à–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å');
        decreaseBtn.onclick = () => {
          adjustProbability(name, -1);
          buildBins();
          drawBoard();
        };

        const probInput = document.createElement('input');
        probInput.type = 'text';
        probInput.inputMode = 'decimal';
        probInput.className = 'probability-input';
        probInput.value = getProbabilityPercent(name);
        probInput.setAttribute('aria-label', '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö');
        if (lockedParticipants[name]) {
          probInput.classList.add('manual');
        }
        let lastValid = probInput.value;

        probInput.addEventListener('focus', () => {
          probInput.value = probInput.value.replace('%', '');
          lastValid = probInput.value;
        });

        probInput.addEventListener('input', () => {
          const val = probInput.value.replace('%', '').trim();
          const num = parseFloat(val);
          const maxAllowed = getRealisticMaxPercent(name);

          if (val === '' || (num >= 5 && num <= maxAllowed)) {
            probInput.classList.remove('error');
          } else {
            probInput.classList.add('error');
          }
        });


        probInput.addEventListener('blur', () => {
          const val = probInput.value.replace('%', '').trim();
          const num = parseFloat(val);
          const maxAllowed = getRealisticMaxPercent(name);

          if (val === '' || isNaN(num) || num < 5 || num > maxAllowed) {
            probInput.value = lastValid;
            probInput.classList.remove('error');
            playSound(300, 0.1, 0.2);

            if (!isNaN(num) && (num < 5 || num > maxAllowed)) {
              showNewNameInputError(`–ú–∏–Ω–∏–º—É–º 5.0%, –º–∞–∫—Å–∏–º—É–º ${maxAllowed.toFixed(1)}%`);
            }
          } else {
            const otherLocked = names.filter(n => lockedParticipants[n] && n !== name);
            const willBeUnlocked = names.filter(n => !lockedParticipants[n] && n !== name);
            const otherLockedSum = otherLocked.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
            const newProbForThis = num / 100;
            const remainForUnlocked = 1 - otherLockedSum - newProbForThis;
            const minUnlockedTotal = willBeUnlocked.length * 0.05;

            if (remainForUnlocked < minUnlockedTotal - 0.001) {
              probInput.value = lastValid;
              probInput.classList.remove('error');

              const realisticMax = getRealisticMaxPercent(name);
              showNewNameInputError(`–ú–∏–Ω–∏–º—É–º 5.0%, –º–∞–∫—Å–∏–º—É–º ${realisticMax.toFixed(1)}%`);
            } else if (setProbabilityManually(name, num)) {
              lastValid = getProbabilityPercent(name);
              createNameInputs();
              buildBins();
              drawBoard();
            } else {
              probInput.value = lastValid;
              probInput.classList.remove('error');
            }
          }
        });


        probInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') { 
            e.preventDefault(); 
            probInput.blur(); 
          }
          if (!/[\d.]/.test(e.key) && e.key !== 'Enter') e.preventDefault();
        });

        const increaseBtn = document.createElement('button');
        increaseBtn.className = 'prob-btn';
        increaseBtn.textContent = '+';
        increaseBtn.setAttribute('aria-label', '–£–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å');
        increaseBtn.onclick = () => {
          adjustProbability(name, 1);
          buildBins();
          drawBoard();
        };

        probControls.appendChild(decreaseBtn);
        probControls.appendChild(probInput);
        probControls.appendChild(increaseBtn);

        const btn = document.createElement('button');
        btn.className = 'remove-btn';
        btn.textContent = '‚úï';
        btn.setAttribute('aria-label', '–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞');
        btn.onclick = () => {
          if (names.length <= 2) {
            newNameInput.style.borderColor = '#ef4444';
            newNameInput.style.background = 'rgba(239,68,68,0.1)';
            newNameInput.placeholder = '–ú–∏–Ω–∏–º—É–º 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞';
            
            setTimeout(() => {
              newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
              if (!newNameInput.value.trim()) {
                newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
                newNameInput.style.background = 'rgba(255,255,255,0.1)';
              }
            }, 2000);
            return;
          }
          const removedName = names[idx];
          names.splice(idx, 1);
          delete probabilities[removedName];
          delete lockedParticipants[removedName];

          saveNames();
          normalizeProbabilities();
          saveProbabilities();

          createNameInputs();
          buildBins();
          drawBoard();
        };

        row.appendChild(input);
        row.appendChild(probControls);
        row.appendChild(btn);
        namesList.appendChild(row);
      });
      
      validateAllNames();
    }

    function addNewParticipant() {
      const v = newNameInput.value.trim();
      
      if (names.length >= 20) {
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
        newNameInput.placeholder = '–ú–∞–∫—Å–∏–º—É–º 20 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤';
        newNameInput.value = '';
        
        setTimeout(() => {
          newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
          newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
          newNameInput.style.background = 'rgba(255,255,255,0.1)';
        }, 2000);
        return;
      }
      
      if (!v || v.length === 0) {
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
        newNameInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª';
        
        setTimeout(() => {
          newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
          if (!newNameInput.value.trim()) {
            newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
            newNameInput.style.background = 'rgba(255,255,255,0.1)';
          }
        }, 2000);
        return;
      }

      const dup = names.some((n) => n.toLowerCase() === v.toLowerCase());
      if (dup) {
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
        newNameInput.placeholder = '–¢–∞–∫–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å';
        newNameInput.value = '';
        
        setTimeout(() => {
          newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
          newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
          newNameInput.style.background = 'rgba(255,255,255,0.1)';
        }, 2000);
        return;
      }

      newNameInput.value = '';
      newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
      newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
      newNameInput.style.background = 'rgba(255,255,255,0.1)';

      names.push(v);
      saveNames();

      // –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –≤—Å–µ–≥–¥–∞ –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –∏ –ø–æ–ª—É—á–∞–µ—Ç –¥–æ–ª—é –æ—Ç –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
      if (!hasCustomProbabilities) {
        // –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
        const equal = 1 / names.length;
        names.forEach(nm => probabilities[nm] = equal);
      } else {
        // –î–∞—ë–º –Ω–æ–≤–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É –≤—Ä–µ–º–µ–Ω–Ω—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å (–±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞ –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏)
        probabilities[v] = 0.05;
      }
      
      normalizeProbabilities();
      saveProbabilities();

      createNameInputs();
      buildBins();
      drawBoard();
      resetNewNamePlaceholder();
    }

    newNameInput.addEventListener('input', () => {
      resetNewNamePlaceholder();
      const v = newNameInput.value.trim();
      
      if (!v || v.length === 0) {
        newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
        newNameInput.style.background = 'rgba(255,255,255,0.1)';
        return;
      }
      
      const dup = names.some((n) => n.toLowerCase() === v.toLowerCase());
      if (dup) {
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
      } else {
        newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
        newNameInput.style.background = 'rgba(255,255,255,0.1)';
      }
    });

    addNameBtn.addEventListener('click', addNewParticipant);
    newNameInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') addNewParticipant();
    });
    equalizeBtn.addEventListener('click', equalizeProbabilities);
    shuffleBtn.addEventListener('click', shuffleParticipants);

    // ===== –ü–†–ê–ó–î–ù–û–í–ê–ù–ò–Ø =====
    function createCelebrationEmojis() {
      const emojis = ['üéâ', 'üéä', 'üèÜ', '‚≠ê', '‚ú®', 'üéØ', 'üî•', 'üí´', 'üåü', 'üëè', 'üôå', 'üéà', 'üéÜ', 'üí•'];
      const count = isMobile ? 12 : 20;

      for (let i = 0; i < count; i++) {
        setTimeout(() => {
          const emoji = document.createElement('div');
          emoji.className = 'celebration-emoji';
          emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
          emoji.style.left = (Math.random() * 100) + '%';
          emoji.style.top = (Math.random() * 100) + '%';
          emoji.style.animationDelay = (Math.random() * 0.5) + 's';
          document.body.appendChild(emoji);
          setTimeout(() => emoji.remove(), 3500);
        }, i * 100);
      }
    }

    function createCelebrationWords() {
      const words = [
        '–í–ê–£', '–ß–ï–ú–ü–ò–û–ù', '–ú–û–õ–û–î–ï–¶', '–ö–†–ê–°–ê–í–ê', '–õ–ï–ì–ï–ù–î–ê', '–í–ü–ï–†–Å–î', '–¢–û–ü–ß–ò–ö', '–ü–û–ë–ï–î–ê',
        '–û–ì–û–ù–¨', '–¢–´ –õ–£–ß–®–ò–ô', '–î–ê–í–ê–ô –ï–©–Å', '–ù–ï–í–ï–†–û–Ø–¢–ù–û', '–°–£–ü–ï–†',
        '–ù–ê–î–û –ñ–ï –ö–¢–û –í–´–ü–ê–õ', '–ö–†–ê–°–ê–í–ß–ò–ö', '–ú–ê–°–¢–ï–†', '–ì–ï–ù–ò–ô', '–ë–û–°–°', '–ö–¢–û –ë–´ –ú–û–ì –ü–û–î–£–ú–ê–¢–¨',
        '–≠–ü–ò–ß–ù–û', '–ë–†–ê–í–û', '–ì–ì', '–†–ï–°–ü–ï–ö–¢', '–®–ò–ö–ê–†–ù–û', '–ò–ú–ë–ê', '–ö–†–£–¢–Ø–ö', '–ú–û–©–ù–û'
      ];

      const gridCols = isMobile ? 3 : 4;
      const gridRows = isMobile ? 4 : 3;
      const positions = [];

      for (let row = 0; row < gridRows; row++) {
        for (let col = 0; col < gridCols; col++) {
          positions.push({
            left: (col * (100 / gridCols)) + (100 / gridCols / 2),
            top: (row * (100 / gridRows)) + (100 / gridRows / 2)
          });
        }
      }

      positions.sort(() => Math.random() - 0.5);

      const wordsToShow = isMobile ? 8 : 12;

      for (let i = 0; i < wordsToShow; i++) {
        setTimeout(() => {
          const word = document.createElement('div');
          word.className = 'celebration-word';
          word.textContent = words[Math.floor(Math.random() * words.length)];

          const pos = positions[i % positions.length];
          word.style.left = (pos.left + (Math.random() - 0.5) * 10) + '%';
          word.style.top = (pos.top + (Math.random() - 0.5) * 10) + '%';
          word.style.animationDelay = (Math.random() * 0.3) + 's';

          document.body.appendChild(word);
          setTimeout(() => word.remove(), 4500);
        }, i * 120);
      }
    }

    function createConfetti() {
      const cs = ['#ff6b6b','#ffd43b','#51cf66','#339af0','#da77f2','#66d9e8','#fb923c','#ec4899'];
      const count = isMobile ? 50 : 100;

      for (let i = 0; i < count; i++) {
        setTimeout(() => {
          const d = document.createElement('div');
          d.className = 'confetti';
          d.style.left = (Math.random() * 100) + '%';
          d.style.top = '0';
          d.style.background = cs[Math.floor(Math.random() * cs.length)];
          d.style.width = (5 + Math.random() * 10) + 'px';
          d.style.height = (5 + Math.random() * 10) + 'px';
          d.style.animationDelay = (Math.random() * 0.5) + 's';
          d.style.animationDuration = (2 + Math.random() * 2) + 's';
          document.body.appendChild(d);
          setTimeout(() => d.remove(), 4000);
        }, i * 25);
      }
    }

    // ===== –ü–õ–ò–ù–ö–û: –ì–ï–û–ú–ï–¢–†–ò–Ø =====
    let DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    let W = 0, H = 0;

    let rows = isMobile ? 6 : 12;
    let pegs = [];
    let bins = [];

    function resize() {
      const parent = canvas.parentElement;
      const cssW = parent.clientWidth;
      const cssH = parent.clientHeight;
      DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));

      canvas.style.width = cssW + 'px';
      canvas.style.height = cssH + 'px';
      canvas.width = Math.round(cssW * DPR);
      canvas.height = Math.round(cssH * DPR);

      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.scale(DPR, DPR);

      W = cssW;
      H = cssH;
      
      if (isMobile && H < 450) {
        rows = 6;
      } else if (isMobile) {
        rows = 8;
      } else {
        rows = 12;
      }
      
      layoutPegs();
      buildBins();
      drawBoard();
    }

    function layoutPegs() {
      pegs = [];
      
      const topPad = isMobile ? 30 : 40;
      const bottomPad = isMobile ? 100 : 80;
      const sidePad = isMobile ? 15 : 25;
      
      const usableH = H - topPad - bottomPad;
      const rowGap = usableH / rows;
      
      for (let r = 0; r < rows; r++) {
        const cols = isMobile ? 8 : 16;
        const usableW = W - sidePad * 2;
        const step = usableW / (cols - 1);
        const y = topPad + r * rowGap;
        
        if (r % 2 === 0) {
          for (let c = 0; c < cols; c++) {
            const x = sidePad + step * c;
            pegs.push({ x: x, y: y });
          }
        } else {
          pegs.push({ x: sidePad - step * 0.5, y: y });
          
          for (let c2 = 0; c2 < cols - 1; c2++) {
            const x2 = sidePad + step * (c2 + 0.5);
            pegs.push({ x: x2, y: y });
          }
          
          pegs.push({ x: sidePad + usableW + step * 0.5, y: y });
        }
      }
    }

    function buildBins() {
      bins = [];
      
      const xStart = isMobile ? 12 : 20;
      const xEnd = W - (isMobile ? 12 : 20);
      const span = xEnd - xStart;
      
      const yHeight = isMobile ? 70 : 65;
      const y0 = H - yHeight - (isMobile ? 10 : 20);
      const y1 = H - (isMobile ? 10 : 20);
      
      let acc = 0;
      
      names.forEach((n, i) => {
        const w = Math.max(2, (probabilities[n] || 0) * span);
        const x0 = xStart + acc;
        const x1 = Math.min(xStart + span, x0 + w);
        acc += w;
        bins.push({
          name: n,
          x0: x0, x1: x1, y0: y0, y1: y1,
          color: colors[i % colors.length]
        });
      });
    }

    function drawBoard() {
      ctx.clearRect(0, 0, W, H);
      
      const gradient = ctx.createLinearGradient(0, 0, 0, H);
      gradient.addColorStop(0, 'rgba(102,126,234,0.08)');
      gradient.addColorStop(1, 'rgba(118,75,162,0.12)');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, W, H);
      
      const pegRadius = isMobile ? 3 : 3.5;
      
      ctx.shadowColor = 'rgba(0,0,0,0.3)';
      ctx.shadowBlur = 4;
      ctx.fillStyle = 'rgba(255,255,255,0.95)';
      pegs.forEach((p) => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, pegRadius, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.shadowBlur = 0;
      
      bins.forEach((b, idx) => {
        const binGrad = ctx.createLinearGradient(b.x0, b.y0, b.x0, b.y1);
        binGrad.addColorStop(0, b.color + '40');
        binGrad.addColorStop(1, b.color + '60');
        ctx.fillStyle = binGrad;
        ctx.fillRect(b.x0, b.y0, b.x1 - b.x0, b.y1 - b.y0);
        
        if (idx < bins.length - 1) {
          ctx.strokeStyle = 'rgba(255,255,255,0.4)';
          ctx.lineWidth = 2.5;
          ctx.beginPath();
          ctx.moveTo(b.x1, b.y0);
          ctx.lineTo(b.x1, b.y1);
          ctx.stroke();
        }
        
        const fontSize = isMobile ? 11 : 13;
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold ' + fontSize + 'px Montserrat, sans-serif';
        ctx.textAlign = 'center';
        ctx.shadowColor = 'rgba(0,0,0,0.5)';
        ctx.shadowBlur = 3;

        const text = b.name;
        ctx.fillText(text, (b.x0 + b.x1) / 2, b.y1 - (isMobile ? 8 : 10));
        ctx.shadowBlur = 0;
      });
    }

    // ===== –§–ò–ó–ò–ö–ê =====
    let ball = null;
    let winnerLocked = null;

    const GRAV = isMobile ? 0.03 : 0.1;
    const PEG_R = isMobile ? 3 : 3.5;
    const BALL_R = isMobile ? 7 : 10;
    const REST = isMobile ? 0.6 : 0.5;
    const WALL_REST = isMobile ? 0.5 : 0.48;
    const FRICTION = isMobile ? 0.998 : 0.9985;

    function dropBall() {
      if (animId) return;
      winnerAnnouncement.classList.remove('show');
      winnerLocked = null;
      
      const centerX = W / 2;
      
      ball = {
        x: centerX,
        y: -BALL_R - (isMobile ? 60 : 80),
        vx: (Math.random() - 0.5) * (isMobile ? 1 : 0.8),
        vy: (isMobile ? 3 : 2.5) + Math.random() * 0.5
      };
      
      playTickSound();
      
      setUILocked(true);
      
      frame();
    }

    function collideWithPeg(p) {
      const dx = ball.x - p.x;
      const dy = ball.y - p.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      const minDist = PEG_R + BALL_R;
      
      if (dist < minDist) {
        const nx = dx / (dist || 1);
        const ny = dy / (dist || 1);
        const overlap = minDist - dist;
        
        ball.x += nx * overlap;
        ball.y += ny * overlap;
        
        const vDotN = ball.vx * nx + ball.vy * ny;
        const vnX = vDotN * nx;
        const vnY = vDotN * ny;
        const vtX = ball.vx - vnX;
        const vtY = ball.vy - vnY;
        
        ball.vx = vtX - vnX * REST;
        ball.vy = vtY - vnY * REST;
        ball.vx *= 0.99;
        ball.vy *= 0.99;
        
        playTickSound();
      }
    }

    function collideInsideBins() {
      if (!bins.length) return;
      
      const topY = bins[0].y0;
      const bottomY = bins[0].y1;
      
      if (ball.y + BALL_R < topY) return;
      
      for (let i = 0; i < bins.length - 1; i++) {
        const sepX = bins[i].x1;
        if (ball.y - BALL_R < bottomY && Math.abs(ball.x - sepX) < BALL_R) {
          const sign = ball.x - sepX >= 0 ? 1 : -1;
          ball.x = sepX + sign * BALL_R;
          ball.vx = -sign * Math.abs(ball.vx) * WALL_REST;
        }
      }
      
      let b = null;
      for (let j = 0; j < bins.length; j++) {
        if (ball.x >= bins[j].x0 && ball.x <= bins[j].x1) {
          b = bins[j];
          break;
        }
      }
      if (!b) return;
      
      const left = b.x0 + BALL_R;
      const right = b.x1 - BALL_R;
      const floor = bottomY - BALL_R;
      
      if (ball.x < left) {
        ball.x = left;
        ball.vx = Math.abs(ball.vx) * WALL_REST;
      }
      if (ball.x > right) {
        ball.x = right;
        ball.vx = -Math.abs(ball.vx) * WALL_REST;
      }
      if (ball.y > floor) {
        if (!winnerLocked) {
          winnerLocked = b.name;
          revealWinner(b.name);
        }

        ball.y = floor;
        ball.vy = -Math.abs(ball.vy) * WALL_REST;
      }
    }

    function physicsStep() {
      ball.vy += GRAV;
      ball.x += ball.vx;
      ball.y += ball.vy;
      ball.vx *= FRICTION;
      ball.vy *= FRICTION;
      
      const sideMargin = isMobile ? 12 : 20;
      
      if (ball.x < BALL_R + sideMargin) {
        ball.x = BALL_R + sideMargin;
        ball.vx = Math.abs(ball.vx) * WALL_REST;
      }
      if (ball.x > W - BALL_R - sideMargin) {
        ball.x = W - BALL_R - sideMargin;
        ball.vx = -Math.abs(ball.vx) * WALL_REST;
      }
      
      pegs.forEach(collideWithPeg);
      collideInsideBins();
      
      const topY = bins.length ? bins[0].y0 : (H - 85);
      if (ball.y > topY - BALL_R && Math.abs(ball.vx) < 0.02) {
        ball.vx += (Math.random() - 0.5) * 0.08;
      }
    }

    function isBallStopped() {
      const bottomY = bins.length ? bins[0].y1 : (H - 20);
      return (
        Math.abs(ball.vx) < 0.08 &&
        Math.abs(ball.vy) < 0.1 &&
        ball.y >= bottomY - BALL_R - 0.8
      );
    }

    function frame() {
      animId = requestAnimationFrame(frame);
      physicsStep();
      
      drawBoard();
      
      const ballGrad = ctx.createRadialGradient(
        ball.x - 3, ball.y - 3, 1,
        ball.x, ball.y, BALL_R
      );
      ballGrad.addColorStop(0, '#ffffff');
      ballGrad.addColorStop(0.7, '#f0f0f0');
      ballGrad.addColorStop(1, '#d0d0d0');
      
      ctx.shadowColor = 'rgba(0,0,0,0.4)';
      ctx.shadowBlur = 8;
      ctx.fillStyle = ballGrad;
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, BALL_R, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.shadowBlur = 0;
      ctx.strokeStyle = 'rgba(0,0,0,0.3)';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      if (isBallStopped()) {
        cancelAnimationFrame(animId);
        animId = null;
        finalizeWinner();
      }
    }

    function finalizeWinner() {
      if (winnerLocked) return;
      const x = ball.x;
      let winner = null;
      for (let i = 0; i < bins.length; i++) {
        if (x >= bins[i].x0 && x <= bins[i].x1) {
          winner = bins[i];
          break;
        }
      }
      if (!winner && bins.length) winner = bins[bins.length - 1];
      if (!winner && bins.length) winner = bins[0];
      if (!winner) return;
      revealWinner(winner.name);
    }

    function revealWinner(name) {
      playFanfare();
      createConfetti();
      createCelebrationEmojis();
      createCelebrationWords();
      
      winnerText.innerHTML = `
        <span class="winner-emoji">üéâ</span>
        <span class="winner-name">${name}</span>
        <span class="winner-emoji">üéâ</span>
      `;
      winnerAnnouncement.classList.add('show');
      
      setTimeout(() => {
        winnerAnnouncement.classList.remove('show');
        setUILocked(false);
      }, 3500);
    }

    dropBtn.addEventListener('click', dropBall);

    // ===== RESIZE =====
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(resize, 250);
    });

    // ===== –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ê –ê–£–î–ò–û =====
    (function() {
      let unlocked = false;
      function unlock() {
        try {
          if (audioCtx.state === 'suspended') {
            audioCtx.resume();
          }
        } catch(e) {}
        if (!unlocked) {
          unlocked = true;
          window.removeEventListener('touchstart', unlock, {passive: true});
          window.removeEventListener('pointerdown', unlock, {passive: true});
          window.removeEventListener('click', unlock, {passive: true});
        }
      }
      window.addEventListener('touchstart', unlock, {passive: true});
      window.addEventListener('pointerdown', unlock, {passive: true});
      window.addEventListener('click', unlock, {passive: true});
    })();

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
    function init() {
      initProbabilities();
      createNameInputs();
      resize();
    }

    init();
  </script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "–ü–ª–∏–Ω–∫–æ –ñ–µ—Ä–µ–±—å—ë–≤–∫–∞",
    "applicationCategory": "GameApplication",
    "operatingSystem": "Web",
    "url": "https://randomhost.online/plinko.html",
    "description": "–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –æ–Ω–ª–∞–π–Ω-–∏–≥—Ä–∞ —Å —Ñ–∏–∑–∏–∫–æ–π –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.",
    "inLanguage": "ru",
    "publisher": {
      "@type": "Organization",
      "name": "–†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä-–∏–≥—Ä—ã",
      "url": "https://randomhost.online"
    }
  }
  </script>

  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){
      m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      for (var j = 0; j < document.scripts.length; j++) {
        if (document.scripts[j].src === r) { return; }
      }
      k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js','ym');
    ym(104849796, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/104849796" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  <!-- /Yandex.Metrika counter -->
</body>
</html>
