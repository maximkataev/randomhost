<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ì–æ–Ω–∫–∏</title>

  <!-- Favicon -->
<link rel="icon" href="https://em-content.zobj.net/source/apple/391/racing-car_1f3ce-fe0f.png" type="image/png">
  <!-- Meta -->
  <meta name="title" content="üèéÔ∏è –û–Ω–ª–∞–π–Ω –ì–æ–Ω–∫–∏ ‚Äî –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –£–¥–∞—á–∏ –∏ –°–∫–æ—Ä–æ—Å—Ç–∏">
  <meta name="description" content="üö¶ –û–Ω–ª–∞–π–Ω –≥–æ–Ω–∫–∏: –≤—ã–±–∏—Ä–∞–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∑–∞–¥–∞–≤–∞–π —à–∞–Ω—Å—ã –∏ —É—Å—Ç—Ä–∞–∏–≤–∞–π —ç–ø–∏—á–Ω—ã–µ –∑–∞–µ–∑–¥—ã! –ö—Ç–æ –ø–µ—Ä–≤—ã–º –ø–µ—Ä–µ—Å–µ—á—ë—Ç —Ñ–∏–Ω–∏—à–Ω—É—é —á–µ—Ä—Ç—É? –ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ—é —É–¥–∞—á—É!">
  <meta name="keywords" content="–≥–æ–Ω–∫–∏, –æ–Ω–ª–∞–π–Ω –∏–≥—Ä–∞, –≥–æ–Ω–∫–∞, —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä, —Å–∏–º—É–ª—è—Ç–æ—Ä –≥–æ–Ω–æ–∫, wheel of fortune, random race, —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ, —É–¥–∞—á–∞, —Ä–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä, –∏–≥—Ä–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã, –∫–æ–º–∞–Ω–¥–Ω–∞—è –∏–≥—Ä–∞">
  <meta name="author" content="RandomHost Games">
  <meta name="robots" content="index, follow">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://your-domain.com/race.html">
  <meta property="og:title" content="üèéÔ∏è –û–Ω–ª–∞–π–Ω –ì–æ–Ω–∫–∏ ‚Äî –ö—Ç–æ –ø–æ–±–µ–¥–∏—Ç —Å–µ–≥–æ–¥–Ω—è?">
  <meta property="og:description" content="–í—ã–±–∏—Ä–∞–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∑–∞–¥–∞–≤–∞–π —à–∞–Ω—Å—ã –∏ —Å–º–æ—Ç—Ä–∏, –∫—Ç–æ –≤—ã—Ä–≤–µ—Ç—Å—è –≤–ø–µ—Ä—ë–¥ –Ω–∞ —Ñ–∏–Ω–∏—à–Ω–æ–π –ø—Ä—è–º–æ–π!">
  <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/146/146803.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="üèéÔ∏è –û–Ω–ª–∞–π–Ω –ì–æ–Ω–∫–∏ ‚Äî –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –£–¥–∞—á–∏">
  <meta name="twitter:description" content="–ù–∞—Å—Ç–æ—è—â–∏–µ –≥–æ–Ω–∫–∏ —É–¥–∞—á–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ!">
  <meta name="twitter:image" content="https://cdn-icons-png.flaticon.com/512/146/146803.png">

  <!-- One font only -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* unified palette (indigo) */
      --primary: #4F46E5;       /* indigo-600 */
      --primary-500:#6366F1;    /* indigo-500 */
      --primary-700:#4338CA;    /* indigo-700 */
      --primary-200:#C7D2FE;    /* indigo-200 */
      --primary-100:#E0E7FF;    /* indigo-100 */
      --ink:#1F2937;            /* slate-800 */
      --muted:#94A3B8;          /* slate-400 */
      --card:#FFFFFF;
      --surface: rgba(255,255,255,0.96);
      --border: rgba(79,70,229,0.28);
      --shadow: 0 10px 40px rgba(2,6,23,0.18);
      --danger:#EF4444;
      --finish:#0F172A;
    }

    *{margin:0;padding:0;box-sizing:border-box}

    body{
      display:flex;align-items:center;justify-content:center;
      min-height:100vh;padding:32px;
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(1200px 700px at 85% 90%, rgba(67,56,202,.18), transparent 60%),
        linear-gradient(145deg, var(--primary-100) 0%, #EEF2FF 60%, #F8FAFC 100%);
      background-attachment: fixed;
      font-family:'Montserrat',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
      color:var(--ink);
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
      overflow-x:hidden;
    }

    .main-container{
      display:flex;
      flex-direction:column;
      gap:30px;
      align-items:center;
      max-width:1400px;
      width:100%;
      position:relative;
      z-index:1;
      min-height:calc(100vh - 64px);
      margin-top:20px;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π - –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–π –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
    .animations-layer{
      position:fixed;
      top:0;
      left:0;
      width:100vw;
      height:100vh;
      pointer-events:none;
      z-index:999;
      overflow:hidden;
    }

    .top-section{display:flex;gap:30px;width:100%;align-items:flex-start;flex-wrap:wrap;}

    .settings-panel{
      width:470px;padding:24px;border-radius:20px;
      background:var(--surface);border:2px solid var(--border);box-shadow:var(--shadow);overflow:hidden
    }

    .equalize-btn{
      padding:10px 18px;border:none;border-radius:12px;cursor:pointer;
      background:linear-gradient(135deg,var(--primary) 0%, var(--primary-700) 100%);
      color:#fff;font-size:14px;font-weight:800;letter-spacing:.3px;
      box-shadow:0 8px 20px rgba(79,70,229,.28);transition:.25s
    }
    .equalize-btn:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(79,70,229,.36)}

    .names-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:20px;
      max-height:400px;
      overflow-y:auto;
      scrollbar-width:thin;
      scrollbar-color:var(--primary-200) transparent
    }
    .name-item{display:flex;gap:12px;align-items:center}
    .name-input{
      flex:1;padding:10px 14px;border:2px solid var(--border);border-radius:12px;
      background:#fff;color:var(--ink);font-size:16px;font-weight:700;transition:.2s
    }
    .name-input:focus{outline:none;border-color:var(--primary-500);box-shadow:0 0 0 4px rgba(99,102,241,0.14)}
    .name-input::placeholder{color:var(--muted)}

    .remove-btn{
      padding:6px 9px;border:none;border-radius:10px;cursor:pointer;
      background:#0F172A;color:#fff;font-size:18px;font-weight:800;transition:.2s;flex-shrink:0
    }
    .remove-btn:hover{transform:translateY(-1px);opacity:.9}

    .add-name-container{display:flex;gap:10px;margin-top:15px}
    .add-btn-small{
      padding:10px 15px;border:none;border-radius:12px;cursor:pointer;
        background: linear-gradient(135deg, #7c83f5 0%, #6b6ff3 100%);
      color:#fff;font-size:18px;font-weight:800;transition:.2s
    }
    .add-btn-small:hover{transform:translateY(-1px)}

    h1{
      color:#0B1020;font-weight:800;font-size:56px;letter-spacing:2px;
      text-shadow:0 1px 0 #fff, 0 10px 30px rgba(67,56,202,.25);
      text-align: center;
      width: 100%;
    }

    .top-buttons{position:fixed;top:20px;left:20px;display:flex;gap:12px;z-index:1000}
    .top-btn{
      background:#fff;color:var(--primary);text-decoration:none;padding:10px 18px;border-radius:12px;
      font-weight:800;box-shadow:var(--shadow);border:2px solid var(--border);transition:.2s
    }
    .top-btn:hover{transform:translateY(-2px)}

    /* Track */
.race-container{
  flex:1;
  display:flex;
  gap:20px;
  align-items:stretch;
  background:var(--surface);
  border-radius:20px;
  padding:28px;
  border:2px solid var(--border);
  box-shadow:var(--shadow);
  position:relative;
  z-index:1;
}

    .racers-names{display:flex;flex-direction:column;gap:0;min-width:100px;flex-shrink:0}
    .racer-name-label{
      height:50px;display:flex;align-items:center;justify-content:flex-end;
      padding-right:16px;font-size:16px;font-weight:800;color:var(--ink);
      border-bottom:2px dashed #CBD5E1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    .racer-name-label:first-child{border-top:2px dashed #CBD5E1}

    .race-track{position:relative;flex:1}

    .start-line{
      position:absolute;left:70px;top:0;bottom:0;width:4px;
      background:repeating-linear-gradient(0deg,var(--primary),var(--primary) 10px,#fff 10px,#fff 20px);
      z-index:1
    }
    .finish-line{
      position:absolute;right:60px;top:0;bottom:0;width:8px;
      background:repeating-linear-gradient(45deg,var(--finish),var(--finish) 10px,#fff 10px,#fff 20px);
      box-shadow:0 0 20px rgba(15,23,42,.18);z-index:1
    }

    .lane{
      position:relative;height:50px;border-top:2px dashed #CBD5E1;display:flex;align-items:center
    }
    .lane:last-child{border-bottom:2px dashed #CBD5E1}

    .car{
      position:absolute;left:30px;font-size:35px;transform:scaleX(-1);
      filter:drop-shadow(2px 2px 4px rgba(0,0,0,.18));
      transition:left .05s linear, font-size .25s ease;z-index:2;
      cursor: pointer;
    }
    .car.pick {
  animation: pickPulse .25s ease;
}
@keyframes pickPulse {
  0%   { transform: scaleX(-1) scale(1);   }
  50%  { transform: scaleX(-1) scale(1.12);}
  100% { transform: scaleX(-1) scale(1);   }
}
    .car.winner{animation:carBounce .5s ease-in-out infinite;font-size:50px!important;z-index:10}
    @keyframes carBounce{0%,100%{transform:scaleX(-1) translateY(0) scale(1)}50%{transform:scaleX(-1) translateY(-10px) scale(1.08)}}

    .headers-row{display:flex;align-items:center;gap:0;margin-bottom:10px;padding:0 5px}
    .header-name,.header-probability{color:var(--ink);font-size:14px;font-weight:700}
    .header-name{flex:1}
    .header-probability{width:120px;flex-shrink:0;text-align:center}
    .header-remove{width:48px;flex-shrink:0}

    .probability-controls{display:flex;gap:6px;width:120px;flex-shrink:0}
    .prob-btn{
      padding:6px 9px;border:none;border-radius:8px;cursor:pointer;
      background:rgba(79,70,229,.12);color:var(--ink);font-weight:800;transition:.2s
    }
    .prob-btn:hover{background:rgba(79,70,229,.18);transform:translateY(-1px)}

    .probability-input{
      width:58px;padding:6px;border:2px solid var(--border);border-radius:8px;
      background:#fff;color:var(--primary);text-align:center;font-weight:800;transition:.2s
    }
    .probability-input:focus{outline:none;border-color:var(--primary-500);box-shadow:0 0 0 4px rgba(99,102,241,.14)}
    .probability-input.error{border-color:var(--danger);background:rgba(239,68,68,.08)}

   .controls{
  display:flex;
  gap:20px;
  justify-content:center;
  margin-top:0;
  width:100%;
  position:relative;
  z-index:1;
}
    .race-btn{
      padding:18px 40px;border:none;border-radius:999px;cursor:pointer;
      background:linear-gradient(135deg,var(--primary) 0%, var(--primary-700) 100%);
      color:#fff;font-weight:900;letter-spacing:2px;font-family:'Montserrat';box-shadow:0 10px 30px rgba(79,70,229,.35);
      transition:.25s
    }
    .race-btn:hover{transform:translateY(-3px);box-shadow:0 14px 34px rgba(79,70,229,.42)}
    .race-btn:disabled{opacity:.6;cursor:not-allowed}

    .result{
      margin-top:30px;padding:36px 56px;border-radius:24px;background:var(--surface);
      border:2px solid var(--border);box-shadow:var(--shadow);min-height:120px;display:none;align-items:center;justify-content:center;visibility:hidden;
      position:relative;
      z-index:1;
    }
    .result-text{
      font-size:40px;font-weight:900;letter-spacing:3px;
      background:linear-gradient(135deg,var(--primary) 0%, var(--primary-700) 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
      filter:drop-shadow(2px 2px 4px rgba(0,0,0,.08));opacity:0;animation:fadeInScale .8s forwards
    }
    @keyframes fadeInScale{from{opacity:0;transform:scale(.5)}to{opacity:1;transform:scale(1)}}

    /* –í–°–ï –ê–ù–ò–ú–ê–¶–ò–ò –¢–ï–ü–ï–†–¨ –í–ù–£–¢–†–ò animations-layer */
    .confetti{
      position:absolute;
      width:12px;
      height:12px;
      pointer-events:none;
      animation:confetti-fall 3s ease-out forwards
    }
    @keyframes confetti-fall{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}

    @keyframes screenShake{0%,100%{transform:translate(0,0)}10%{transform:translate(-5px,3px)}20%{transform:translate(5px,-3px)}30%{transform:translate(-4px,4px)}40%{transform:translate(4px,-4px)}50%{transform:translate(-3px,2px)}60%{transform:translate(3px,-2px)}70%{transform:translate(-4px,3px)}80%{transform:translate(4px,-3px)}90%{transform:translate(-2px,2px)}}
    .race-container.shake {
      animation: screenShake .6s ease-in-out;
      will-change: transform;
    }
    
    .celebration-emoji{
      position:absolute;
      font-size:70px;
      pointer-events:none;
      animation:emojiCelebrate 3s ease-out forwards
    }
    @keyframes emojiCelebrate{0%{transform:scale(0) rotate(0);opacity:0}20%{transform:scale(1.5) rotate(180deg);opacity:1}80%{opacity:1}100%{transform:scale(.5) rotate(360deg);opacity:0}}

    .celebration-word{
      position:absolute;
      font-size:44px;
      font-weight:900;
      letter-spacing:2px;
      pointer-events:none;
      opacity:.95;
      background:linear-gradient(135deg,#fff 0%, var(--primary-500) 60%, var(--primary-700) 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      filter:drop-shadow(2px 2px 6px rgba(2,6,23,.25));
      animation:wordFloat 4s ease-out forwards;
      font-family:'Montserrat'
    }
    @keyframes wordFloat{0%{transform:scale(0) translateY(0) rotate(-15deg);opacity:0}15%{transform:scale(1.25) translateY(-20px) rotate(5deg);opacity:1}100%{transform:scale(.85) translateY(-150px) rotate(15deg);opacity:0}}

    .winner-announcement{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:linear-gradient(135deg, #6366F1 0%, #8B5CF6 50%, #A855F7 100%);
      padding:40px 100px;
      border-radius:28px;
      box-shadow:0 20px 60px rgba(79,70,229,0.4);
      z-index:1001;
      pointer-events:none;
      opacity:0;
      animation:winnerSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    @keyframes winnerSlideIn{
      0%{opacity:0;transform:translate(-50%,-80%) scale(0.8)}
      100%{opacity:1;transform:translate(-50%,-50%) scale(1)}
    }
    .winner-announcement-content{
      display:flex;align-items:center;justify-content:center;gap:20px;
    }
    .winner-announcement-emoji{
      font-size:56px;
      animation:emojiPop 0.6s ease-out 0.3s both;
    }
    @keyframes emojiPop{
      0%{transform:scale(0) rotate(-180deg);opacity:0}
      70%{transform:scale(1.2) rotate(10deg)}
      100%{transform:scale(1) rotate(0deg);opacity:1}
    }
    .winner-announcement-name{
      font-size:68px;font-weight:900;color:#fff;
      text-align:center;letter-spacing:4px;
      text-shadow:0 4px 20px rgba(0,0,0,0.3);font-family:'Montserrat';
    }

    @media (max-width:768px){
      .winner-announcement{padding:32px 70px;border-radius:24px}
      .winner-announcement-content{gap:16px}
      .winner-announcement-emoji{font-size:44px}
      .winner-announcement-name{font-size:52px;letter-spacing:3px}
    }
    @media (max-width:480px){
      .winner-announcement{padding:24px 50px;border-radius:20px}
      .winner-announcement-content{gap:12px}
      .winner-announcement-emoji{font-size:36px}
      .winner-announcement-name{font-size:40px;letter-spacing:2px}
    }

    .probability-error-tooltip {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(220,38,38,0.95));
      color: #fff;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      z-index: 1002;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      max-width: 400px;
      animation: tooltipAppear 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: none;
    }

    @keyframes tooltipAppear {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    @media (max-width: 900px) {
      .probability-error-tooltip {
        max-width: 90%;
        padding: 16px 20px;
        font-size: 14px;
      }
    }

    .smoke{position:absolute;width:20px;height:20px;background:rgba(148,163,184,.6);border-radius:50%;animation:smokeRise 1s ease-out forwards;pointer-events:none}
    @keyframes smokeRise{0%{transform:scale(.5) translateY(0);opacity:.8}100%{transform:scale(2) translateY(-50px);opacity:0}}

    .traffic-light{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:#0B1020;padding:20px;border-radius:20px;border:4px solid var(--primary-500);
      box-shadow:0 10px 40px rgba(2,6,23,.5);display:none;z-index:1000
    }
    .traffic-light.active{display:block;animation:lightPop .3s ease-out}
    @keyframes lightPop{0%{transform:translate(-50%,-50%) scale(0)}100%{transform:translate(-50%,-50%) scale(1)}}
    .traffic-light-circle{width:80px;height:80px;border-radius:50%;margin:10px;background:#111827;box-shadow:inset 0 5px 15px rgba(0,0,0,.5);transition:.2s}
    .traffic-light-circle.red.active{background:#EF4444;box-shadow:0 0 40px #EF4444,inset 0 5px 15px rgba(0,0,0,.3)}
    .traffic-light-circle.yellow.active{background:#FBBF24;box-shadow:0 0 40px #FBBF24,inset 0 5px 15px rgba(0,0,0,.3)}
    .traffic-light-circle.green.active{background:#22C55E;box-shadow:0 0 40px #22C55E,inset 0 5px 15px rgba(0,0,0,.3)}

@media (max-width: 768px) {
  .top-buttons {
    top: calc(env(safe-area-inset-top, 0px) + 8px);
    left: calc(env(safe-area-inset-left, 0px) + 8px);
    right: calc(env(safe-area-inset-right, 0px) + 8px);
    gap: 8px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .top-buttons::-webkit-scrollbar { display: none; }
  .top-btn { 
    padding: 8px 14px; 
    font-size: 14px; 
    border-radius: 9px; 
    flex: 0 0 auto;
    white-space: nowrap;
  }
}
    /* responsive */
    @media (max-width:1024px){
      .top-section{flex-direction:column}
      .settings-panel{width:100%;max-width:640px}
      .race-container{flex-direction:column}
      .racers-names{flex-direction:row;gap:12px;overflow-x:auto}
      .racer-name-label{border:none;background:rgba(79,70,229,.08);border-radius:8px;padding:8px 12px;height:auto}
    }
    @media (max-width:768px){
      body{padding:12px}
      h1{font-size:38px}
      .lane{height:44px}
      .car{font-size:28px}
      .race-btn{width:100%}
      .result-text{font-size:28px}
      .traffic-light-circle{width:60px;height:60px}
    }
    @media (max-width:480px){
      h1{font-size:30px}
      .settings-panel{padding:20px}
      .lane{height:40px}
      .car{font-size:24px}
      .race-btn{padding:12px 24px;font-size:16px}
    }

    .probability-input.manual {
      background: #FFF7CC;             /* –º—è–≥–∫–∏–π –∂—ë–ª—Ç—ã–π */
      border-color: #FBBF24;           /* amber-400 */
      box-shadow: 0 0 0 3px rgba(251,191,36,.25);
    }

    /* –ú–∏–∫—Ä–æ-–∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ iOS: background-attachment: fixed –∏–Ω–æ–≥–¥–∞ —Ñ—Ä–∏–∑–∏—Ç */
@supports (-webkit-touch-callout: none) {
  body { background-attachment: scroll; }
}

/* –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –≤—ã—Ä–µ–∑–æ–≤ (iPhone —Å ¬´—á—ë–ª–∫–æ–π¬ª) */
@media (max-width: 768px) {
  body { padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left)); }
}

/* –ö–Ω–æ–ø–∫–∏ –∏ –∏–Ω–ø—É—Ç—ã ‚Äî –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–µ —Ç–∞–ø—ã, –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç –∑—É–º –Ω–∞ iOS */
input, button { font-size: 16px; }

/* –ú–æ–±–∏–ª—å–Ω–∞—è –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞: –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–≤–µ—Ä—Ö—É, —Ç—Ä–µ–∫ –Ω–∏–∂–µ (—É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å, —Ç—É—Ç –ª—ë–≥–∫–∏–π –ø–æ–ª–∏—à) */
@media (max-width: 1024px) {
  .top-section { flex-direction: column; }

  /* —à–∏—Ä–∏–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö ‚Äî —Ç—è–Ω–µ—Ç—Å—è, –Ω–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–æ–º–ø–∞–∫—Ç–Ω–æ */
  .settings-panel, .race-container { width: 100%; max-width: 680px; margin: 0 auto; }

  /* —Å–ø–∏—Å–æ–∫ –∏–º—ë–Ω ‚Äî —Å–∫—Ä–æ–ª–ª –ø–æ –æ—Å–∏ X, –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ */
  .racers-names { gap: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .racers-names::-webkit-scrollbar { height: 6px; }
  .racers-names::-webkit-scrollbar-thumb { background: rgba(79,70,229,.25); border-radius: 999px; }
}

/* –£–∑–∫–∏–µ —ç–∫—Ä–∞–Ω—ã: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã, –Ω–æ —Ç–µ –∂–µ –æ—Ç—Å—Ç—É–ø—ã/—Ä–∏—Ç–º */
@media (max-width: 768px) {
  h1 { font-size: clamp(28px, 7vw, 38px); }
  .lane { height: clamp(38px, 8.5vw, 44px); }
  .car  { font-size: clamp(24px, 6.5vw, 28px); }
  .probability-input { width: 54px; }
  .prob-btn { padding: 6px 10px; }

  /* –°—Ç–∞—Ä—Ç/—Ñ–∏–Ω–∏—à –≤–∏–∑—É–∞–ª—å–Ω–æ –±–ª–∏–∂–µ –∫ –∫—Ä–∞—è–º –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
  .start-line { left: 56px; }
  .finish-line { right: 40px; }

  /* –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç–∞ ‚Äî –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
  .race-btn { width: 100%; }
}

/* –°–æ–≤—Å–µ–º —É–∑–∫–∏–µ: —ç–∫–æ–Ω–æ–º–∏–º –≤–æ–∑–¥—É—Ö, –Ω–æ –Ω–µ –Ω–∞—Ä—É—à–∞–µ–º —Å–µ—Ç–∫—É */
@media (max-width: 420px) {
  .settings-panel { padding: 18px; }
  .names-list { max-height: 320px; }
  .header-probability { width: 108px; }
  .probability-controls { width: 108px; gap: 4px; }
}
@media (prefers-reduced-motion: reduce) {
  * { animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; scroll-behavior: auto !important; }
}
/* --- –¢–û–õ–¨–ö–û –ù–ê –ú–û–ë–ò–õ–ï --- */
@media (max-width: 768px){
  .racers-names{
    display: flex;
    gap: 10px;
    padding: 8px 12px 0;
    overflow-x: auto;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
  }
  .racer-name-label{
    height: auto;
    max-width: 92px;
    padding: 6px 10px;
    background: rgba(79,70,229,.08);
    border-radius: 12px;
    border: none;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
    font-size: 14px;
    line-height: 1.2;
  }
  .racer-name-label:first-child{ border: none; }
}
/* –î–µ—Å–∫—Ç–æ–ø ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ–Ω—é, –ø—Ä—è—á–µ–º FAB */
@media (min-width: 769px) {
  .fab-menu,
  .menu-backdrop,
  .mobile-menu {
    display: none !important;
  }
}
:root { --topbar-h: 0px; }

@media (min-width: 769px){
  .main-container{
    padding-top: calc(var(--topbar-h) + 16px);
  }
}
  </style>
</head>
<body>
  <!-- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–π –¥–ª—è –≤—Å–µ—Ö –∞–Ω–∏–º–∞—Ü–∏–π -->
  <div class="animations-layer" id="animationsLayer"></div>

  <div class="main-container">
    <div class="top-buttons">
      <a href="lottery-drum.html" class="top-btn">üé± –õ–æ—Ç–æ—Ç—Ä–æ–Ω</a>
      <a href="wheel-of-fortune.html" class="top-btn">üé° –ö–æ–ª–µ—Å–æ</a>
      <a href="crystal-ball.html" class="top-btn">üîÆ –®–∞—Ä</a>
      <a href="plinko.html" class="top-btn">üéØ –ü–ª–∏–Ω–∫–æ</a>
      <a href="racing.html" class="top-btn">üèÅ –ì–æ–Ω–∫–∏</a>
      <a href="trading.html" class="top-btn">üìà –¢—Ä–µ–π–¥–∏–Ω–≥</a>
    </div>
    <h1>–ì–û–ù–ö–ò</h1>

    <div class="top-section">
      <div class="settings-panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
          <h2 style="color:var(--ink);font-size:24px;margin:0;font-family:'Montserrat';font-weight:800">üèÅ –ì–æ–Ω—â–∏–∫–∏</h2>
          <button class="equalize-btn" id="equalizeBtn">‚öñÔ∏è –£—Ä–∞–≤–Ω—è—Ç—å</button>
        </div>
        <div class="headers-row">
          <div class="header-name">–ò–º—è</div>
          <div class="header-probability">üìä –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</div>
          <div class="header-remove"></div>
        </div>
        <div class="names-list" id="namesList"></div>
        <div class="add-name-container">
          <input type="text" class="name-input" id="newNameInput" placeholder="–ù–æ–≤—ã–π –≥–æ–Ω—â–∏–∫">
          <button class="add-btn-small" id="addNameBtn">‚ûï</button>
        </div>
      </div>

<div class="race-container">
  <div class="racers-names" id="racersNames"></div>
  <div class="race-track" id="raceTrack">
    <div class="start-line"></div>
    <div class="finish-line"></div>
  </div>
</div>

<div class="controls">
  <button class="race-btn" id="startRaceBtn">üö¶ –°–¢–ê–†–¢ –ì–û–ù–ö–ò</button>
</div>

    <div class="result"><div id="resultText"></div></div>
  </div>

  <div class="traffic-light" id="trafficLight">
    <div class="traffic-light-circle red"></div>
    <div class="traffic-light-circle yellow"></div>
    <div class="traffic-light-circle green"></div>
  </div>

<script>
// ===============================
//  –ú–æ–±–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
// ===============================
const mq = window.matchMedia('(max-width: 768px)');
let isMobile = mq.matches;
mq.addEventListener?.('change', (e) => { isMobile = e.matches; });

// ===============================
//  –ö–ª—é—á–∏ localStorage
// ===============================
const NAMES_KEY  = 'shared_names_v1';
const PROB_KEY   = 'shared_probabilities_v2';
const LOCKED_KEY = 'shared_locked_v1';
const CAR_KEY    = 'race_car_map_v1';

// ===============================
//  DOM
// ===============================
const raceTrack       = document.getElementById('raceTrack');
const racersNames     = document.getElementById('racersNames');
const startRaceBtn    = document.getElementById('startRaceBtn');
const resultBox       = document.querySelector('.result');
const resultText      = document.getElementById('resultText');
const namesList       = document.getElementById('namesList');
const addNameBtn      = document.getElementById('addNameBtn');
const newNameInput    = document.getElementById('newNameInput');
const equalizeBtn     = document.getElementById('equalizeBtn');
const trafficLight    = document.getElementById('trafficLight');
const animationsLayer = document.getElementById('animationsLayer');

// ===============================
//  –°–æ—Å—Ç–æ—è–Ω–∏–µ
// ===============================
let names = ['–î–∏–º–∞', '–°–∞—à–∞', '–ù–∏–∫–∏—Ç–∞', '–ú–∞–∫—Å–∏–º', '–ö–∏—Ä–∏–ª–ª', '–°–µ–º—ë–Ω'];
try {
  const saved = JSON.parse(localStorage.getItem(NAMES_KEY) || '[]');
  if (Array.isArray(saved) && saved.length) names = saved;
  else localStorage.setItem(NAMES_KEY, JSON.stringify(names));
} catch (_) {}

let probabilities          = {};
let lockedParticipants     = {};
let hasCustomProbabilities = false;

let isRacing = false;
let racers   = [];

const carEmojis = ['üèéÔ∏è', 'üöó', 'üöô', 'üöï', 'üöê', 'üöì', 'üöë', 'üöò', 'üöî', 'üöñ', 'üöõ'];

// ===============================
//  –í—ã–±–æ—Ä –º–∞—à–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
// ===============================
let carChoice = {};
try { carChoice = JSON.parse(localStorage.getItem(CAR_KEY) || '{}') || {}; } catch (_) {}

function saveCarChoice() {
  try { localStorage.setItem(CAR_KEY, JSON.stringify(carChoice)); } catch (_) {}
}

function getCarIndex(name, fallbackIndex) {
  const i = carChoice[name];
  return Number.isInteger(i) ? i % carEmojis.length : (fallbackIndex % carEmojis.length);
}

function cycleCar(name) {
  const next = (getCarIndex(name, 0) + 1) % carEmojis.length;
  carChoice[name] = next;
  saveCarChoice();
  return next;
}

// ===============================
//  –ê—É–¥–∏–æ
// ===============================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(f, d, v) {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.value = f;
  g.gain.value = v || 0.1;
  o.connect(g);
  g.connect(audioCtx.destination);
  const t = audioCtx.currentTime;
  o.start(t);
  o.stop(t + (d || 0.1));
}

const playEngineSound = () => playSound(150, 0.1, 0.05);
const playHornSound   = () => { playSound(400, 0.2, 0.15); setTimeout(() => playSound(600, 0.2, 0.15), 100); };

// ===============================
//  –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ (–≤–≤–æ–¥/–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è/lock)
// ===============================
function saveNames() {
  try { localStorage.setItem(NAMES_KEY, JSON.stringify(names)); } catch (_) {}
}

function initProbabilities() {
  try {
    const saved       = JSON.parse(localStorage.getItem(PROB_KEY) || '{}');
    const savedLocked = JSON.parse(localStorage.getItem(LOCKED_KEY) || '{}');

    if (saved?.hasCustomProbabilities && saved?.probabilities && Object.keys(saved.probabilities).length) {
      probabilities          = { ...saved.probabilities };
      lockedParticipants     = { ...savedLocked };
      hasCustomProbabilities = true;

      // –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã—Ö
      names.forEach((n) => { if (!(n in probabilities)) probabilities[n] = 1 / names.length; });

      // —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã—Ö
      Object.keys(probabilities).forEach((n) => { if (!names.includes(n)) delete probabilities[n]; });
      Object.keys(lockedParticipants).forEach((n) => { if (!names.includes(n)) delete lockedParticipants[n]; });

      saveProbabilities();
    } else {
      setEqualProbabilities();
    }
  } catch (_) {
    setEqualProbabilities();
  }
}

function setEqualProbabilities() {
  const p = 1 / (names.length || 1);
  probabilities = {};
  names.forEach((nm) => probabilities[nm] = p);
  lockedParticipants     = {};
  hasCustomProbabilities = false;
  saveProbabilities();
}

function clampProbabilitiesMin(min = 0.001) {
  names.forEach((nm) => { if ((probabilities[nm] ?? 0) < min) probabilities[nm] = min; });
}

function normalizeProbabilities() {
  // –ï—Å–ª–∏ —Ä–∞–≤–Ω—ã–µ –∏ –Ω–µ –∫–∞—Å—Ç–æ–º ‚Äî –¥–µ—Ä–∂–∏–º —Ç–æ—á–Ω–æ–µ –¥–µ–ª–µ–Ω–∏–µ
  const vals = names.map((n) => probabilities[n] ?? 0);
  const uniq = [...new Set(vals.map((v) => +v.toFixed(6)))];
  if (uniq.length === 1 && !hasCustomProbabilities) {
    const exact = 1 / (names.length || 1);
    names.forEach((nm) => probabilities[nm] = exact);
    return;
  }

  clampProbabilitiesMin(0.001);

  const sum = names.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
  if (sum > 0 && Math.abs(sum - 1) > 1e-4) {
    const k = 1 / sum;
    names.forEach((nm) => probabilities[nm] = (probabilities[nm] || 0) * k);
  }

  clampProbabilitiesMin(0.001);
}

function saveProbabilities() {
  try {
    const cleanP = {};
    names.forEach((nm) => cleanP[nm] = probabilities[nm] ?? 0);

    const cleanLocked = {};
    names.forEach((nm) => { if (lockedParticipants[nm]) cleanLocked[nm] = true; });

    localStorage.setItem(PROB_KEY, JSON.stringify({
      probabilities: cleanP,
      hasCustomProbabilities
    }));
    localStorage.setItem(LOCKED_KEY, JSON.stringify(cleanLocked));
  } catch (_) {}
}

function getProbabilityPercent(name) {
  if (!hasCustomProbabilities && names.length) return (100 / names.length).toFixed(1);
  return (((probabilities[name] || 0) * 100).toFixed(1));
}

function adjustProbability(name, delta) {
  const cur         = parseFloat(getProbabilityPercent(name)) || 0;
  const maxPossible = 100 - (names.length - 1) * 0.1;
  const next        = Math.max(0.1, Math.min(maxPossible, cur + delta));
  setProbabilityManually(name, next);
  createNameInputs(); // –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω–ø—É—Ç—ã
}

function setProbabilityManually(name, percentValue) {
  if (isNaN(percentValue) || percentValue < 0.1 || percentValue > 99.9) return false;

  hasCustomProbabilities = true;
  const newProb          = percentValue / 100;

  const otherLocked      = names.filter((n) => n !== name && lockedParticipants[n]);
  const lockedTotal      = otherLocked.reduce((s, n) => s + (probabilities[n] || 0), 0);
  const minOthers        = (names.length - 1) * 0.001;

  // –ï—Å–ª–∏ —Å —É—á—ë—Ç–æ–º –ª–æ–∫–∞ –∏ –º–∏–Ω–∏–º—É–º–æ–≤ –Ω–µ –ø–æ–º–µ—â–∞–µ–º—Å—è –≤ 1 ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∏ –∏ –ø—Ä–∏–Ω–∏–º–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
  if (newProb + lockedTotal + minOthers > 1) {
    lockedParticipants = {};
    probabilities[name] = newProb;
    lockedParticipants[name] = true;

    const others  = names.filter((n) => n !== name);
    const remain  = 1 - newProb;
    const share   = remain / (others.length || 1);
    others.forEach((n) => probabilities[n] = share);

    normalizeProbabilities();
    saveProbabilities();
    return true;
  }

  // –§–∏–∫—Å–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ
  lockedParticipants[name] = true;

  const free   = names.filter((n) => n !== name && !lockedParticipants[n]);
  const locked = names.filter((n) => n !== name && lockedParticipants[n]);

  if (free.length) {
    probabilities[name] = newProb;
    const lockedSum = locked.reduce((s, n) => s + (probabilities[n] || 0), 0) + newProb;
    let remain       = Math.max(0, 1 - lockedSum);

    const freeSum = free.reduce((s, n) => s + (probabilities[n] || 0), 0);
    if (freeSum > 0) {
      const k = remain / freeSum;
      free.forEach((n) => probabilities[n] = (probabilities[n] || 0) * k);
    } else {
      free.forEach((n) => probabilities[n] = remain / free.length);
    }

    free.forEach((n) => { if (probabilities[n] < 0.001) probabilities[n] = 0.001; });
  } else {
    // –í—Å–µ –∑–∞–ª–æ—á–µ–Ω—ã ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞–∏–º–µ–Ω—å—à–µ–≥–æ
    const others = names.filter((n) => n !== name).sort((a, b) => (probabilities[a] || 0) - (probabilities[b] || 0));
    const victim = others[0];
    delete lockedParticipants[victim];

    probabilities[name] = newProb;
    const stillLocked   = names.filter((n) => n !== name && lockedParticipants[n]);
    const lockedSum     = stillLocked.reduce((s, n) => s + (probabilities[n] || 0), 0) + newProb;
    const remain        = 1 - lockedSum;

    probabilities[victim] = Math.max(0.001, remain);
  }

  normalizeProbabilities();
  saveProbabilities();
  return true;
}

function equalizeProbabilities() {
  setEqualProbabilities();
  createNameInputs();
}

// ===============================
//  –ü—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–±–µ–¥—ã
// ===============================
function createCelebrationWords() {
  const words = [
    '–ü–û–õ–ù–´–ô –ì–ê–ó', '–ü–û–ë–ï–î–ê', '–ß–ï–ú–ü–ò–û–ù', '–†–ï–ö–û–†–î', '–¢–£–†–ë–û', '–°–ö–û–†–û–°–¢–¨',
    '–û–ì–û–ù–¨', '–õ–ï–ì–ï–ù–î–ê', '–§–û–†–°–ê–ñ', '–ë–´–°–¢–†–ï–ï –í–°–ï–•', '–¢–û–ü –ì–û–ù–©–ò–ö', '–î–†–ê–ô–í',
    '–ñ–ñ–Å–®–¨', '–ú–û–©–ù–û', '–í–ò–†–ê–ñ', '–ë–ï–ó–ë–ê–®–ï–ù–ù–û', '–ú–ï–ì–ê –°–ö–û–†–û–°–¢–¨', '–ö–†–ê–°–ê–í–ê'
  ];

  const cols = isMobile ? 3 : 4;
  const rows = isMobile ? 4 : 3;
  const positions = [];

  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      positions.push({ left: (c + 0.5) * (100 / cols), top: (r + 0.5) * (100 / rows) });
    }
  }

  positions.sort(() => Math.random() - 0.5);

  const count = isMobile ? 8 : 12;
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const w = document.createElement('div');
      w.className   = 'celebration-word';
      w.textContent = words[Math.floor(Math.random() * words.length)];
      const pos     = positions[i % positions.length];
      w.style.left  = (pos.left + (Math.random() - 0.5) * 10) + '%';
      w.style.top   = (pos.top  + (Math.random() - 0.5) * 10) + '%';
      w.style.animationDelay = (Math.random() * 0.3) + 's';
      animationsLayer.appendChild(w);
      setTimeout(() => w.remove(), 4500);
    }, i * 120);
  }
}

function createCelebrationEmojis() {
  const emojis = ['üèÜ', 'ü•á', 'üéâ', 'üéä', '‚≠ê', '‚ú®', 'üí®', 'üî•', 'üèÅ', 'üëè', 'üí•', '‚ö°'];
  const count  = isMobile ? 15 : 25;

  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const e = document.createElement('div');
      e.className = 'celebration-emoji';
      e.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      e.style.left = (Math.random() * 100) + '%';
      e.style.top  = (Math.random() * 100) + '%';
      e.style.animationDelay = (Math.random() * 0.5) + 's';
      animationsLayer.appendChild(e);
      setTimeout(() => e.remove(), 3500);
    }, i * 80);
  }
}

function createConfetti() {
  const cs    = ['#ff006e', '#fb5607', '#ffbe0b', '#8338ec', '#3a86ff', '#06ffa5'];
  const count = isMobile ? 80 : 160;

  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const d = document.createElement('div');
      d.className = 'confetti';
      d.style.left = (Math.random() * 100) + '%';
      d.style.top  = '0';
      d.style.background      = cs[Math.floor(Math.random() * cs.length)];
      d.style.width           = (6 + Math.random() * 12) + 'px';
      d.style.height          = (6 + Math.random() * 12) + 'px';
      d.style.animationDelay  = (Math.random() * 0.5) + 's';
      d.style.animationDuration = (2 + Math.random() * 2) + 's';
      d.style.borderRadius    = Math.random() > 0.5 ? '50%' : '0';
      animationsLayer.appendChild(d);
      setTimeout(() => d.remove(), 4000);
    }, i * 12);
  }
}

// ===============================
//  UI —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
// ===============================
function createNameInputs() {
  namesList.innerHTML = '';

  names.forEach((name, idx) => {
    const row = document.createElement('div');
    row.className = 'name-item';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'name-input';
    input.value = name;
    input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';

    input.addEventListener('input', () => {
      const v = input.value.trim();
      if (!v) return;

      const dup = names.some((n, i) => i !== idx && n.toLowerCase() === v.toLowerCase());
      if (dup) {
        input.style.borderColor = '#ef4444';
        input.style.background  = 'rgba(239,68,68,0.1)';
        return;
      }

      input.style.borderColor = 'rgba(102,126,234,0.3)';
      input.style.background  = 'rgba(255,255,255,0.9)';

      const oldName = names[idx];

      // –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å/lock/–º–∞—à–∏–Ω–∫—É –Ω–∞ –Ω–æ–≤–æ–µ –∏–º—è
      if (oldName in probabilities) {
        probabilities[v] = probabilities[oldName];
        delete probabilities[oldName];
      }
      if (oldName in lockedParticipants) {
        lockedParticipants[v] = true;
        delete lockedParticipants[oldName];
      }
      if (oldName in carChoice) {
        carChoice[v] = carChoice[oldName];
        delete carChoice[oldName];
        saveCarChoice();
      }
      saveProbabilities();

      names[idx] = v;
      saveNames();
      createRaceTrack();
      createNameInputs();
    });

    // --- –±–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é ---
    const probWrap = document.createElement('div');
    probWrap.className = 'probability-controls';

    const dec = document.createElement('button');
    dec.className = 'prob-btn';
    dec.textContent = '‚àí';
    dec.onclick = () => { adjustProbability(name, -1); };

    const probInput = document.createElement('input');
    probInput.type = 'text';
    probInput.inputMode = 'decimal';
    probInput.className = 'probability-input';
    probInput.value = getProbabilityPercent(name);
    if (lockedParticipants[name]) {
      probInput.classList.add('manual');
    }
    let lastValid = probInput.value;

    probInput.addEventListener('focus', () => {
      probInput.value = probInput.value.replace('%', '');
      lastValid = probInput.value;
    });

    probInput.addEventListener('input', () => {
      const val = probInput.value.replace('%', '').trim();
      const num = parseFloat(val);
      if (val === '' || (num >= 0.1 && num <= 99.9)) {
        probInput.style.borderColor = 'rgba(102,126,234,0.3)';
        probInput.style.background  = 'rgba(255,255,255,0.9)';
      } else {
        probInput.style.borderColor = '#ef4444';
        probInput.style.background  = 'rgba(239,68,68,0.1)';
      }
    });

    probInput.addEventListener('blur', () => {
      const val = probInput.value.replace('%', '').trim();
      const num = parseFloat(val);

      if (val === '' || isNaN(num) || num < 0.1 || num > 99.9) {
        probInput.value = lastValid;
        probInput.style.borderColor = 'rgba(102,126,234,0.3)';
        probInput.style.background  = 'rgba(255,255,255,0.9)';
        playSound(300, 0.1, 0.2);
      } else {
        if (setProbabilityManually(name, num)) {
          lastValid = getProbabilityPercent(name);
          createNameInputs();
        } else {
          probInput.value = lastValid;
          probInput.style.borderColor = 'rgba(102,126,234,0.3)';
          probInput.style.background  = 'rgba(255,255,255,0.9)';
        }
      }
    });

    probInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); probInput.blur(); }
      if (!/[\d.]/.test(e.key) && e.key !== 'Enter') e.preventDefault();
    });

    const inc = document.createElement('button');
    inc.className = 'prob-btn';
    inc.textContent = '+';
    inc.onclick = () => { adjustProbability(name, +1); };

    probWrap.appendChild(dec);
    probWrap.appendChild(probInput);
    probWrap.appendChild(inc);

    const remove = document.createElement('button');
    remove.className = 'remove-btn';
    remove.textContent = '‚úï';
    remove.onclick = () => {
      if (names.length <= 2) { alert('–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 –≥–æ–Ω—â–∏–∫–∞!'); return; }
      const removedName = names[idx];
      names.splice(idx, 1);
      delete probabilities[removedName];
      delete lockedParticipants[removedName];
      if (removedName in carChoice) { delete carChoice[removedName]; saveCarChoice(); }
      saveNames();
      normalizeProbabilities();
      saveProbabilities();
      createNameInputs();
      createRaceTrack();
    };

    row.appendChild(input);
    row.appendChild(probWrap);
    row.appendChild(remove);
    namesList.appendChild(row);
  });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
function addNewParticipant() {
  const v = newNameInput.value.trim();
  if (!v) return;

  const dup = names.some((n) => n.toLowerCase() === v.toLowerCase());
  if (dup) {
    newNameInput.style.borderColor = '#ef4444';
    newNameInput.style.background  = 'rgba(239,68,68,0.1)';
    setTimeout(() => {
      newNameInput.style.borderColor = 'rgba(102,126,234,0.3)';
      newNameInput.style.background  = 'rgba(255,255,255,0.9)';
    }, 1500);
    return;
  }

  newNameInput.value = '';
  newNameInput.style.borderColor = 'rgba(102,126,234,0.3)';
  newNameInput.style.background  = 'rgba(255,255,255,0.9)';

  names.push(v);
  saveNames();

  // –î–∞–¥–∏–º –º–∞—à–∏–Ω–∫—É –ø–æ –∫—Ä—É–≥—É
  carChoice[v] = Object.keys(carChoice).length % carEmojis.length;
  saveCarChoice();

  // –†–∞—Å—à–∏—Ä–∏–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
  probabilities[v] = 1 / names.length;
  normalizeProbabilities();
  saveProbabilities();

  createNameInputs();
  createRaceTrack();
}

addNameBtn.addEventListener('click', addNewParticipant);
newNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewParticipant(); });
equalizeBtn.addEventListener('click', equalizeProbabilities);

// ===============================
//  –¢—Ä–µ–∫/–ø–æ–ª–æ—Å—ã/–º–∞—à–∏–Ω–∫–∏
// ===============================
function createRaceTrack() {
  // –æ—á–∏—Å—Ç–∫–∞
  raceTrack.querySelectorAll('.lane').forEach((lane) => lane.remove());
  racersNames.innerHTML = '';
  racers = [];

  names.forEach((name, idx) => {
    // —è—Ä–ª—ã–∫ –∏–º–µ–Ω–∏ —Å–ª–µ–≤–∞
    const nameLabel = document.createElement('div');
    nameLabel.className = 'racer-name-label';
    nameLabel.textContent = name;
    racersNames.appendChild(nameLabel);

    // –¥–æ—Ä–æ–∂–∫–∞
    const lane = document.createElement('div');
    lane.className = 'lane';

    // –º–∞—à–∏–Ω–∞
    const car = document.createElement('div');
    car.className  = 'car';
    car.textContent = carEmojis[getCarIndex(name, idx)];
    car.title       = '–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å –º–∞—à–∏–Ω–∫—É';

    car.addEventListener('click', (e) => {
      e.stopPropagation();
      if (isRacing) return;
      const next = cycleCar(name);
      car.textContent = carEmojis[next];
      car.classList.remove('pick'); void car.offsetWidth; car.classList.add('pick');
    });

    lane.appendChild(car);
    raceTrack.appendChild(lane);

    // –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–π—Ç—ã, —á—Ç–æ–±—ã ¬´–ø—Ä–æ—á–∏–µ¬ª –Ω–µ –µ—Ö–∞–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ
    const traits = {
      baseSpeed: 1.02 + Math.random() * 0.18,     // –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
      jitter: 0.97 + Math.random() * 0.07,        // –º–µ–ª–∫–∞—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å
      aeroDrag: 0.98 + Math.random() * 0.04,      // ¬´—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ¬ª
      surgeChance: 0.02 + Math.random() * 0.05,   // —à–∞–Ω—Å –∫—Ä–∞—Ç–∫–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è
      surgePower: 1.10 + Math.random() * 0.25     // —Å–∏–ª–∞ —É—Å–∫–æ—Ä–µ–Ω–∏—è
    };

    racers.push({
      name,
      car,
      lane,
      nameLabel,
      position: 30,
      speed: 0,
      finished: false,
      finishTime: null,
      isWinner: false,
      isChallenger: false,
      scenario: null,
      traits
    });
  });
}

// ===============================
//  –î—ã–º/—Å–≤–µ—Ç–æ—Ñ–æ—Ä/—Ñ–∏–Ω–∏—à
// ===============================
function createSmoke(car, lane) {
  const smoke = document.createElement('div');
  smoke.className = 'smoke';
  smoke.style.left = car.style.left;
  smoke.style.top  = '50%';
  smoke.style.transform = 'translateY(-50%)';
  lane.appendChild(smoke);
  setTimeout(() => smoke.remove(), 1000);
}

async function showTrafficLight() {
  trafficLight.classList.add('active');
  const circles = trafficLight.querySelectorAll('.traffic-light-circle');

  circles[0].classList.add('active');
  playSound(400, 0.3, 0.2);
  await new Promise((r) => setTimeout(r, 1000));

  circles[1].classList.add('active');
  playSound(500, 0.3, 0.2);
  await new Promise((r) => setTimeout(r, 1000));

  circles[0].classList.remove('active');
  circles[1].classList.remove('active');
  circles[2].classList.add('active');
  playHornSound();
  await new Promise((r) => setTimeout(r, 500));

  trafficLight.classList.remove('active');
  circles[2].classList.remove('active');
}

async function finishRace(winner) {
  winner.car.classList.add('winner');
  playHornSound();

  const shakeTarget = document.querySelector('.race-container');
  shakeTarget.classList.add('shake');
  setTimeout(() => shakeTarget.classList.remove('shake'), 600);

  // –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
  const announcement = document.createElement('div');
  announcement.className = 'winner-announcement';
  announcement.innerHTML = `
    <div class="winner-announcement-content">
      <div class="winner-announcement-emoji">üéâ</div>
      <div class="winner-announcement-name">${winner.name}</div>
      <div class="winner-announcement-emoji">üéâ</div>
    </div>
  `;
  document.body.appendChild(announcement);

  setTimeout(() => {
    announcement.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    announcement.style.opacity    = '0';
    announcement.style.transform  = 'translate(-50%, -50%) scale(0.9)';
    setTimeout(() => announcement.remove(), 500);
  }, 4000);

  createConfetti();
  createCelebrationEmojis();
  createCelebrationWords();

  await new Promise((r) => setTimeout(r, 500));
  resultBox.style.display = 'flex';
  resultText.innerHTML = `<div class="result-text">üèÜ –ü–û–ë–ï–î–ò–¢–ï–õ–¨: ${winner.name}! üèÅ</div>`;

  setTimeout(() => {
    winner.car.classList.remove('winner');
    winner.car.style.fontSize = '35px';
    isRacing = false;
    startRaceBtn.disabled = false;
  }, 7000);
}

// ===============================
//  –ì–æ–Ω–∫–∞
// ===============================
async function startRace() {
  // –°–∞–Ω–∏—Ç–∞—Ü–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
  Object.keys(probabilities).forEach((n) => { if (!names.includes(n)) delete probabilities[n]; });
  names.forEach((n) => { if (!(n in probabilities)) probabilities[n] = 1 / names.length; });
  normalizeProbabilities();
  clampProbabilitiesMin();
  saveProbabilities();

  if (isRacing) return;
  isRacing = true;
  startRaceBtn.disabled = true;

  resultText.innerHTML = '';
  resultBox.style.display = 'none';

  racers.forEach((r) => {
    r.position     = 30;
    r.speed        = 0;
    r.finished     = false;
    r.finishTime   = null;
    r.isWinner     = false;
    r.isChallenger = false;
    r.scenario     = null;
    r.car.classList.remove('winner');
    r.car.style.left = '30px';
    r.car.style.fontSize = '35px';
  });

  await showTrafficLight();

  const trackWidth     = raceTrack.offsetWidth;
  const finishPosition = trackWidth - 100;
  const halfwayPoint   = (finishPosition - 30) / 2 + 30;

  // –í—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º
  const rnd = Math.random();
  let acc   = 0;
  let winnerName = names[names.length - 1];

  for (const n of names) {
    acc += (probabilities[n] || (1 / names.length));
    if (rnd < acc) { winnerName = n; break; }
  }

  const winnerRacer = racers.find((r) => r.name === winnerName);
  const others      = racers.filter((r) => r.name !== winnerName);

  // –°—Ü–µ–Ω–∞—Ä–∏–π: 1 ‚Äî –¥–æ–º–∏–Ω–∞—Ü–∏—è, 2 ‚Äî –æ–±–≥–æ–Ω –ø–æ—Å–ª–µ 50%, 3 ‚Äî –∫–∞–º–±—ç–∫
  const roll    = Math.random();
  const scenario = roll < 0.33 ? 1 : (roll < 0.66 ? 2 : 3);

  winnerRacer.isWinner = true;
  winnerRacer.scenario = scenario;

  // –ì–ª–∞–≤–Ω—ã–π —Å–æ–ø–µ—Ä–Ω–∏–∫
  let challengerRacer = null;
  if (others.length) {
    challengerRacer = others[Math.floor(Math.random() * others.length)];
    challengerRacer.isChallenger = true;
  }

  // –î–æ–ø. –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª–∏–∑–∞—Ü–∏—è ¬´–ø—Ä–æ—á–∏—Ö¬ª (—á—Ç–æ–±—ã –Ω–µ –µ—Ö–∞–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ):
  // –∏–º –¥–∞–¥–∏–º —Ä–∞–∑–Ω—ã–µ mini-¬´—Ç–µ–º–ø–æ–≤—ã–µ —Ñ–∞–∑—ã¬ª –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  const raceStartTs = Date.now();
  others.forEach((r) => {
    r.phasePeriod = 1200 + Math.random() * 2200;   // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–∏–∫–ª–∞ —Ç–µ–º–ø–∞
    r.phaseShift  = Math.random() * r.phasePeriod; // —Å–¥–≤–∏–≥ —Ü–∏–∫–ª–∞
    r.phaseBoost  = 1.00 + Math.random() * 0.25;   // —Å–∏–ª–∞ —Ç–µ–º–ø–∞ –≤ –ø–∏–∫
  });

  let halfwayReached   = false;
  const startTime      = Date.now();
  let engineIntervalId = setInterval(playEngineSound, 200);
  let firstFinisher    = null;

  function raceLoop() {
    const elapsed = Date.now() - startTime;

    if (!halfwayReached) {
      const maxPos = Math.max(...racers.map((r) => r.position));
      if (maxPos >= halfwayPoint) halfwayReached = true;
    }

    racers.forEach((r) => {
      if (r.finished) return;

      const beforeHalfway = !halfwayReached;

      // –ë–ê–ó–û–í–ê–Ø —Å–∫–æ—Ä–æ—Å—Ç—å
      let v = 1.08;

      // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–π—Ç—ã –Ω–∞ –∫–∞–∂–¥—ã–π —Ç–∏–∫
      const t = Date.now() - raceStartTs + (r.phaseShift || 0);
      const phase = r.phasePeriod ? (Math.sin((2 * Math.PI * t) / r.phasePeriod) * 0.5 + 0.5) : 0;
      const tempoBoost = 1 + (phase * ((r.phaseBoost || 1.0) - 1));
      const surge = (Math.random() < (r.traits?.surgeChance || 0)) ? (r.traits?.surgePower || 1) : 1;

      v *= (r.traits?.baseSpeed || 1.0);
      v *= (r.traits?.jitter || 1.0);
      v *= (r.traits?.aeroDrag || 1.0);
      v *= tempoBoost;
      v *= surge;
      v *= 0.90 + Math.random() * 0.10; // –º–∏–∫—Ä–æ-–¥—Ä–µ–±–µ–∑–≥

      // –†–æ–ª–∏
      if (r.isWinner) {
        if (scenario === 1) {
          v *= beforeHalfway ? 1.40 : 1.35;
        } else if (scenario === 2) {
          v *= beforeHalfway ? 1.25 : 1.70;
        } else { // scenario 3
          v *= beforeHalfway ? 0.85 : 2.10;
        }
      } else if (r.isChallenger) {
        if (scenario === 1) v *= beforeHalfway ? 1.15 : 1.10;
        else if (scenario === 2) v *= beforeHalfway ? 1.30 : 1.20;
        else v *= beforeHalfway ? 1.35 : 1;
      } else {
        // ¬´–ü—Ä–æ—á–∏–µ¬ª ‚Äî —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–±—Ä–æ—Å, –Ω–æ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ñ–∞–∑–∞–º–∏ –≤—ã—à–µ
        if (scenario === 1 || scenario === 2) v *= 0.70 + Math.random() * 0.30;
        else v *= 0.80 + Math.random() * 0.27;
      }

      // –ì–∞—Ä–∞–Ω—Ç–∏—è –ø–æ–±–µ–¥—ã ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø–æ—Å–ª–µ 50% –µ—Å–ª–∏ –ø–æ–∑–∞–¥–∏
      if (r.isWinner && halfwayReached) {
        const leader = racers.filter((x) => !x.finished && !x.isWinner).sort((a, b) => b.position - a.position)[0];
        if (leader && leader.position > r.position) {
          const gap = leader.position - r.position;
          r.position += gap * 0.20 + v * 0.5;
          const progress = ((r.position - 30) / (finishPosition - 30)) * 100;
          if (progress > 75) r.position += v * 0.35;
        }
      }

      // –ù–µ–º–Ω–æ–≥–æ ¬´–Ω–∞–∫–∞–∑—ã–≤–∞–µ–º¬ª —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–∏—Ö –∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö % –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
      if (r.isWinner) {
        const progress = ((r.position - 30) / (finishPosition - 30)) * 100;
        if (progress > 85) {
          const second = racers.filter((x) => !x.finished && !x.isWinner).sort((a, b) => b.position - a.position)[0];
          if (second) {
            const distToFinish = finishPosition - r.position;
            const gap          = r.position - second.position;
            const reqGap       = distToFinish * 0.10;
            if (gap < reqGap) r.position += (reqGap - gap) * 0.5 + v * 0.3;
          }
        }
      }

      r.position += v;
      r.car.style.left = r.position + 'px';

      // –î—ã–º ‚Äî —á–∞—â–µ —É –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø–æ—Å–ª–µ 50% –≤ —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö 2/3
      let smokeChance = 0.08;
      if (r.isWinner && halfwayReached) {
        smokeChance = (r.scenario === 3) ? 0.3 : (r.scenario === 2 ? 0.2 : 0.12);
      }
      if (Math.random() < smokeChance) createSmoke(r.car, r.lane);

      // –§–∏–Ω–∏—à
      if (r.position >= finishPosition && !r.finished) {
        r.finished   = true;
        r.finishTime = elapsed;
        r.position   = finishPosition + 10;

        if (!firstFinisher) {
          firstFinisher = r;
        }
      }
    });

    if (firstFinisher) {
      clearInterval(engineIntervalId);

      // –°—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –ø–µ—Ä–≤—ã–º –ø—Ä–∏–µ—Ö–∞–ª –Ω–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å, –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–∞–≥—Ä–∞–∂–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
      const trueWinner = winnerRacer || firstFinisher;
      finishRace(trueWinner);
    } else {
      requestAnimationFrame(raceLoop);
    }
  }

  raceLoop();
}

// ===============================
//  –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
// ===============================
window.addEventListener('storage', (e) => {
  if (e.key === NAMES_KEY || e.key === PROB_KEY) {
    try {
      const savedNames = JSON.parse(localStorage.getItem(NAMES_KEY) || '[]');
      if (Array.isArray(savedNames) && savedNames.length) names = savedNames;
    } catch (_) {}

    initProbabilities();
    createNameInputs();
    createRaceTrack();
  }
});

// ===============================
//  –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
// ===============================
function init() {
  initProbabilities();
  createNameInputs();
  createRaceTrack();
}

startRaceBtn.addEventListener('click', startRace);
init();
</script>


  <!-- Yandex.Metrika counter --> <script type="text/javascript"> (function(m,e,t,r,i,k,a){ m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)}; m[i].l=1*new Date(); for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }} k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a) })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=104849796', 'ym'); ym(104849796, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true}); </script> <noscript><div><img src="https://mc.yandex.ru/watch/104849796" style="position:absolute; left:-9999px;" alt="" /></div></noscript> <!-- /Yandex.Metrika counter -->
</body>
</html>