<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ì–æ–Ω–∫–∏ ‚Äî –æ–Ω–ª–∞–π–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</title>

  <!-- Favicon -->
  <link rel="icon" href="https://em-content.zobj.net/source/apple/391/racing-car_1f3ce-fe0f.png" type="image/png">
  
  <!-- Meta -->
  <meta name="description" content="üö¶ –û–Ω–ª–∞–π–Ω –≥–æ–Ω–∫–∏: –≤—ã–±–∏—Ä–∞–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∑–∞–¥–∞–≤–∞–π —à–∞–Ω—Å—ã –∏ —É—Å—Ç—Ä–∞–∏–≤–∞–π —ç–ø–∏—á–Ω—ã–µ –∑–∞–µ–∑–¥—ã! –ö—Ç–æ –ø–µ—Ä–≤—ã–º –ø–µ—Ä–µ—Å–µ—á—ë—Ç —Ñ–∏–Ω–∏—à–Ω—É—é —á–µ—Ä—Ç—É? –ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ—é —É–¥–∞—á—É!">
  <meta name="keywords" content="–≥–æ–Ω–∫–∏, –æ–Ω–ª–∞–π–Ω –∏–≥—Ä–∞, –≥–æ–Ω–∫–∞, —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä, —Å–∏–º—É–ª—è—Ç–æ—Ä –≥–æ–Ω–æ–∫, wheel of fortune, random race, —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ, —É–¥–∞—á–∞, —Ä–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä, –∏–≥—Ä–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã, –∫–æ–º–∞–Ω–¥–Ω–∞—è –∏–≥—Ä–∞">
  <meta name="author" content="RandomHost Games">
  <meta name="robots" content="index, follow">
  
  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://your-domain.com/racing.html">
  <meta property="og:title" content="üèéÔ∏è –û–Ω–ª–∞–π–Ω –ì–æ–Ω–∫–∏ ‚Äî –ö—Ç–æ –ø–æ–±–µ–¥–∏—Ç —Å–µ–≥–æ–¥–Ω—è?">
  <meta property="og:description" content="–í—ã–±–∏—Ä–∞–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∑–∞–¥–∞–≤–∞–π —à–∞–Ω—Å—ã –∏ —Å–º–æ—Ç—Ä–∏, –∫—Ç–æ –≤—ã—Ä–≤–µ—Ç—Å—è –≤–ø–µ—Ä—ë–¥ –Ω–∞ —Ñ–∏–Ω–∏—à–Ω–æ–π –ø—Ä—è–º–æ–π!">
  <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/146/146803.png">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="üèéÔ∏è –û–Ω–ª–∞–π–Ω –ì–æ–Ω–∫–∏ ‚Äî –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –£–¥–∞—á–∏">
  <meta name="twitter:description" content="–ù–∞—Å—Ç–æ—è—â–∏–µ –≥–æ–Ω–∫–∏ —É–¥–∞—á–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ!">
  <meta name="twitter:image" content="https://cdn-icons-png.flaticon.com/512/146/146803.png">

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      
      --primary: #4F46E5;
      --primary-500:#6366F1;
      --primary-700:#4338CA;
      --primary-200:#C7D2FE;
      --primary-100:#E0E7FF;
      --ink:#1F2937;
      --muted:#94A3B8;
      --card:#FFFFFF;
      --surface: rgba(255,255,255,0.96);
      --border: rgba(79,70,229,0.28);
      --shadow: 0 10px 40px rgba(2,6,23,0.18);
      --danger:#EF4444;
      --finish:#0F172A;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    min-height: 100vh;
    height: 100vh;
    padding: 40px 52px 52px 52px;
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(1200px 700px at 85% 90%, rgba(67,56,202,.18), transparent 60%),
        linear-gradient(145deg, var(--primary-100) 0%, #EEF2FF 60%, #F8FAFC 100%);
      background-attachment: fixed;
      font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow: hidden;
      touch-action: manipulation;
    }


    .main-container {
      display: flex;
      flex-direction: column;
      gap: 30px;
      align-items: center;
      max-width: 1400px;
      width: 100%;
      position: relative;
      z-index: 1;
      height: 100%;
      margin-top: 0;
    }

    .animations-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
    }

    .top-section {
      display: flex;
      gap: 30px;
      width: 100%;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .settings-panel {
      width: 470px;
      padding: 24px;
      border-radius: 20px;
      background: var(--surface);
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
      overflow: visible;
      transition: opacity 0.3s ease;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .settings-title {
      color: var(--ink);
      font-size: 24px;
      margin: 0;
      font-family: 'Montserrat';
      font-weight: 800;
    }

    .settings-actions {
      display: flex;
      gap: 8px;
    }

    .equalize-btn, .collapse-btn {
      padding: 10px 18px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-700) 100%);
      color: #fff;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .3px;
      box-shadow: 0 8px 20px rgba(79,70,229,.28);
      transition: .25s;
      white-space: nowrap;
    }

    .collapse-btn {
      display: none;
    }

    .equalize-btn:hover, .collapse-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 26px rgba(79,70,229,.36);
    }

    .equalize-btn:active, .collapse-btn:active {
      transform: translateY(0px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .names-list-wrapper {
      transition: max-height 0.3s ease;
    }

    .names-list-wrapper.collapsed {
      max-height: 0;
      overflow: hidden;
    }

    .names-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-200) transparent;
      padding: 8px 5px 8px 8px;
      margin: -8px -5px -8px -8px;
    }

    .names-list::-webkit-scrollbar {
      width: 8px;
    }

    .names-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .names-list::-webkit-scrollbar-thumb {
      background: var(--primary-200);
      border-radius: 4px;
    }

    .headers-row {
      display: flex;
      align-items: center;
      gap: 0;
      margin-bottom: 10px;
      padding: 0 5px;
    }

    .header-name {
      flex: 1;
      color: var(--ink);
      font-size: 14px;
      font-weight: 700;
      text-align: left;
    }

    .header-probability {
      color: var(--ink);
      font-size: 14px;
      font-weight: 700;
      text-align: center;
      width: 120px;
      flex-shrink: 0;
    }

    .header-remove {
      width: 48px;
      flex-shrink: 0;
    }

    .name-item {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .name-input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: #fff;
      color: var(--ink);
      font-size: 16px;
      font-weight: 700;
      transition: .2s;
    }

    .name-input:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 4px rgba(99,102,241,0.14);
    }

    .name-input::placeholder {
      color: var(--muted);
    }

    .name-input.error-state {
      border-color: var(--danger) !important;
      background: rgba(239,68,68,0.1) !important;
    }

    .probability-controls {
      display: flex;
      gap: 6px;
      width: 120px;
      flex-shrink: 0;
    }

    .prob-btn {
      padding: 6px 9px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: rgba(79,70,229,.12);
      color: var(--ink);
      font-weight: 800;
      transition: .2s;
      box-shadow:
        0 2px 6px rgba(0,0,0,0.15),
        0 4px 12px rgba(0,0,0,0.08);
      flex-shrink: 0;
    }

    .prob-btn:hover {
      background: rgba(79,70,229,.18);
      transform: translateY(-1px);
      box-shadow:
        0 3px 8px rgba(0,0,0,0.2),
        0 6px 16px rgba(0,0,0,0.12);
    }

    .prob-btn:active {
      transform: scale(0.95);
    }

    .probability-input {
      width: 58px;
      padding: 6px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: #fff;
      color: var(--primary);
      text-align: center;
      font-weight: 800;
      font-size: 14px;
      transition: .2s;
      flex-shrink: 0;
    }

    .probability-input:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 4px rgba(99,102,241,0.14);
    }

    .probability-input.error {
      border-color: var(--danger);
      background: rgba(239,68,68,.08);
    }

    .probability-input.manual {
      background: rgba(255,244,204,0.25);
      border-color: #F59E0B;
      box-shadow: 0 0 0 3px rgba(245,158,11,0.25);
    }

    .remove-btn {
      padding: 8px 13px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: rgba(239,68,68,0.7);
      color: #fff;
      font-size: 18px;
      font-weight: 800;
      transition: .2s;
      flex-shrink: 0;
      box-shadow:
        0 2px 6px rgba(0,0,0,0.15),
        0 4px 12px rgba(0,0,0,0.08);
    }

    .remove-btn:hover {
      background: rgba(239,68,68,0.9);
      transform: scale(1.1);
      box-shadow:
        0 3px 8px rgba(0,0,0,0.2),
        0 6px 16px rgba(0,0,0,0.12);
    }

    .remove-btn:active {
      transform: scale(0.95);
    }

    .add-name-container {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .add-btn-small {
      padding: 10px 15px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: rgba(34,197,94,0.7);
      color: #fff;
      font-size: 20px;
      font-weight: 800;
      transition: .2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .add-btn-small:hover {
      background: rgba(34,197,94,0.9);
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }

    .add-btn-small:active {
      transform: scale(0.95);
    }

    h1 {
      color: #0B1020;
      font-weight: 800;
      font-size: 56px;
      letter-spacing: 2px;
      text-shadow: 0 1px 0 #fff, 0 10px 30px rgba(67,56,202,.25);
      text-align: center;
      width: 100%;
    }

    .top-buttons {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }

    .desktop-menu-toggle {
      position: relative;
      background: linear-gradient(135deg, rgba(30,35,60,0.85), rgba(50,30,70,0.85));
      backdrop-filter: blur(12px);
      color: #fff;
      border: 2px solid rgba(255,255,255,0.3);
      padding: 0;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow:
        0 4px 15px rgba(0,0,0,0.3),
        0 0 0 0 rgba(255,255,255,0.4);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      overflow: hidden;
    }

    .desktop-menu-toggle::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2, #667eea);
      background-size: 200% 200%;
      animation: gradientSpin 3s ease infinite;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: -1;
    }

    @keyframes gradientSpin {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .desktop-menu-toggle:hover::before {
      opacity: 1;
    }

    .desktop-menu-toggle:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow:
        0 8px 25px rgba(0,0,0,0.4),
        0 0 0 8px rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.5);
    }

    .desktop-menu-toggle:active {
      transform: translateY(-1px) scale(0.98);
    }

    .menu-icon {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 24px;
      height: 18px;
      position: relative;
      transition: transform 0.3s ease;
    }

    .menu-icon span {
      display: block;
      width: 100%;
      height: 3px;
      background: #fff;
      border-radius: 2px;
      position: absolute;
      left: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .menu-icon span:nth-child(1) {
      top: 0;
    }

    .menu-icon span:nth-child(2) {
      top: 50%;
      margin-top: -1.5px;
    }

    .menu-icon span:nth-child(3) {
      bottom: 0;
    }

    .desktop-menu-toggle:hover .menu-icon {
      transform: scale(1.1);
    }

    .desktop-menu-toggle.active .menu-icon span:nth-child(1) {
      top: 50%;
      margin-top: -1.5px;
      transform: rotate(45deg);
    }

    .desktop-menu-toggle.active .menu-icon span:nth-child(2) {
      opacity: 0;
      transform: rotate(180deg) scale(0);
    }

    .desktop-menu-toggle.active .menu-icon span:nth-child(3) {
      bottom: auto;
      top: 50%;
      margin-top: -1.5px;
      transform: rotate(-45deg);
    }

    .desktop-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 15px;
      background: linear-gradient(135deg, rgba(20,25,45,0.92), rgba(40,20,55,0.92));
      backdrop-filter: blur(20px);
      border-radius: 16px;
      box-shadow:
        0 10px 40px rgba(0,0,0,0.5),
        0 0 0 1px rgba(255,255,255,0.15) inset,
        0 0 20px rgba(102,126,234,0.2);
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-10px);
      transition:
        max-height 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55),
        opacity 0.3s ease,
        transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      min-width: 240px;
    }

    .desktop-dropdown.active {
      max-height: 600px;
      opacity: 1;
      transform: translateY(0);
    }

    .desktop-dropdown a {
      position: relative;
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      color: #fff;
      text-decoration: none;
      font-size: 16px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .desktop-dropdown a::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      transform: translateX(-4px);
      transition: transform 0.3s ease;
    }

    .desktop-dropdown a::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(102,126,234,0.2), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .desktop-dropdown a:last-child {
      border-bottom: none;
    }

    .desktop-dropdown a:hover {
      background: rgba(102,126,234,0.25);
      padding-left: 24px;
      color: #ffd43b;
      text-shadow: 0 0 10px rgba(255,212,59,0.5);
    }

    .desktop-dropdown a:hover::before {
      transform: translateX(0);
    }

    .desktop-dropdown a:hover::after {
      opacity: 1;
    }

    .desktop-dropdown a:active {
      background: rgba(118,75,162,0.3);
      transform: scale(0.98);
    }

    .desktop-dropdown a span:first-child {
      font-size: 20px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      transition: transform 0.3s ease;
    }

    .desktop-dropdown a:hover span:first-child {
      transform: scale(1.2) rotate(10deg);
    }

    .menu-container {
      display: none;
    }

    .race-container {
      flex: 1;
      display: flex;
      gap: 20px;
      align-items: stretch;
      background: var(--surface);
      border-radius: 20px;
      padding: 28px;
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
      position: relative;
      z-index: 1;
      width: 100%;
    }

    .racers-names {
      display: flex;
      flex-direction: column;
      gap: 0;
      min-width: 100px;
      flex-shrink: 0;
    }

    .racer-name-label {
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 16px;
      font-size: 16px;
      font-weight: 800;
      color: var(--ink);
      border-bottom: 2px dashed #CBD5E1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .racer-name-label:first-child {
      border-top: 2px dashed #CBD5E1;
    }

    .race-track {
      position: relative;
      flex: 1;
    }

    .start-line {
      position: absolute;
      left: 70px;
      top: 0;
      bottom: 0;
      width: 4px;
      background: repeating-linear-gradient(0deg, var(--primary), var(--primary) 10px, #fff 10px, #fff 20px);
      z-index: 1;
    }

    .finish-line {
      position: absolute;
      right: 60px;
      top: 0;
      bottom: 0;
      width: 8px;
      background: repeating-linear-gradient(45deg, var(--finish), var(--finish) 10px, #fff 10px, #fff 20px);
      box-shadow: 0 0 20px rgba(15,23,42,.18);
      z-index: 1;
    }

    .lane {
      position: relative;
      height: 50px;
      border-top: 2px dashed #CBD5E1;
      display: flex;
      align-items: center;
    }

    .lane:last-child {
      border-bottom: 2px dashed #CBD5E1;
    }

    .car {
      position: absolute;
      left: 30px;
      font-size: 35px;
      transform: scaleX(-1);
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,.18));
      transition: left .05s linear, font-size .25s ease;
      z-index: 2;
      cursor: pointer;
    }

    .car-name-label {
      display: none;
      position: absolute;
      left: 30px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      font-weight: 700;
      color: var(--ink);
      background: rgba(255, 255, 255, 0.95);
      padding: 2px 5px;
      border-radius: 4px;
      white-space: nowrap;
      pointer-events: none;
      z-index: 3;
      transition: left .05s linear;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: -25px;
    }

    .car.pick {
      animation: pickPulse .25s ease;
    }

    @keyframes pickPulse {
      0% { transform: scaleX(-1) scale(1); }
      50% { transform: scaleX(-1) scale(1.12); }
      100% { transform: scaleX(-1) scale(1); }
    }

    .car.winner {
      animation: carBounce .5s ease-in-out infinite;
      font-size: 50px !important;
      z-index: 10;
    }

    @keyframes carBounce {
      0%, 100% { transform: scaleX(-1) translateY(0) scale(1); }
      50% { transform: scaleX(-1) translateY(-10px) scale(1.08); }
    }

    .controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 0;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .race-btn {
      padding: 18px 40px;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-700) 100%);
      color: #fff;
      font-weight: 900;
      letter-spacing: 2px;
      font-family: 'Montserrat';
      box-shadow: 0 10px 30px rgba(79,70,229,.35);
      transition: .25s;
      touch-action: manipulation;
    }

    .race-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 14px 34px rgba(79,70,229,.42);
    }

    .race-btn:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .result {
      margin-top: 30px;
      padding: 36px 56px;
      border-radius: 24px;
      background: var(--surface);
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
      min-height: 120px;
      display: none;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      position: relative;
      z-index: 1;
    }

    .result-text {
      font-size: 40px;
      font-weight: 900;
      letter-spacing: 3px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-700) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,.08));
      opacity: 0;
      animation: fadeInScale .8s forwards;
    }

    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(.5); }
      to { opacity: 1; transform: scale(1); }
    }

    button:disabled,
    input:disabled {
      opacity: 0.5;
      cursor: not-allowed !important;
      pointer-events: none;
    }

    .confetti {
      position: absolute;
      width: 12px;
      height: 12px;
      pointer-events: none;
      animation: confetti-fall 3s ease-out forwards;
    }

    @keyframes confetti-fall {
      0% { transform: translateY(0) rotate(0); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    @keyframes screenShake {
      0%, 100% { transform: translate(0, 0); }
      10% { transform: translate(-5px, 3px); }
      20% { transform: translate(5px, -3px); }
      30% { transform: translate(-4px, 4px); }
      40% { transform: translate(4px, -4px); }
      50% { transform: translate(-3px, 2px); }
      60% { transform: translate(3px, -2px); }
      70% { transform: translate(-4px, 3px); }
      80% { transform: translate(4px, -3px); }
      90% { transform: translate(-2px, 2px); }
    }

    .race-container.shake {
      animation: screenShake .6s ease-in-out;
      will-change: transform;
    }

    .celebration-emoji {
      position: absolute;
      font-size: 70px;
      pointer-events: none;
      animation: emojiCelebrate 3s ease-out forwards;
    }

    @keyframes emojiCelebrate {
      0% { transform: scale(0) rotate(0); opacity: 0; }
      20% { transform: scale(1.5) rotate(180deg); opacity: 1; }
      80% { opacity: 1; }
      100% { transform: scale(.5) rotate(360deg); opacity: 0; }
    }

    .celebration-word {
      position: absolute;
      font-size: 44px;
      font-weight: 900;
      letter-spacing: 2px;
      pointer-events: none;
      opacity: .95;
      background: linear-gradient(135deg, #fff 0%, var(--primary-500) 60%, var(--primary-700) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(2px 2px 6px rgba(2,6,23,.25));
      animation: wordFloat 4s ease-out forwards;
      font-family: 'Montserrat';
    }

    @keyframes wordFloat {
      0% { transform: scale(0) translateY(0) rotate(-15deg); opacity: 0; }
      15% { transform: scale(1.25) translateY(-20px) rotate(5deg); opacity: 1; }
      100% { transform: scale(.85) translateY(-150px) rotate(15deg); opacity: 0; }
    }

    .winner-announcement {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 50%, #A855F7 100%);
      padding: 40px 100px;
      border-radius: 28px;
      box-shadow: 0 20px 60px rgba(79,70,229,0.4);
      z-index: 1001;
      pointer-events: none;
      opacity: 0;
      animation: winnerSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes winnerSlideIn {
      0% { opacity: 0; transform: translate(-50%, -80%) scale(0.8); }
      100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .winner-announcement-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .winner-announcement-emoji {
      font-size: 56px;
      animation: emojiPop 0.6s ease-out 0.3s both;
    }

    @keyframes emojiPop {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      70% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .winner-announcement-name {
      font-size: 68px;
      font-weight: 900;
      color: #fff;
      text-align: center;
      letter-spacing: 4px;
      text-shadow: 0 4px 20px rgba(0,0,0,0.3);
      font-family: 'Montserrat';
    }

    .smoke {
      position: absolute;
      width: 20px;
      height: 20px;
      background: rgba(148,163,184,.6);
      border-radius: 50%;
      animation: smokeRise 1s ease-out forwards;
      pointer-events: none;
    }

    @keyframes smokeRise {
      0% { transform: scale(.5) translateY(0); opacity: .8; }
      100% { transform: scale(2) translateY(-50px); opacity: 0; }
    }

    .traffic-light {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #0B1020;
      padding: 20px;
      border-radius: 20px;
      border: 4px solid var(--primary-500);
      box-shadow: 0 10px 40px rgba(2,6,23,.5);
      display: none;
      z-index: 1000;
    }

    .traffic-light.active {
      display: block;
      animation: lightPop .3s ease-out;
    }

    @keyframes lightPop {
      0% { transform: translate(-50%, -50%) scale(0); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    .traffic-light-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 10px;
      background: #111827;
      box-shadow: inset 0 5px 15px rgba(0,0,0,.5);
      transition: .2s;
    }

    .traffic-light-circle.red.active {
      background: #EF4444;
      box-shadow: 0 0 40px #EF4444, inset 0 5px 15px rgba(0,0,0,.3);
    }

    .traffic-light-circle.yellow.active {
      background: #FBBF24;
      box-shadow: 0 0 40px #FBBF24, inset 0 5px 15px rgba(0,0,0,.3);
    }

    .traffic-light-circle.green.active {
      background: #22C55E;
      box-shadow: 0 0 40px #22C55E, inset 0 5px 15px rgba(0,0,0,.3);
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: .01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: .01ms !important;
      }
      
      .car.pick {
        animation: none !important;
      }
      
      .race-container.shake {
        animation: none !important;
      }
    }

    @media (max-width: 918px) {
      * {
        box-shadow: none !important;
        backdrop-filter: none !important;
        filter: none !important;
      }
      
      html, body {
        max-width: 100%;
        overflow-x: hidden;
      }

      body {
        align-items: flex-start;
        padding: calc(20px + var(--safe-top)) var(--safe-right) calc(17px + var(--safe-bottom)) var(--safe-left);
        background:
      linear-gradient(145deg, var(--primary-100) 0%, #EEF2FF 60%, #F8FAFC 100%) !important;
      }

      .top-buttons {
        display: none;
      }

      .race-container.shake {
        animation: none !important;
      }

      .menu-container {
        display: block;
        position: fixed;
        top: var(--safe-top);
        left: var(--safe-left);
        right: var(--safe-right);
        z-index: 1000;
        padding: 12px 16px;
        background: linear-gradient(180deg, rgba(102,126,234,0.95) 0%, rgba(118,75,162,0.85) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }

      .menu-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .menu-title {
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }

      .burger-btn {
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 4px;
        transition: all 0.3s ease;
        min-width: 44px;
        min-height: 44px;
        align-items: center;
        justify-content: center;
      }

      .burger-btn:hover {
        background: rgba(255,255,255,0.3);
      }

      .burger-btn span {
        display: block;
        width: 24px;
        height: 3px;
        background: #fff;
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      .burger-btn.active span:nth-child(1) {
        transform: rotate(45deg) translateY(7px);
      }

      .burger-btn.active span:nth-child(2) {
        opacity: 0;
      }

      .burger-btn.active span:nth-child(3) {
        transform: rotate(-45deg) translateY(-7px);
      }

      .menu-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, rgba(102,126,234,0.98) 0%, rgba(118,75,162,0.98) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .menu-dropdown.active {
        max-height: 500px;
      }

      .menu-dropdown a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        color: #fff;
        text-decoration: none;
        font-size: 16px;
        font-weight: 600;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        transition: background 0.2s ease;
        min-height: 56px;
      }

      .car {
        font-size: clamp(20px, 5vw, 24px);
        left: 20px;
      }

      .menu-dropdown a:last-child {
        border-bottom: none;
      }

      .menu-dropdown a:hover {
        background: rgba(255,255,255,0.15);
      }

      .menu-dropdown a:active {
        background: rgba(255,255,255,0.25);
      }

      .top-section {
        flex-direction: column;
        gap: 24px;
        align-items: stretch;
      }

      .settings-panel {
        width: 100%;
        max-width: 600px;
        padding: 20px 16px;
        margin: 0 auto;
      }

      .settings-header {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        margin-bottom: 10px;
      }

      .settings-actions {
        display: flex;
        justify-content: space-between;
        width: 100%;
        gap: 0;
        margin-bottom: 4px;
      }

      .settings-actions .equalize-btn,
      .settings-actions .collapse-btn {
        flex: 0 0 48%;
        max-width: 48%;
        padding: 10px 0;
        font-size: 14px;
        text-align: center;
      }

      .collapse-btn {
        display: inline-flex;
        justify-content: center;
        align-items: center;
      }

      .names-list-wrapper {
        max-height: none;
      }

      .names-list {
        max-height: none;
        overflow-y: visible;
        overflow: visible;
        width: 100%;
        max-width: 100%;
        flex: 1 1 auto;
      }

      .name-item {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
      }

      .name-input {
        min-width: 0;
        padding: 12px 10px;
        min-height: 48px;
        flex: 1 1 auto;
      }

      .headers-row {
        padding: 0 2px;
      }

      .header-probability {
        flex: 0 0 130px;
        max-width: 130px;
        display: flex;
        justify-content: center;
        text-align: center;
      }

      .probability-controls {
        flex: 0 0 130px;
        max-width: 130px;
        gap: 4px;
        flex-shrink: 0;
      }

      .probability-input {
        flex: 0 0 50px;
        width: 50px;
        min-width: 50px;
        max-width: 50px;
      }

      .prob-btn {
        flex: 0 0 40px;
        width: 40px;
        min-width: 40px;
        max-width: 40px;
        min-height: 44px;
        padding: 6px 0;
      }

      .remove-btn {
        flex: 0 0 48px;
        width: 48px;
        min-width: 48px;
        max-width: 48px;
        min-height: 48px;
        margin-left: 14px;
      }

      .add-name-container {
        display: flex;
        gap: 8px;
        margin-top: 15px;
      }

      .add-name-container .name-input {
        flex: 0 1 calc(100% - 60px);
        max-width: calc(100% - 60px);
      }

      .add-btn-small {
        min-width: 52px;
        min-height: 52px;
        flex-shrink: 0;
      }

      .race-container {
        flex-direction: column;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
      }

      .car-name-label {
        display: block;
      }

      .racers-names {
        display: none;
      }

      .racer-name-label {
        height: auto;
        max-width: 92px;
        padding: 6px 10px;
        background: rgba(79,70,229,.08);
        border-radius: 12px;
        border: none;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        font-size: 14px;
        line-height: 1.2;
      }

      .racer-name-label:first-child {
        border: none;
      }

      h1 {
        font-size: clamp(24px, 6vw, 48px);
        margin-bottom: 10px;
        margin-top: 18px !important;
      }

      .lane {
        height: clamp(60px, 12vw, 70px);
      }

      .car {
        font-size: 28px;
        transition: left .05s linear;
      }

      .car.pick {
        animation: none;
      }

      .car.winner {
        font-size: 28px !important;
        animation: none;
      }

      .start-line {
        left: 56px;
      }

      .finish-line {
        right: 40px;
      }

      .controls {
        gap: 16px;
        flex-wrap: wrap;
        margin-top: 24px;
        margin-bottom: 35px;
      }

      .controls button {
        flex: 1 1 220px;
        min-height: 56px;
        max-width: 100%;
      }

      .result {
        min-height: 52px;
        padding: 14px;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: 0;
        width: calc(100% - 32px);
        margin-top: 0;
      }

      .result-text {
        font-size: clamp(18px, 4.8vw, 28px);
      }

      .winner-announcement {
        animation: winnerSlideInMobile .4s ease-out forwards;
      }

      .winner-announcement-name {
        font-size: clamp(22px, 5.4vw, 30px);
      }

      .winner-announcement-emoji {
        font-size: clamp(24px, 6vw, 32px);
      }

      .celebration-word {
        font-size: clamp(22px, 5.5vw, 40px);
      }

      @keyframes winnerSlideInMobile {
    0% { opacity: 0; transform: translate(-50%, -40%) scale(.9); }
    100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  }

      .celebration-emoji {
        font-size: clamp(40px, 10vw, 60px);
      }

      .traffic-light-circle {
        width: 60px;
        height: 60px;
      }
    }

    @media (max-width: 360px) {
      .probability-controls,
      .header-probability {
        width: auto;
      }

      .probability-input {
        min-width: 46px;
        font-size: 13px;
        flex-shrink: 0;
      }

      .prob-btn {
        min-width: 38px;
        padding: 5px 7px;
        flex-shrink: 0;
      }
    }

    @media (hover: none) {
      .top-btn:hover,
      .prob-btn:hover,
      .add-btn-small:hover,
      .remove-btn:hover,
      .race-btn:hover,
      .equalize-btn:hover,
      .collapse-btn:hover {
        transform: none !important;
      }
    }

    @supports (-webkit-touch-callout: none) {
      body {
        background-attachment: scroll;
      }
    }
  </style>
</head>
<body>
  <div class="animations-layer" id="animationsLayer"></div>

  <div class="top-buttons">
    <button class="desktop-menu-toggle" id="desktopMenuToggle" aria-label="–ú–µ–Ω—é">
      <div class="menu-icon">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>
    <nav class="desktop-dropdown" id="desktopDropdown">
      <a href="index.html"><span>üè†</span> –ì–ª–∞–≤–Ω–∞—è</a>
      <a href="bingo.html"><span>üé≤</span> –ë–∏–Ω–≥–æ</a>
      <a href="wheel-of-fortune.html"><span>üé°</span> –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</a>
      <a href="lottery-drum.html"><span>üé±</span> –õ–æ—Ç–æ—Ç—Ä–æ–Ω</a>
      <a href="crystal-ball.html"><span>üîÆ</span> –ú–∞–≥–∏—á–µ—Å–∫–∏–π –®–∞—Ä</a>
      <a href="plinko.html"><span>üéØ</span> –ü–ª–∏–Ω–∫–æ</a>
      <a href="racing.html"><span>üèÅ</span> –ì–æ–Ω–∫–∏</a>
      <a href="trading.html"><span>üìà</span> –¢—Ä–µ–π–¥–∏–Ω–≥</a>
      <a href="tournament.html"><span>‚öîÔ∏è</span> –¢—É—Ä–Ω–∏—Ä</a>
    </nav>
  </div>

  <div class="menu-container">
    <div class="menu-header">
      <button class="burger-btn" id="burgerBtn" aria-label="–ú–µ–Ω—é">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <nav class="menu-dropdown" id="menuDropdown">
      <a href="index.html">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      <a href="bingo.html">üé≤ –ë–∏–Ω–≥–æ</a>
      <a href="wheel-of-fortune.html">üé° –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</a>
      <a href="lottery-drum.html">üé± –õ–æ—Ç–æ—Ç—Ä–æ–Ω</a>
      <a href="crystal-ball.html">üîÆ –ú–∞–≥–∏—á–µ—Å–∫–∏–π –®–∞—Ä</a>
      <a href="plinko.html">üéØ –ü–ª–∏–Ω–∫–æ</a>
      <a href="racing.html">üèÅ –ì–æ–Ω–∫–∏</a>
      <a href="trading.html">üìà –¢—Ä–µ–π–¥–∏–Ω–≥</a>
    </nav>
  </div>

  <div class="main-container">
    <h1>üèÅ –ì–û–ù–ö–ò üèÅ</h1>

    <div class="top-section">
      <div class="settings-panel">
        <div class="settings-header">
          <h2 class="settings-title">–ì–æ–Ω—â–∏–∫–∏</h2>
          <div class="settings-actions">
            <button class="equalize-btn" id="equalizeBtn" title="–£—Ä–∞–≤–Ω—è—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏">–£—Ä–∞–≤–Ω—è—Ç—å</button>
            <button class="collapse-btn" id="collapseBtn" title="–°–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫">
              <span id="collapseIcon">‚ñº</span>
            </button>
          </div>
        </div>
        
        <div class="names-list-wrapper" id="namesListWrapper">
          <div class="headers-row">
            <div class="header-name">–ò–º—è</div>
            <div class="header-probability">üìä –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</div>
            <div class="header-remove"></div>
          </div>
          <div class="names-list" id="namesList"></div>
        </div>

        <div class="add-name-container">
          <input type="text" class="name-input" id="newNameInput" placeholder="–ù–æ–≤—ã–π –≥–æ–Ω—â–∏–∫" maxlength="15">
          <button class="add-btn-small" id="addNameBtn" title="–î–æ–±–∞–≤–∏—Ç—å –≥–æ–Ω—â–∏–∫–∞">‚ûï</button>
        </div>
      </div>

      <div class="race-container">
        <div class="racers-names" id="racersNames"></div>
        <div class="race-track" id="raceTrack">
          <div class="start-line"></div>
          <div class="finish-line"></div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="race-btn" id="startRaceBtn">üö¶ –°–¢–ê–†–¢ –ì–û–ù–ö–ò</button>
    </div>

    <div class="result">
      <div class="result-text" id="resultText"></div>
    </div>
  </div>

  <div class="traffic-light" id="trafficLight">
    <div class="traffic-light-circle red"></div>
    <div class="traffic-light-circle yellow"></div>
    <div class="traffic-light-circle green"></div>
  </div>

  <script>
    const NAMES_KEY = 'shared_names_v1';
    const PROB_KEY = 'shared_probabilities_v2';
    const LOCKED_KEY = 'shared_locked_v1';
    const CAR_KEY = 'race_car_map_v1';

    const raceTrack = document.getElementById('raceTrack');
    const racersNames = document.getElementById('racersNames');
    const startRaceBtn = document.getElementById('startRaceBtn');
    const resultBox = document.querySelector('.result');
    const resultText = document.getElementById('resultText');
    const namesList = document.getElementById('namesList');
    const addNameBtn = document.getElementById('addNameBtn');
    const newNameInput = document.getElementById('newNameInput');
    const equalizeBtn = document.getElementById('equalizeBtn');
    const trafficLight = document.getElementById('trafficLight');
    const animationsLayer = document.getElementById('animationsLayer');
    const burgerBtn = document.getElementById('burgerBtn');
    const menuDropdown = document.getElementById('menuDropdown');
    const collapseBtn = document.getElementById('collapseBtn');
    const collapseIcon = document.getElementById('collapseIcon');
    const namesListWrapper = document.getElementById('namesListWrapper');

    let names = ['–î–∏–º–∞', '–°–∞—à–∞', '–ù–∏–∫–∏—Ç–∞', '–ú–∞–∫—Å–∏–º', '–ö–∏—Ä–∏–ª–ª', '–°–µ–º—ë–Ω'];
    let probabilities = {};
    let lockedParticipants = {};
    let hasCustomProbabilities = false;
    let isRacing = false;
    let racers = [];
    let carChoice = {};

    const carEmojis = ['üèéÔ∏è', 'üöó', 'üöô', 'üöï', 'üöê', 'üöì', 'üöë', 'üöõ'];

    // ===== DESKTOP MENU =====
    const desktopMenuToggle = document.getElementById('desktopMenuToggle');
    const desktopDropdown = document.getElementById('desktopDropdown');
    let desktopMenuOpen = false;

    function toggleDesktopMenu() {
      desktopMenuOpen = !desktopMenuOpen;
      desktopDropdown.classList.toggle('active', desktopMenuOpen);
      desktopMenuToggle.classList.toggle('active', desktopMenuOpen);
    }

    if (desktopMenuToggle) {
      desktopMenuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleDesktopMenu();
      });

      document.addEventListener('click', (e) => {
        if (
          desktopMenuOpen &&
          !desktopDropdown.contains(e.target) &&
          !desktopMenuToggle.contains(e.target)
        ) {
          toggleDesktopMenu();
        }
      });
    }

    // ===== BURGER MENU (MOBILE) =====
    let menuOpen = false;

    function toggleMenu() {
      menuOpen = !menuOpen;
      menuDropdown.classList.toggle('active', menuOpen);
      burgerBtn.classList.toggle('active', menuOpen);
    }

    if (burgerBtn) {
      burgerBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleMenu();
      });

      document.addEventListener('click', (e) => {
        if (menuOpen && !menuDropdown.contains(e.target) && !burgerBtn.contains(e.target)) {
          toggleMenu();
        }
      });
    }

    let listCollapsed = false;

    if (collapseBtn) {
      collapseBtn.addEventListener('click', () => {
        listCollapsed = !listCollapsed;
        namesListWrapper.classList.toggle('collapsed', listCollapsed);
        collapseIcon.textContent = listCollapsed ? '‚ñ≤' : '‚ñº';
      });
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(f, d, v) {
      try {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.value = f;
        g.gain.value = v || 0.1;
        o.connect(g);
        g.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        o.start(t);
        o.stop(t + (d || 0.1));
      } catch (e) {}
    }

    const playEngineSound = () => playSound(150, 0.1, 0.05);
    const playHornSound = () => {
      playSound(400, 0.2, 0.15);
      setTimeout(() => playSound(600, 0.2, 0.15), 100);
    };

    try {
      const saved = JSON.parse(localStorage.getItem(NAMES_KEY) || '[]');
      if (Array.isArray(saved) && saved.length) names = saved;
      else localStorage.setItem(NAMES_KEY, JSON.stringify(names));
    } catch (e) {}

    const saveNames = () => {
      try {
        localStorage.setItem(NAMES_KEY, JSON.stringify(names));
      } catch (e) {}
    };

    try {
      carChoice = JSON.parse(localStorage.getItem(CAR_KEY) || '{}') || {};
    } catch (_) {}

    function saveCarChoice() {
      try {
        localStorage.setItem(CAR_KEY, JSON.stringify(carChoice));
      } catch (_) {}
    }

    function getCarIndex(name, fallbackIndex) {
      const i = carChoice[name];
      return Number.isInteger(i) ? i % carEmojis.length : (fallbackIndex % carEmojis.length);
    }

    function cycleCar(name) {
      const next = (getCarIndex(name, 0) + 1) % carEmojis.length;
      carChoice[name] = next;
      saveCarChoice();
      return next;
    }

    function setUILocked(locked) {
      startRaceBtn.disabled = locked;
      addNameBtn.disabled = locked;
      newNameInput.disabled = locked;
      equalizeBtn.disabled = locked;
      
      if (collapseBtn) collapseBtn.disabled = locked;
      
      const allInputs = namesList.querySelectorAll('.name-input, .probability-input');
      const allButtons = namesList.querySelectorAll('.prob-btn, .remove-btn');
      
      allInputs.forEach(input => input.disabled = locked);
      allButtons.forEach(button => button.disabled = locked);
      
      if (locked) {
        document.querySelector('.settings-panel').style.opacity = '0.5';
        document.querySelector('.settings-panel').style.pointerEvents = 'none';
      } else {
        document.querySelector('.settings-panel').style.opacity = '1';
        document.querySelector('.settings-panel').style.pointerEvents = 'auto';
      }
    }

    function validateAllNames() {
      let allValid = true;
      
      const nameInputs = namesList.querySelectorAll('.name-input');
      nameInputs.forEach(input => {
        const value = input.value.trim();
        if (!value || value.length === 0 || input.value.length > 15) {
          allValid = false;
        }
      });
      
      startRaceBtn.disabled = !allValid || isRacing;
      
      return allValid;
    }

    newNameInput.addEventListener('keydown', (e) => {
      if (newNameInput.value.length >= 15 && 
          !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'].includes(e.key) &&
          !e.ctrlKey && !e.metaKey) {
        
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
        newNameInput.placeholder = '‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤';
        
        setTimeout(() => {
          newNameInput.placeholder = '–ù–æ–≤—ã–π –≥–æ–Ω—â–∏–∫';
          if (newNameInput.value.trim()) {
            const dup = names.some((n) => n.toLowerCase() === newNameInput.value.trim().toLowerCase());
            if (!dup) {
              newNameInput.style.borderColor = 'rgba(79,70,229,0.28)';
              newNameInput.style.background = 'rgba(255,255,255,0.96)';
            }
          } else {
            newNameInput.style.borderColor = 'rgba(79,70,229,0.28)';
            newNameInput.style.background = 'rgba(255,255,255,0.96)';
          }
        }, 1500);
      }
    });

    newNameInput.addEventListener('input', () => {
      const v = newNameInput.value.trim();
      
      if (!v || v.length === 0) {
        newNameInput.style.borderColor = 'rgba(79,70,229,0.28)';
        newNameInput.style.background = 'rgba(255,255,255,0.96)';
        return;
      }
      
      const dup = names.some((n) => n.toLowerCase() === v.toLowerCase());
      if (dup) {
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
      } else {
        newNameInput.style.borderColor = 'rgba(79,70,229,0.28)';
        newNameInput.style.background = 'rgba(255,255,255,0.96)';
      }
    });

    function initProbabilities() {
      try {
        const saved = JSON.parse(localStorage.getItem(PROB_KEY) || '{}');
        const savedLocked = JSON.parse(localStorage.getItem(LOCKED_KEY) || '{}');

        if (saved?.hasCustomProbabilities && saved?.probabilities && Object.keys(saved.probabilities).length) {
          probabilities = { ...saved.probabilities };
          lockedParticipants = { ...savedLocked };
          hasCustomProbabilities = true;

          names.forEach((n) => { if (!(n in probabilities)) probabilities[n] = 1 / names.length; });
          Object.keys(probabilities).forEach((n) => { if (!names.includes(n)) delete probabilities[n]; });
          Object.keys(lockedParticipants).forEach((n) => { if (!names.includes(n)) delete lockedParticipants[n]; });

          saveProbabilities();
        } else {
          setEqualProbabilities();
        }
      } catch (_) {
        setEqualProbabilities();
      }
    }

    function setEqualProbabilities() {
      const p = 1 / (names.length || 1);
      probabilities = {};
      names.forEach((nm) => probabilities[nm] = p);
      lockedParticipants = {};
      hasCustomProbabilities = false;
      saveProbabilities();
    }

    function clampProbabilitiesMin(min = 0.001) {
      names.forEach((nm) => { if ((probabilities[nm] ?? 0) < min) probabilities[nm] = min; });
    }

    function normalizeProbabilities() {
      const vals = names.map((n) => probabilities[n] ?? 0);
      const uniq = [...new Set(vals.map((v) => +v.toFixed(6)))];
      if (uniq.length === 1 && !hasCustomProbabilities) {
        const exact = 1 / (names.length || 1);
        names.forEach((nm) => probabilities[nm] = exact);
        return;
      }

      clampProbabilitiesMin(0.001);

      const sum = names.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
      if (sum > 0 && Math.abs(sum - 1) > 1e-4) {
        const k = 1 / sum;
        names.forEach((nm) => probabilities[nm] = (probabilities[nm] || 0) * k);
      }

      clampProbabilitiesMin(0.001);
    }

    function saveProbabilities() {
      try {
        const cleanP = {};
        names.forEach((nm) => cleanP[nm] = probabilities[nm] ?? 0);

        const cleanLocked = {};
        names.forEach((nm) => { if (lockedParticipants[nm]) cleanLocked[nm] = true; });

        localStorage.setItem(PROB_KEY, JSON.stringify({
          probabilities: cleanP,
          hasCustomProbabilities
        }));
        localStorage.setItem(LOCKED_KEY, JSON.stringify(cleanLocked));
      } catch (_) {}
    }

    function getProbabilityPercent(name) {
      if (!hasCustomProbabilities && names.length) return (100 / names.length).toFixed(1);
      return (((probabilities[name] || 0) * 100).toFixed(1));
    }

    function adjustProbability(name, delta) {
      const cur = parseFloat(getProbabilityPercent(name)) || 0;
      const maxPossible = 100 - (names.length - 1) * 0.1;
      const next = Math.max(0.1, Math.min(maxPossible, cur + delta));
      setProbabilityManually(name, next);
      createNameInputs();
    }

    function setProbabilityManually(name, percentValue) {
      if (isNaN(percentValue) || percentValue < 0.1 || percentValue > 99.9) return false;

      hasCustomProbabilities = true;
      const newProb = percentValue / 100;

      const otherLocked = names.filter((n) => n !== name && lockedParticipants[n]);
      const lockedTotal = otherLocked.reduce((s, n) => s + (probabilities[n] || 0), 0);
      const minOthers = (names.length - 1) * 0.001;

      if (newProb + lockedTotal + minOthers > 1) {
        lockedParticipants = {};
        probabilities[name] = newProb;
        lockedParticipants[name] = true;

        const others = names.filter((n) => n !== name);
        const remain = 1 - newProb;
        const share = remain / (others.length || 1);
        others.forEach((n) => probabilities[n] = share);

        normalizeProbabilities();
        saveProbabilities();
        return true;
      }

      lockedParticipants[name] = true;

      const free = names.filter((n) => n !== name && !lockedParticipants[n]);
      const locked = names.filter((n) => n !== name && lockedParticipants[n]);

      if (free.length) {
        probabilities[name] = newProb;
        const lockedSum = locked.reduce((s, n) => s + (probabilities[n] || 0), 0) + newProb;
        let remain = Math.max(0, 1 - lockedSum);

        const freeSum = free.reduce((s, n) => s + (probabilities[n] || 0), 0);
        if (freeSum > 0) {
          const k = remain / freeSum;
          free.forEach((n) => probabilities[n] = (probabilities[n] || 0) * k);
        } else {
          free.forEach((n) => probabilities[n] = remain / free.length);
        }

        free.forEach((n) => { if (probabilities[n] < 0.001) probabilities[n] = 0.001; });
      } else {
        const others = names.filter((n) => n !== name).sort((a, b) => (probabilities[a] || 0) - (probabilities[b] || 0));
        const victim = others[0];
        delete lockedParticipants[victim];

        probabilities[name] = newProb;
        const stillLocked = names.filter((n) => n !== name && lockedParticipants[n]);
        const lockedSum = stillLocked.reduce((s, n) => s + (probabilities[n] || 0), 0) + newProb;
        const remain = 1 - lockedSum;

        probabilities[victim] = Math.max(0.001, remain);
      }

      normalizeProbabilities();
      saveProbabilities();
      return true;
    }

    function equalizeProbabilities() {
      setEqualProbabilities();
      createNameInputs();
      createRaceTrack();
    }

    function createNameInputs() {
      namesList.innerHTML = '';

      names.forEach((name, idx) => {
        const row = document.createElement('div');
        row.className = 'name-item';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'name-input';
        input.value = name;
        input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
        input.maxLength = 15;

        input.addEventListener('keydown', (e) => {
          if (input.value.length >= 15 && 
              !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'].includes(e.key) &&
              !e.ctrlKey && !e.metaKey) {
            
            input.classList.add('error-state');
            input.style.borderColor = '#ef4444';
            input.style.background = 'rgba(239,68,68,0.1)';
            const originalPlaceholder = input.placeholder;
            input.placeholder = '‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤';
            
            setTimeout(() => {
              input.placeholder = originalPlaceholder;
              if (input.value.trim()) {
                input.classList.remove('error-state');
                input.style.borderColor = 'rgba(79,70,229,0.28)';
                input.style.background = 'rgba(255,255,255,0.96)';
              }
            }, 1500);
          }
        });

        input.addEventListener('input', () => {
          const v = input.value.trim();
          
          if (!v || v.length === 0) {
            input.classList.add('error-state');
            input.style.borderColor = '#ef4444';
            input.style.background = 'rgba(239,68,68,0.1)';
            
            const oldName = names[idx];
            if (oldName in probabilities) {
              probabilities[''] = probabilities[oldName];
              delete probabilities[oldName];
            }
            if (oldName in lockedParticipants) {
              lockedParticipants[''] = true;
              delete lockedParticipants[oldName];
            }
            if (oldName in carChoice) {
              carChoice[''] = carChoice[oldName];
              delete carChoice[oldName];
            }
            names[idx] = '';
            saveNames();
            saveProbabilities();
            saveCarChoice();
            createRaceTrack();
            
            validateAllNames();
            return;
          }
          
          const dup = names.some((n, i) => i !== idx && n.toLowerCase() === v.toLowerCase());
          if (dup) {
            input.classList.add('error-state');
            input.style.borderColor = '#ef4444';
            input.style.background = 'rgba(239,68,68,0.1)';
          } else {
            input.classList.remove('error-state');
            input.style.borderColor = 'rgba(79,70,229,0.28)';
            input.style.background = 'rgba(255,255,255,0.96)';
          }
          
          if (dup) {
            validateAllNames();
            return;
          }

          const oldName = names[idx];

          if (oldName in probabilities) {
            probabilities[v] = probabilities[oldName];
            delete probabilities[oldName];
          }
          if (oldName in lockedParticipants) {
            lockedParticipants[v] = true;
            delete lockedParticipants[oldName];
          }
          if (oldName in carChoice) {
            carChoice[v] = carChoice[oldName];
            delete carChoice[oldName];
            saveCarChoice();
          }

          names[idx] = v;
          saveNames();
          saveProbabilities();
          createRaceTrack();
          validateAllNames();
        });

        input.addEventListener('blur', () => {
          const v = input.value.trim();
          
          if (!v || v.length === 0) {
            input.value = '';
            input.classList.add('error-state');
            input.style.borderColor = '#ef4444';
            input.style.background = 'rgba(239,68,68,0.1)';
            input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
            validateAllNames();
            return;
          }
          
          const dup = names.some((n, i) => i !== idx && n.toLowerCase() === v.toLowerCase());
          if (dup) {
            input.value = names[idx];
            input.classList.remove('error-state');
            input.style.borderColor = 'rgba(79,70,229,0.28)';
            input.style.background = 'rgba(255,255,255,0.96)';
            input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
          } else {
            input.classList.remove('error-state');
            input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
          }
          validateAllNames();
        });

        input.addEventListener('focus', () => {
          if (input.placeholder === '–í–≤–µ–¥–∏—Ç–µ –∏–º—è') {
            input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
          }
          if (input.value.trim()) {
            input.classList.remove('error-state');
          }
        });

        const probControls = document.createElement('div');
        probControls.className = 'probability-controls';

        const decreaseBtn = document.createElement('button');
        decreaseBtn.className = 'prob-btn';
        decreaseBtn.textContent = '‚àí';
        decreaseBtn.setAttribute('aria-label', '–£–º–µ–Ω—å—à–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å');
        decreaseBtn.onclick = () => {
          adjustProbability(name, -1);
          createRaceTrack();
        };

        const probInput = document.createElement('input');
        probInput.type = 'text';
        probInput.inputMode = 'decimal';
        probInput.className = 'probability-input';
        probInput.value = getProbabilityPercent(name);
        probInput.setAttribute('aria-label', '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö');
        if (lockedParticipants[name]) {
          probInput.classList.add('manual');
        }
        let lastValid = probInput.value;

        probInput.addEventListener('focus', () => {
          probInput.value = probInput.value.replace('%', '');
          lastValid = probInput.value;
        });

        probInput.addEventListener('input', () => {
          const val = probInput.value.replace('%', '').trim();
          const num = parseFloat(val);
          if (val === '' || (num >= 0.1 && num <= 99.9)) {
            probInput.classList.remove('error');
          } else {
            probInput.classList.add('error');
          }
        });

        probInput.addEventListener('blur', () => {
          const val = probInput.value.replace('%', '').trim();
          const num = parseFloat(val);

          if (val === '' || isNaN(num) || num < 0.1 || num > 99.9) {
            probInput.value = lastValid;
            probInput.classList.remove('error');
            playSound(300, 0.1, 0.2);
          } else {
            if (setProbabilityManually(name, num)) {
              lastValid = getProbabilityPercent(name);
              createNameInputs();
              createRaceTrack();
            } else {
              probInput.value = lastValid;
              probInput.classList.remove('error');
            }
          }
        });

        probInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') { 
            e.preventDefault(); 
            probInput.blur(); 
          }
          if (!/[\d.]/.test(e.key) && e.key !== 'Enter') e.preventDefault();
        });

        const increaseBtn = document.createElement('button');
        increaseBtn.className = 'prob-btn';
        increaseBtn.textContent = '+';
        increaseBtn.setAttribute('aria-label', '–£–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å');
        increaseBtn.onclick = () => {
          adjustProbability(name, 1);
          createRaceTrack();
        };

        probControls.appendChild(decreaseBtn);
        probControls.appendChild(probInput);
        probControls.appendChild(increaseBtn);

        const btn = document.createElement('button');
        btn.className = 'remove-btn';
        btn.textContent = '‚úï';
        btn.setAttribute('aria-label', '–£–¥–∞–ª–∏—Ç—å –≥–æ–Ω—â–∏–∫–∞');
        btn.onclick = () => {
          if (names.length <= 2) {
            newNameInput.style.borderColor = '#ef4444';
            newNameInput.style.background = 'rgba(239,68,68,0.1)';
            newNameInput.placeholder = '–ú–∏–Ω–∏–º—É–º 2 –≥–æ–Ω—â–∏–∫–∞';
            
            setTimeout(() => {
              newNameInput.placeholder = '–ù–æ–≤—ã–π –≥–æ–Ω—â–∏–∫';
              if (!newNameInput.value.trim()) {
                newNameInput.style.borderColor = 'rgba(79,70,229,0.28)';
                newNameInput.style.background = 'rgba(255,255,255,0.96)';
              }
            }, 2000);
            return;
          }
          const removedName = names[idx];
          names.splice(idx, 1);
          delete probabilities[removedName];
          delete lockedParticipants[removedName];
          if (removedName in carChoice) {
            delete carChoice[removedName];
            saveCarChoice();
          }

          saveNames();
          normalizeProbabilities();
          saveProbabilities();

          createNameInputs();
          createRaceTrack();
        };

        row.appendChild(input);
        row.appendChild(probControls);
        row.appendChild(btn);
        namesList.appendChild(row);
      });
      
      validateAllNames();
    }

    function addNewParticipant() {
      const v = newNameInput.value.trim();
      
      if (names.length >= 100) {
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
        newNameInput.placeholder = '–ú–∞–∫—Å–∏–º—É–º 100 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤';
        newNameInput.value = '';
        
        setTimeout(() => {
          newNameInput.placeholder = '–ù–æ–≤—ã–π –≥–æ–Ω—â–∏–∫';
          newNameInput.style.borderColor = 'rgba(79,70,229,0.28)';
          newNameInput.style.background = 'rgba(255,255,255,0.96)';
        }, 2000);
        return;
      }
      
      if (!v || v.length === 0) {
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
        newNameInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª';
        
        setTimeout(() => {
          newNameInput.placeholder = '–ù–æ–≤—ã–π –≥–æ–Ω—â–∏–∫';
          if (!newNameInput.value.trim()) {
            newNameInput.style.borderColor = 'rgba(79,70,229,0.28)';
            newNameInput.style.background = 'rgba(255,255,255,0.96)';
          }
        }, 2000);
        return;
      }

      const dup = names.some((n) => n.toLowerCase() === v.toLowerCase());
      if (dup) {
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
        newNameInput.placeholder = '–¢–∞–∫–æ–π –≥–æ–Ω—â–∏–∫ —É–∂–µ –µ—Å—Ç—å';
        newNameInput.value = '';
        
        setTimeout(() => {
          newNameInput.placeholder = '–ù–æ–≤—ã–π –≥–æ–Ω—â–∏–∫';
          newNameInput.style.borderColor = 'rgba(79,70,229,0.28)';
          newNameInput.style.background = 'rgba(255,255,255,0.96)';
        }, 2000);
        return;
      }

      newNameInput.value = '';
      newNameInput.placeholder = '–ù–æ–≤—ã–π –≥–æ–Ω—â–∏–∫';
      newNameInput.style.borderColor = 'rgba(79,70,229,0.28)';
      newNameInput.style.background = 'rgba(255,255,255,0.96)';

      names.push(v);
      saveNames();

      carChoice[v] = Object.keys(carChoice).length % carEmojis.length;
      saveCarChoice();

      probabilities[v] = 1 / names.length;
      normalizeProbabilities();
      saveProbabilities();

      createNameInputs();
      createRaceTrack();
    }

    addNameBtn.addEventListener('click', addNewParticipant);
    newNameInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') addNewParticipant();
    });
    equalizeBtn.addEventListener('click', equalizeProbabilities);

    function createRaceTrack() {
      raceTrack.querySelectorAll('.lane').forEach((lane) => lane.remove());
      racersNames.innerHTML = '';
      racers = [];

      names.forEach((name, idx) => {
        const nameLabel = document.createElement('div');
        nameLabel.className = 'racer-name-label';
        nameLabel.textContent = name;
        racersNames.appendChild(nameLabel);

        const lane = document.createElement('div');
        lane.className = 'lane';

        const car = document.createElement('div');
        car.className = 'car';
        car.textContent = carEmojis[getCarIndex(name, idx)];
        car.title = '–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å –º–∞—à–∏–Ω–∫—É';

        car.addEventListener('click', (e) => {
          e.stopPropagation();
          if (isRacing) return;
          const next = cycleCar(name);
          car.textContent = carEmojis[next];
          car.classList.remove('pick');
          void car.offsetWidth;
          car.classList.add('pick');
        });

        const carNameLabel = document.createElement('div');
        carNameLabel.className = 'car-name-label';
        carNameLabel.textContent = name;

        lane.appendChild(car);
        lane.appendChild(carNameLabel);
        raceTrack.appendChild(lane);

        const traits = {
          baseSpeed: 1.1 + Math.random() * 0.18,
          jitter: 0.97 + Math.random() * 0.07,
          aeroDrag: 0.98 + Math.random() * 0.04,
          surgeChance: 0.02 + Math.random() * 0.05,
          surgePower: 1.10 + Math.random() * 0.25
        };

        racers.push({
          name,
          car,
          lane,
          nameLabel,
          carNameLabel,
          position: 30,
          speed: 0,
          finished: false,
          finishTime: null,
          isWinner: false,
          isChallenger: false,
          scenario: null,
          traits
        });
      });
    }

    function createSmoke(car, lane) {
      const smoke = document.createElement('div');
      smoke.className = 'smoke';
      smoke.style.left = car.style.left;
      smoke.style.top = '50%';
      smoke.style.transform = 'translateY(-50%)';
      lane.appendChild(smoke);
      setTimeout(() => smoke.remove(), 1000);
    }

    function createCelebrationWords() {
      const words = [
        '–ü–û–õ–ù–´–ô –ì–ê–ó', '–ü–û–ë–ï–î–ê', '–ß–ï–ú–ü–ò–û–ù', '–†–ï–ö–û–†–î', '–¢–£–†–ë–û', '–°–ö–û–†–û–°–¢–¨',
        '–û–ì–û–ù–¨', '–õ–ï–ì–ï–ù–î–ê', '–§–û–†–°–ê–ñ', '–ë–´–°–¢–†–ï–ï –í–°–ï–•', '–¢–û–ü –ì–û–ù–©–ò–ö', '–î–†–ê–ô–í',
        '–ñ–ñ–Å–®–¨', '–ú–û–©–ù–û', '–í–ò–†–ê–ñ', '–ë–ï–ó–ë–ê–®–ï–ù–ù–û', '–ú–ï–ì–ê –°–ö–û–†–û–°–¢–¨', '–ö–†–ê–°–ê–í–ê'
      ];

      const isMobile = window.innerWidth <= 768;
      const cols = isMobile ? 3 : 4;
      const rows = isMobile ? 4 : 3;
      const positions = [];

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          positions.push({ left: (c + 0.5) * (100 / cols), top: (r + 0.5) * (100 / rows) });
        }
      }

      positions.sort(() => Math.random() - 0.5);

      const count = isMobile ? 8 : 12;
      for (let i = 0; i < count; i++) {
        setTimeout(() => {
          const w = document.createElement('div');
          w.className = 'celebration-word';
          w.textContent = words[Math.floor(Math.random() * words.length)];
          const pos = positions[i % positions.length];
          w.style.left = (pos.left + (Math.random() - 0.5) * 10) + '%';
          w.style.top = (pos.top + (Math.random() - 0.5) * 10) + '%';
          w.style.animationDelay = (Math.random() * 0.3) + 's';
          animationsLayer.appendChild(w);
          setTimeout(() => w.remove(), 4500);
        }, i * 120);
      }
    }

    function createCelebrationEmojis() {
      const emojis = ['üèÜ', 'ü•á', 'üéâ', 'üéä', '‚≠ê', '‚ú®', 'üí®', 'üî•', 'üèÅ', 'üëè', 'üí•', '‚ö°'];
      const isMobile = window.innerWidth <= 768;
      const count = isMobile ? 15 : 25;

      for (let i = 0; i < count; i++) {
        setTimeout(() => {
          const e = document.createElement('div');
          e.className = 'celebration-emoji';
          e.textContent = emojis[Math.floor(Math.random() * emojis.length)];
          e.style.left = (Math.random() * 100) + '%';
          e.style.top = (Math.random() * 100) + '%';
          e.style.animationDelay = (Math.random() * 0.5) + 's';
          animationsLayer.appendChild(e);
          setTimeout(() => e.remove(), 3500);
        }, i * 80);
      }
    }

    function createConfetti() {
      const cs = ['#ff006e', '#fb5607', '#ffbe0b', '#8338ec', '#3a86ff', '#06ffa5'];
      const isMobile = window.innerWidth <= 768;
      const count = isMobile ? 80 : 160;

      for (let i = 0; i < count; i++) {
        setTimeout(() => {
          const d = document.createElement('div');
          d.className = 'confetti';
          d.style.left = (Math.random() * 100) + '%';
          d.style.top = '0';
          d.style.background = cs[Math.floor(Math.random() * cs.length)];
          d.style.width = (6 + Math.random() * 12) + 'px';
          d.style.height = (6 + Math.random() * 12) + 'px';
          d.style.animationDelay = (Math.random() * 0.5) + 's';
          d.style.animationDuration = (2 + Math.random() * 2) + 's';
          d.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
          animationsLayer.appendChild(d);
          setTimeout(() => d.remove(), 4000);
        }, i * 12);
      }
    }

    async function showTrafficLight() {
      trafficLight.classList.add('active');
      const circles = trafficLight.querySelectorAll('.traffic-light-circle');

      circles[0].classList.add('active');
      playSound(400, 0.3, 0.2);
      await new Promise((r) => setTimeout(r, 1000));

      circles[1].classList.add('active');
      playSound(500, 0.3, 0.2);
      await new Promise((r) => setTimeout(r, 1000));

      circles[0].classList.remove('active');
      circles[1].classList.remove('active');
      circles[2].classList.add('active');
      playHornSound();
      await new Promise((r) => setTimeout(r, 500));

      trafficLight.classList.remove('active');
      circles[2].classList.remove('active');
    }

    async function finishRace(winner) {
      winner.car.classList.add('winner');
      playHornSound();

      const shakeTarget = document.querySelector('.race-container');
      shakeTarget.classList.add('shake');
      setTimeout(() => shakeTarget.classList.remove('shake'), 600);

      const announcement = document.createElement('div');
      announcement.className = 'winner-announcement';
      announcement.innerHTML = `
        <div class="winner-announcement-content">
          <div class="winner-announcement-emoji">üéâ</div>
          <div class="winner-announcement-name">${winner.name}</div>
          <div class="winner-announcement-emoji">üéâ</div>
        </div>
      `;
      document.body.appendChild(announcement);

      setTimeout(() => {
        announcement.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        announcement.style.opacity = '0';
        announcement.style.transform = 'translate(-50%, -50%) scale(0.9)';
        setTimeout(() => announcement.remove(), 500);
      }, 4000);

      createConfetti();
      createCelebrationEmojis();
      createCelebrationWords();

      await new Promise((r) => setTimeout(r, 500));
      resultBox.style.display = 'flex';
      resultText.innerHTML = `<div class="result-text">üèÜ –ü–û–ë–ï–î–ò–¢–ï–õ–¨: ${winner.name}! üèÅ</div>`;

      setTimeout(() => {
        winner.car.classList.remove('winner');
        const isMobile = window.innerWidth <= 918;
        winner.car.style.fontSize = isMobile ? '28px' : '35px';
        isRacing = false;
        setUILocked(false);
      }, 7000);
    }

    async function startRace() {
      Object.keys(probabilities).forEach((n) => { if (!names.includes(n)) delete probabilities[n]; });
      names.forEach((n) => { if (!(n in probabilities)) probabilities[n] = 1 / names.length; });
      normalizeProbabilities();
      clampProbabilitiesMin();
      saveProbabilities();

      if (isRacing) return;
      isRacing = true;
      setUILocked(true);

      resultText.innerHTML = '';
      resultBox.style.display = 'none';

      racers.forEach((r) => {
        r.position = 30;
        r.speed = 0;
        r.finished = false;
        r.finishTime = null;
        r.isWinner = false;
        r.isChallenger = false;
        r.scenario = null;
        r.car.classList.remove('winner');
        r.car.style.left = '30px';
        const isMobile = window.innerWidth <= 918;
        r.car.style.fontSize = isMobile ? '28px' : '35px';
        if (r.carNameLabel) {
          r.carNameLabel.style.left = '30px';
        }
      });

      await showTrafficLight();

      const trackWidth = raceTrack.offsetWidth;
      const isMobile = window.innerWidth <= 918;
      const finishPosition = trackWidth - (isMobile ? 50 : 100);
      const halfwayPoint = (finishPosition - 30) / 2 + 30;

      const rnd = Math.random();
      let acc = 0;
      let winnerName = names[names.length - 1];

      for (const n of names) {
        acc += (probabilities[n] || (1 / names.length));
        if (rnd < acc) { winnerName = n; break; }
      }

      const winnerRacer = racers.find((r) => r.name === winnerName);
      const others = racers.filter((r) => r.name !== winnerName);

      const roll = Math.random();
      const scenario = roll < 0.33 ? 1 : (roll < 0.66 ? 2 : 3);

      winnerRacer.isWinner = true;
      winnerRacer.scenario = scenario;

      let challengerRacer = null;
      if (others.length) {
        challengerRacer = others[Math.floor(Math.random() * others.length)];
        challengerRacer.isChallenger = true;
      }

      const raceStartTs = Date.now();
      others.forEach((r) => {
        r.phasePeriod = 1200 + Math.random() * 2200;
        r.phaseShift = Math.random() * r.phasePeriod;
        r.phaseBoost = 1.00 + Math.random() * 0.25;
      });

      let halfwayReached = false;
      const startTime = Date.now();
      let engineIntervalId = setInterval(playEngineSound, 200);
      let firstFinisher = null;

      function raceLoop() {
        const elapsed = Date.now() - startTime;

        if (!halfwayReached) {
          const maxPos = Math.max(...racers.map((r) => r.position));
          if (maxPos >= halfwayPoint) halfwayReached = true;
        }

        racers.forEach((r) => {
          if (r.finished) return;

          const beforeHalfway = !halfwayReached;

          let v = 1.08;

          const t = Date.now() - raceStartTs + (r.phaseShift || 0);
          const phase = r.phasePeriod ? (Math.sin((2 * Math.PI * t) / r.phasePeriod) * 0.5 + 0.5) : 0;
          const tempoBoost = 1 + (phase * ((r.phaseBoost || 1.0) - 1));
          const surge = (Math.random() < (r.traits?.surgeChance || 0)) ? (r.traits?.surgePower || 1) : 1;

          v *= (r.traits?.baseSpeed || 1.0);
          v *= (r.traits?.jitter || 1.0);
          v *= (r.traits?.aeroDrag || 1.0);
          v *= tempoBoost;
          v *= surge;
          v *= 0.90 + Math.random() * 0.10;

          if (r.isWinner) {
            if (scenario === 1) {
              v *= beforeHalfway ? 1.40 : 1.35;
            } else if (scenario === 2) {
              v *= beforeHalfway ? 1.25 : 1.70;
            } else {
              v *= beforeHalfway ? 0.85 : 2.10;
            }
          } else if (r.isChallenger) {
            if (scenario === 1) v *= beforeHalfway ? 1.15 : 1.10;
            else if (scenario === 2) v *= beforeHalfway ? 1.30 : 1.20;
            else v *= beforeHalfway ? 1.35 : 1;
          } else {
            if (scenario === 1 || scenario === 2) v *= 0.70 + Math.random() * 0.30;
            else v *= 0.80 + Math.random() * 0.27;
          }

          if (r.isWinner && halfwayReached) {
            const leader = racers.filter((x) => !x.finished && !x.isWinner).sort((a, b) => b.position - a.position)[0];
            if (leader && leader.position > r.position) {
              const gap = leader.position - r.position;
              r.position += gap * 0.20 + v * 0.5;
              const progress = ((r.position - 30) / (finishPosition - 30)) * 100;
              if (progress > 75) r.position += v * 0.35;
            }
          }

          if (r.isWinner) {
            const progress = ((r.position - 30) / (finishPosition - 30)) * 100;
            if (progress > 85) {
              const second = racers.filter((x) => !x.finished && !x.isWinner).sort((a, b) => b.position - a.position)[0];
              if (second) {
                const distToFinish = finishPosition - r.position;
                const gap = r.position - second.position;
                const reqGap = distToFinish * 0.10;
                if (gap < reqGap) r.position += (reqGap - gap) * 0.5 + v * 0.3;
              }
            }
          }

          r.position += v;
          r.car.style.left = r.position + 'px';
          if (r.carNameLabel) {
            r.carNameLabel.style.left = r.position + 'px';
          }

          let smokeChance = 0.08;
          if (r.isWinner && halfwayReached) {
            smokeChance = (r.scenario === 3) ? 0.3 : (r.scenario === 2 ? 0.2 : 0.12);
          }
          if (Math.random() < smokeChance) createSmoke(r.car, r.lane);

          // –ù–∞ –º–æ–±–∏–ª–∫–∞—Ö –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π –º–∞—à–∏–Ω–∫–∏, –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ - –ª–µ–≤—ã–π
          const carWidth = isMobile ? 19 : 0; // –®–∏—Ä–∏–Ω–∞ –º–∞—à–∏–Ω–∫–∏ –Ω–∞ –º–æ–±–∏–ª–∫–µ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–≤–Ω–∞ font-size
          if ((r.position + carWidth) >= finishPosition && !r.finished) {
            r.finished = true;
            r.finishTime = elapsed;
            r.position = finishPosition + 10;

            if (!firstFinisher) {
              firstFinisher = r;
            }
          }
        });

        if (firstFinisher) {
          clearInterval(engineIntervalId);
          const trueWinner = winnerRacer || firstFinisher;
          finishRace(trueWinner);
        } else {
          requestAnimationFrame(raceLoop);
        }
      }

      raceLoop();
    }

    startRaceBtn.addEventListener('click', startRace);

    (function() {
      let unlocked = false;
      function unlock() {
        try {
          if (audioCtx.state === 'suspended') {
            audioCtx.resume();
          }
        } catch(e) {}
        if (!unlocked) {
          unlocked = true;
          window.removeEventListener('touchstart', unlock, {passive: true});
          window.removeEventListener('pointerdown', unlock, {passive: true});
          window.removeEventListener('click', unlock, {passive: true});
        }
      }
      window.addEventListener('touchstart', unlock, {passive: true});
      window.addEventListener('pointerdown', unlock, {passive: true});
      window.addEventListener('click', unlock, {passive: true});
    })();

    window.addEventListener('storage', (e) => {
      if (e.key === NAMES_KEY || e.key === PROB_KEY) {
        try {
          const savedNames = JSON.parse(localStorage.getItem(NAMES_KEY) || '[]');
          if (Array.isArray(savedNames) && savedNames.length) names = savedNames;
        } catch (_) {}

        initProbabilities();
        createNameInputs();
        createRaceTrack();
      }
    });

    function init() {
      initProbabilities();
      createNameInputs();
      createRaceTrack();
    }

    init();
  </script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "–ì–æ–Ω–∫–∏ –Ω–∞ –º–∞—à–∏–Ω–∫–∞—Ö",
    "applicationCategory": "GameApplication",
    "operatingSystem": "Web",
    "url": "https://randomhost.online/racing.html",
    "description": "–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –æ–Ω–ª–∞–π–Ω-–∏–≥—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ –≥–æ–Ω–æ–∫ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏.",
    "inLanguage": "ru",
    "publisher": {
      "@type": "Organization",
      "name": "–†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä-–∏–≥—Ä—ã",
      "url": "https://randomhost.online"
    }
  }
  </script>

  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){
      m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      for (var j = 0; j < document.scripts.length; j++) {
        if (document.scripts[j].src === r) { return; }
      }
      k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document,'script','https://mc.yandex.ru/metrika/tag.js','ym');
  ym(104849796, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
  </script>
<noscript><div><img src="https://mc.yandex.ru/watch/104849796" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
</body>
</html>
