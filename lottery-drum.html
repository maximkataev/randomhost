<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="title" content="–õ–æ—Ç–æ—Ç—Ä–æ–Ω –õ–æ—Ç–µ—Ä–µ—è –û–Ω–ª–∞–π–Ω ‚Äî –†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä –£–¥–∞—á–∏">
  <meta name="description" content="üé± –û–Ω–ª–∞–π–Ω –ª–æ—Ç–æ—Ç—Ä–æ–Ω-–ª–æ—Ç–µ—Ä–µ—è –∏ –∫–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã. –ü—Ä–æ–≤–æ–¥–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∏, –≤—ã–±–∏—Ä–∞–π –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –∏ —Ç–µ—Å—Ç–∏—Ä—É–π —É–¥–∞—á—É! –ë—ã—Å—Ç—Ä–æ, –≤–µ—Å–µ–ª–æ –∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.">
  <meta name="keywords" content="–ª–æ—Ç–æ—Ç—Ä–æ–Ω, –ª–æ—Ç–µ—Ä–µ—è, –∫–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã, —Ñ–æ—Ä—Ç—É–Ω–∞, —Ä–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä, –æ–Ω–ª–∞–π–Ω, —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä, –∏–≥—Ä–∞ –Ω–∞ —É–¥–∞—á—É, daily lottery, bingo online">
  <title>–õ–æ—Ç–æ—Ç—Ä–æ–Ω –õ–æ—Ç–µ—Ä–µ—è</title>
  
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f3b1.svg" type="image/svg+xml">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      display:flex; align-items:center; justify-content:center;
      min-height:100vh; padding:20px;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      font-family:'Montserrat',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
    }
    .main-container{ display:flex; gap:40px; align-items:center; max-width:1200px; width:100%; }
    .game-container{ flex:1; text-align:center; perspective:1000px; }

    .settings-panel{
      width: 450px;
      padding: 30px;
      border-radius: 20px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .settings-title {
      color: #fff;
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .settings-actions {
      display: flex;
      gap: 8px;
    }
    .equalize-btn{
      padding: 8px 18px;
      background: linear-gradient(135deg, rgba(102,126,234,0.8), rgba(118,75,162,0.8));
      color: #fff;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: all .3s ease;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      letter-spacing: 0.5px;
    }
    .equalize-btn:hover{
      background: linear-gradient(135deg, rgba(118,75,162,1), rgba(102,126,234,1));
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
      border-color: rgba(255,255,255,0.5);
    }
    .equalize-btn:active{
      transform: translateY(0px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .names-list{
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
      max-height: 500px;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding-right: 5px;
    }
    .names-list.full-height {
      max-height: none;
      overflow-y: visible;
    }
    .name-item{ display:flex; gap:8px; align-items:center; }
    .name-input{
      flex:1; padding:10px 15px; border:2px solid rgba(255,255,255,0.2);
      border-radius:10px; background:rgba(255,255,255,0.1); color:#fff; font-size:16px; transition:.3s;
    }
    .name-input:focus{ outline:none; border-color:rgba(255,255,255,0.5); background:rgba(255,255,255,0.2); }
    .name-input::placeholder{ color:rgba(255,255,255,0.5); }
    .name-input.error-state {
      border-color: #ef4444 !important;
      background: rgba(239,68,68,0.1) !important;
    }
    .name-input.error-state::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    .remove-btn{
      padding:8px 13px; background:rgba(239,68,68,.7); color:#fff; border:none; border-radius:8px;
      cursor:pointer; font-size:18px; transition:.3s;
    }
    .remove-btn:hover{ background:rgba(239,68,68,.9); transform:scale(1.1); }

    .add-name-container{ display:flex; gap:10px; margin-top:15px; }
    .add-btn-small{
      padding:10px 15px; background:rgba(34,197,94,.7); color:#fff; border:none; border-radius:10px;
      cursor:pointer; font-size:20px; transition:.3s;
    }
    .add-btn-small:hover{ background:rgba(34,197,94,.9); transform:scale(1.1); }

    h1{
      color:#fff; font-size:48px; margin-bottom:30px; text-shadow:2px 2px 4px rgba(0,0,0,0.3);
      animation:glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow{
      from{ text-shadow:2px 2px 4px rgba(0,0,0,0.3),0 0 10px rgba(255,255,255,.3); }
      to  { text-shadow:2px 2px 4px rgba(0,0,0,0.3),0 0 20px rgba(255,255,255,.5); }
    }

    /* ===== DESKTOP –ú–ï–ù–Æ ===== */
    .top-buttons {
      position: fixed; top: 20px; left: 20px; display: flex; gap: 12px; z-index: 1000;
    }
    .top-btn {
      background: linear-gradient(135deg, rgba(102,126,234,0.95), rgba(118,75,162,0.95));
      color: #fff; text-decoration: none; padding: 10px 18px; border-radius: 10px;
      font-size: 16px; font-weight: 600; transition: 0.25s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .top-btn:hover { background: linear-gradient(135deg, rgba(118,75,162,1), rgba(102,126,234,1)); transform: translateY(-2px); }

    /* ===== MOBILE –ú–ï–ù–Æ (–°–ö–†–´–¢–û –ù–ê DESKTOP) ===== */
    .menu-container {
      display: none;
    }

    .jar-container{ position:relative; width:300px; height:400px; margin:0 auto 50px; }
    .jar{
      position:absolute; inset:0; border-radius:20px 20px 60px 60px;
      background:linear-gradient(to bottom,rgba(255,255,255,.1),rgba(255,255,255,.05) 50%,rgba(255,255,255,.1));
      border:3px solid rgba(255,255,255,.3);
      box-shadow:0 0 30px rgba(0,0,0,.2), inset 0 0 20px rgba(255,255,255,.1);
      overflow:hidden; transform-style:preserve-3d;
    }
    .jar.shaking{ animation:shake .5s ease-in-out infinite; }
    @keyframes shake{ 0%,100%{transform:rotate(0)} 25%{transform:rotate(-5deg)} 75%{transform:rotate(5deg)} }

    .ball{
      position:absolute; width:60px; height:60px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; text-align:center;
      color:#fff; font-weight:300; font-size:8px; line-height:1.1;
      text-shadow:1px 1px 2px rgba(0,0,0,.5);
      box-shadow: inset -5px -5px 10px rgba(0,0,0,.3), inset 5px 5px 10px rgba(255,255,255,.3), 2px 2px 5px rgba(0,0,0,.2);
      user-select:none; padding:8px; will-change:transform,left,top; overflow:hidden; word-break:break-word;
    }
    .ball > div { width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    .ball.extracting{ animation:extractBall 2s linear forwards; z-index:100; }
    @keyframes extractBall{ 0%{ transform:scale(1) translateY(0) rotate(0deg); opacity:1; } 100%{ transform:scale(4) translateY(-400px) rotate(1080deg); opacity:0; } }

    .selected-ball-container{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); display:none; z-index:1000; }
    .selected-ball-container.show{ display:block; }
    .selected-ball{
      width:220px; height:220px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; font-size:28px; line-height:1.3;
      text-shadow:4px 4px 8px rgba(0,0,0,.6);
      box-shadow:0 0 100px rgba(255,255,255,1), 0 0 60px rgba(255,255,255,0.8), inset -20px -20px 40px rgba(0,0,0,.4), inset 20px 20px 40px rgba(255,255,255,.4);
      padding:30px; box-sizing:border-box; animation:ballAppear 2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .selected-ball > div{ display:flex; align-items:center; justify-content:center; width:100%; height:100%; text-align:center; }
    @keyframes ballAppear{
      0%{ transform:translateY(-500px) scale(0.2) rotate(-360deg); opacity:0; filter:blur(15px); }
      30%{ transform:translateY(50px) scale(1.3) rotate(180deg); opacity:1; filter:blur(0); }
      50%{ transform:translateY(-25px) scale(0.9) rotate(270deg); }
      70%{ transform:translateY(15px) scale(1.1) rotate(340deg); }
      85%{ transform:translateY(-8px) scale(0.98) rotate(355deg); }
      100%{ transform:translateY(0) scale(1) rotate(360deg); opacity:1; filter:blur(0); }
    }
    .selected-ball.pulsing{
      animation:ballAppear 2s cubic-bezier(0.68, -0.55, 0.265, 1.55), pulse 2.5s ease-in-out 2s infinite;
    }
    @keyframes pulse{
      0%,100%{ transform:scale(1) rotate(360deg); box-shadow:0 0 100px rgba(255,255,255,1), 0 0 60px rgba(255,255,255,0.8), inset -20px -20px 40px rgba(0,0,0,.4), inset 20px 20px 40px rgba(255,255,255,.4); }
      50%{ transform:scale(1.1) rotate(360deg); box-shadow:0 0 140px rgba(255,255,255,1), 0 0 90px rgba(255,255,255,1), inset -20px -20px 40px rgba(0,0,0,.4), inset 20px 20px 40px rgba(255,255,255,.4); }
    }

    .probability-input.manual {
      border-color: #FBBF24;           /* amber-400 */
      box-shadow: 0 0 0 3px rgba(251,191,36,.25);
    }

    .headers-row { display:flex; align-items:center; gap:0; margin-bottom:10px; padding:0 5px; }
    .header-name { flex:1; color:rgba(255,255,255,0.7); font-size:14px; font-weight:600; text-align:left; }
    .header-probability { color:rgba(255,255,255,0.7); font-size:14px; font-weight:600; text-align:center; width:130px; flex-shrink:0; }
    .header-remove { width:44px; }

    .probability-input {
      width: 55px; padding: 4px; background: rgba(255,255,255,0.1); color: #ffd43b;
      border: 2px solid rgba(255,212,59,0.3); border-radius: 5px; text-align: center;
      font-weight: 800; font-size: 14px; transition: .2s;
    }
    .probability-input:focus { outline: none; border-color: rgba(255,212,59,0.6); background: rgba(255,255,255,0.15); }
    .probability-input.error { border-color: rgba(239,68,68,0.8); background: rgba(239,68,68,0.2); }

    .probability-controls { display:flex; gap:5px; width:120px; flex-shrink:0; }
    .prob-btn { padding:5px 10px; background:rgba(255,255,255,0.2); color:#fff; border:none; border-radius:5px; cursor:pointer; font-size:14px; font-weight:600; transition:.2s; }
    .prob-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
    .prob-btn:active { transform: scale(0.95); }

    .confetti { position: fixed; width: 10px; height: 10px; z-index: 0; pointer-events: none; animation: confetti-fall 3s ease-out forwards; }
    @keyframes confetti-fall{ 0%{ transform: translateY(0) rotate(300deg); opacity:1;} 100%{ transform: translateY(100vh) rotate(720deg); opacity:0;} }

    .controls{ display:flex; gap:20px; justify-content:center; margin-top:30px; }
    button{
      padding:15px 30px; font-size:18px; font-weight:800; border:none; border-radius:50px;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; cursor:pointer;
      box-shadow:0 4px 15px rgba(0,0,0,.2); transition:.3s; position:relative; overflow:hidden;
    }
    button:before{ content:''; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background:rgba(255,255,255,.3); transform:translate(-50%,-50%); transition:width .6s,height .6s; }
    button:hover:before{ width:300px; height:300px; }
    button:hover{ transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.3); }
    button:active{ transform:translateY(0); }
    button:disabled{
      opacity:.5;
      cursor:not-allowed !important;
      pointer-events:none;
    }
    input:disabled{
      opacity:.5;
      cursor:not-allowed !important;
      pointer-events:none;
    }
    .settings-panel {
      transition: opacity 0.3s ease;
    }

    .result{ margin-top:30px; padding:20px; border-radius:20px; background:rgba(255,255,255,.1); backdrop-filter:blur(10px); min-height:60px; display:flex; align-items:center; justify-content:center; }
    .result-text{ font-size:28px; color:#fff; font-weight:800; text-shadow:2px 2px 4px rgba(0,0,0,.3); opacity:0; animation:fadeInScale .8s forwards; }
    @keyframes fadeInScale{ from{opacity:0; transform:scale(.5)} to{opacity:1; transform:scale(1)} }

    .drumroll-overlay{ position:fixed; inset:0; background:radial-gradient(circle,transparent 0%,rgba(0,0,0,.9) 100%); display:none; z-index:999; pointer-events:none; opacity: 0.5; }
    .drumroll-overlay.active{ display:block; }
    .drumroll-overlay.flash{ animation:whiteFlash 0.5s ease-out !important; }
    @keyframes whiteFlash{ 0%{ background:rgba(255,255,255,1); opacity:1; } 100%{ background:radial-gradient(circle,transparent 0%,rgba(0,0,0,.9) 100%); opacity:0; } }

    .countdown{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:120px; color:#fff; font-weight:800; text-shadow:0 0 50px rgba(255,255,255,.8); display:none; z-index:1001; }
    .countdown.show{ display:block; animation:countdownPulse 1s ease-in-out; }
    @keyframes countdownPulse{ 0%{ transform:translate(-50%,-50%) scale(0); opacity:0 } 50%{ transform:translate(-50%,-50%) scale(1.2); opacity:1 } 100%{ transform:translate(-50%,-50%) scale(.8); opacity:0 } }

    @keyframes screenShake{
      0%, 100% { transform: translate(0, 0); }
      10% { transform: translate(-5px, 2px); }
      20% { transform: translate(5px, -2px); }
      30% { transform: translate(-3px, 3px); }
      40% { transform: translate(3px, -3px); }
      50% { transform: translate(-2px, 2px); }
      60% { transform: translate(2px, -2px); }
      70% { transform: translate(-3px, 3px); }
      80% { transform: translate(3px, -3px); }
      90% { transform: translate(-1px, 1px); }
    }
    body.shake { animation: screenShake 0.5s ease-in-out; }

    .celebration-emoji { position: fixed; font-size: 60px; z-index: 998; pointer-events: none; animation: emojiCelebrate 3s ease-out forwards; }
    .celebration-word { position: fixed; font-size: 40px; font-weight: 800; color: #fff; text-shadow: 3px 3px 6px rgba(0,0,0,0.5); z-index: 998; pointer-events: none; opacity: 0.7; animation: wordFloat 4s ease-out forwards; }
    @keyframes wordFloat { 0% { transform: scale(0) translateY(0) rotate(-15deg); opacity: 0; } 15% { transform: scale(1.2) translateY(-20px) rotate(5deg); opacity: 0.9; } 50% { opacity: 0.8; } 100% { transform: scale(0.8) translateY(-150px) rotate(15deg); opacity: 0; } }
    @keyframes emojiCelebrate { 0% { transform: scale(0) rotate(0deg); opacity: 0; } 20% { transform: scale(1.5) rotate(180deg); opacity: 1; } 80% { opacity: 1; } 100% { transform: scale(0.5) rotate(360deg); opacity: 0; } }

    /* --- Mobile tweaks --- */
    @media (max-width: 900px) {
      :root {
        --pad: 12px;
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-left: env(safe-area-inset-left, 0px);
      }
      body { padding: calc(66px + var(--safe-top) + 15px) var(--safe-right) calc(20px + var(--safe-bottom)) var(--safe-left); }
      .main-container { flex-direction: column; gap: 18px; max-width: 100%; align-items: stretch; }

      /* –°–∫—Ä—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
      .top-buttons { display: none; }

      /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é */
      .menu-container {
        display: block;
        position: fixed;
        top: var(--safe-top);
        left: var(--safe-left);
        right: var(--safe-right);
        z-index: 1000;
        padding: 12px 16px;
        background: linear-gradient(180deg, rgba(102,126,234,0.95) 0%, rgba(118,75,162,0.85) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }

      .menu-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .burger-btn {
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 4px;
        transition: all 0.3s ease;
        min-width: 44px;
        min-height: 44px;
        align-items: center;
        justify-content: center;
      }

      .burger-btn:hover {
        background: rgba(255,255,255,0.3);
      }

      .burger-btn span {
        display: block;
        width: 24px;
        height: 3px;
        background: #fff;
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      .burger-btn.active span:nth-child(1) {
        transform: rotate(45deg) translateY(7px);
      }

      .burger-btn.active span:nth-child(2) {
        opacity: 0;
      }

      .burger-btn.active span:nth-child(3) {
        transform: rotate(-45deg) translateY(-7px);
      }

      .menu-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, rgba(102,126,234,0.98) 0%, rgba(118,75,162,0.98) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .menu-dropdown.active {
        max-height: 500px;
      }

      .menu-dropdown a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        color: #fff;
        text-decoration: none;
        font-size: 16px;
        font-weight: 600;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        transition: background 0.2s ease;
        min-height: 56px;
      }

      .menu-dropdown a:last-child {
        border-bottom: none;
      }

      .menu-dropdown a:hover {
        background: rgba(255,255,255,0.15);
      }

      .menu-dropdown a:active {
        background: rgba(255,255,255,0.25);
      }
      .game-container { order: -1; }
      .jar-container { width: min(92vw, 480px); aspect-ratio: 3 / 4; height: auto; margin: 8px auto 22px; }
      .jar { border-width: 2px; border-radius: 16px 16px 46px 46px; }
      h1 { font-size: clamp(22px, 6vw, 34px); margin-bottom: 14px; }
      .settings-panel { width: 100%; max-width: 600px; padding: 20px 16px; margin: 0 auto; border-radius: 16px; }

      .settings-header {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        margin-bottom: 10px;
      }

      .settings-actions {
        display: flex;
        justify-content: space-between;
        width: 100%;
        gap: 0;
        margin-bottom: 4px;
      }

      .settings-actions .equalize-btn {
        flex: 0 0 70%;
        max-width: 40%;
        padding: 10px 0;
        font-size: 14px;
        text-align: center;
      }

      .headers-row { padding: 0 2px; }
      .header-name { font-size: 13px; }
      .header-probability {
        width: 170px;
        font-size: 13px;
        flex: 0 0 170px;
        max-width: 170px;
        display: flex;
        justify-content: center;
        text-align: center;
      }
      .header-remove { width: 40px; }
      .names-list {
        max-height: none;
        overflow-y: visible;
        overflow: visible;
        width: 100%;
        max-width: 100%;
        flex: 1 1 auto;
        padding-right: 2px;
      }
      .name-item {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
      }
      .name-input {
        min-width: 0;
        padding: 12px 10px;
        min-height: 48px;
        flex: 1 1 auto;
        font-size: 15px;
      }
      .probability-controls {
        flex: 0 0 130px;
        max-width: 130px;
        gap: 4px;
        flex-shrink: 0;
      }
      .probability-input {
        flex: 0 0 50px;
        width: 50px;
        min-width: 50px;
        max-width: 50px;
        font-size: 13px;
        padding: 6px 4px;
      }
      .prob-btn {
        flex: 0 0 44px;
        width: 44px;
        min-width: 44px;
        max-width: 44px;
        min-height: 44px;
        padding: 6px 0;
        font-size: 13px;
      }
      .remove-btn {
        flex: 0 0 48px;
        width: 48px;
        min-width: 48px;
        max-width: 48px;
        min-height: 48px;
        margin-left: 14px;
        padding: 8px 12px;
        font-size: 16px;
      }
      .add-name-container {
        display: flex;
        gap: 8px;
        margin-top: 15px;
      }
      .add-name-container .name-input {
        flex: 0 1 calc(100% - 60px);
        max-width: calc(100% - 60px);
      }
      .add-btn-small {
        min-width: 52px;
        min-height: 52px;
        flex-shrink: 0;
        padding: 10px 14px;
        font-size: 18px;
      }
      .equalize-btn { padding: 8px 12px; font-size: 13px; }
      .controls { gap: 12px; flex-wrap: wrap; padding: 0 6px; margin-top: 16px; justify-content: center; }
      .controls button { flex: 1 1 180px; min-height: 48px; font-size: 16px; border-radius: 40px; }

      /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–º–µ—à–∞—Ç—å" –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
      #mixBtn { display: none; }

      /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–í—ã—Ç—è–Ω—É—Ç—å —à–∞—Ä–∏–∫" */
      #drawBtn { flex: 1 1 100%; max-width: 100%; }
      .result { min-height: 52px; padding: 14px; }
      .result-text { font-size: clamp(18px, 4.8vw, 24px); }
      .selected-ball { width: clamp(160px, 52vw, 220px); height: clamp(160px, 52vw, 220px); font-size: clamp(18px, 4.6vw, 28px); padding: 18px; }
      .countdown { font-size: clamp(56px, 18vw, 120px); }
    }
    @media (hover: none) {
      .top-btn:hover, .prob-btn:hover, .add-btn-small:hover, .remove-btn:hover, button:hover { transform: none !important; }
      button:before { display: none; }
    }
    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
  </style>
</head>
<body>
  <!-- DESKTOP –ú–ï–ù–Æ -->
  <div class="top-buttons">
    <a href="index.html" class="top-btn">üè† –ì–ª–∞–≤–Ω–∞—è</a>
    <a href="wheel-of-fortune.html" class="top-btn">üé° –ö–æ–ª–µ—Å–æ</a>
    <a href="lottery-drum.html" class="top-btn">üé± –õ–æ—Ç–æ—Ç—Ä–æ–Ω</a>
    <a href="crystal-ball.html" class="top-btn">üîÆ –®–∞—Ä</a>
    <a href="plinko.html" class="top-btn">üéØ –ü–ª–∏–Ω–∫–æ</a>
    <a href="racing.html" class="top-btn">üèÅ –ì–æ–Ω–∫–∏</a>
    <a href="trading.html" class="top-btn">üìà –¢—Ä–µ–π–¥–∏–Ω–≥</a>
  </div>

  <!-- MOBILE –ú–ï–ù–Æ -->
  <div class="menu-container">
    <div class="menu-header">
      <button class="burger-btn" id="burgerBtn" aria-label="–ú–µ–Ω—é">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <nav class="menu-dropdown" id="menuDropdown">
      <a href="index.html">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      <a href="wheel-of-fortune.html">üé° –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</a>
      <a href="lottery-drum.html">üé± –õ–æ—Ç–æ—Ç—Ä–æ–Ω</a>
      <a href="crystal-ball.html">üîÆ –ú–∞–≥–∏—á–µ—Å–∫–∏–π –®–∞—Ä</a>
      <a href="plinko.html">üéØ –ü–ª–∏–Ω–∫–æ</a>
      <a href="racing.html">üèÅ –ì–æ–Ω–∫–∏</a>
      <a href="trading.html">üìà –¢—Ä–µ–π–¥–∏–Ω–≥</a>
    </nav>
  </div>

  <div class="main-container">
    <div class="settings-panel">
      <div class="settings-header">
        <h2 class="settings-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
        <div class="settings-actions">
          <button class="equalize-btn" id="equalizeBtn" title="–£—Ä–∞–≤–Ω—è—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏">‚öñÔ∏è –£—Ä–∞–≤–Ω—è—Ç—å</button>
        </div>
      </div>
      <div class="headers-row">
        <div class="header-name">–ò–º—è</div>
        <div class="header-probability">üìä –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</div>
        <div class="header-remove"></div>
      </div>
      <div class="names-list" id="namesList"></div>
      <div class="add-name-container">
        <input type="text" class="name-input" id="newNameInput" placeholder="–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫" maxlength="15">
        <button class="add-btn-small" id="addNameBtn">‚ûï</button>
      </div>
    </div>

    <div class="game-container">
      <h1>–õ–û–¢–û–¢–†–û–ù –õ–û–¢–ï–†–ï–Ø</h1>
      <div class="jar-container"><div class="jar" id="jar"></div></div>
      <div class="controls">
        <button id="mixBtn">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
        <button id="drawBtn">–í—ã—Ç—è–Ω—É—Ç—å —à–∞—Ä–∏–∫</button>
      </div>
      <div class="result"><div id="resultText"></div></div>
    </div>
  </div>

  <div class="drumroll-overlay" id="drumrollOverlay"></div>
  <div class="countdown" id="countdown"></div>
  <div class="selected-ball-container" id="selectedBallContainer">
    <div class="selected-ball" id="selectedBall"></div>
  </div>

<script>
// ===== –û–±—â–∏–µ –∫–ª—é—á–∏ =====
const NAMES_KEY = 'shared_names_v1';
const PROB_KEY = 'shared_probabilities_v2';
const LOCKED_KEY = 'shared_locked_v1';

// ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–º—ë–Ω =====
let names = ['–î–∏–º–∞','–°–∞—à–∞','–ù–∏–∫–∏—Ç–∞','–ú–∞–∫—Å–∏–º','–ö–∏—Ä–∏–ª–ª','–°–µ–º—ë–Ω'];
try {
  const saved = JSON.parse(localStorage.getItem(NAMES_KEY) || '[]');
  if (Array.isArray(saved) && saved.length) {
    // –ï—Å–ª–∏ –±–æ–ª—å—à–µ 10 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10, –Ω–æ –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º localStorage
    names = saved.length > 10 ? saved.slice(0, 10) : saved;
  } else {
    localStorage.setItem(NAMES_KEY, JSON.stringify(names));
  }
} catch(e){}
const saveNames = ()=>{ try{ localStorage.setItem(NAMES_KEY, JSON.stringify(names)); }catch(e){} };

// ===== –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Å —Å–∏—Å—Ç–µ–º–æ–π –ª–æ–∫–æ–≤ =====
let probabilities          = {};
let lockedParticipants     = {};
let hasCustomProbabilities = false;

function initProbabilities() {
  try {
    const saved       = JSON.parse(localStorage.getItem(PROB_KEY)   || '{}');
    const savedLocked = JSON.parse(localStorage.getItem(LOCKED_KEY) || '{}');

    if (saved?.hasCustomProbabilities && saved?.probabilities && Object.keys(saved.probabilities).length) {
      probabilities          = { ...saved.probabilities };
      lockedParticipants     = { ...savedLocked };
      hasCustomProbabilities = true;

      names.forEach((n) => { if (!(n in probabilities)) probabilities[n] = 1 / names.length; });
      Object.keys(probabilities).forEach((n) => { if (!names.includes(n)) delete probabilities[n]; });
      Object.keys(lockedParticipants).forEach((n) => { if (!names.includes(n)) delete lockedParticipants[n]; });

      saveProbabilities();
    } else {
      setEqualProbabilities();
    }
  } catch (_) {
    setEqualProbabilities();
  }
}

function setEqualProbabilities() {
  const p = 1 / (names.length || 1);
  probabilities = {};
  names.forEach((nm) => probabilities[nm] = p);
  lockedParticipants     = {};
  hasCustomProbabilities = false;
  saveProbabilities();
}

function clampProbabilitiesMin(min = 0.001) {
  names.forEach((nm) => { if ((probabilities[nm] ?? 0) < min) probabilities[nm] = min; });
}

function normalizeProbabilities() {
  const vals = names.map((n) => probabilities[n] ?? 0);
  const uniq = [...new Set(vals.map((v) => +v.toFixed(6)))];
  if (uniq.length === 1 && !hasCustomProbabilities) {
    const exact = 1 / (names.length || 1);
    names.forEach((nm) => probabilities[nm] = exact);
    return;
  }

  clampProbabilitiesMin(0.001);

  const sum = names.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
  if (sum > 0 && Math.abs(sum - 1) > 1e-4) {
    const k = 1 / sum;
    names.forEach((nm) => probabilities[nm] = (probabilities[nm] || 0) * k);
  }

  clampProbabilitiesMin(0.001);
}

function saveProbabilities() {
  try {
    const cleanP = {};
    names.forEach((nm) => cleanP[nm] = probabilities[nm] ?? 0);

    const cleanLocked = {};
    names.forEach((nm) => { if (lockedParticipants[nm]) cleanLocked[nm] = true; });

    localStorage.setItem(PROB_KEY, JSON.stringify({
      probabilities: cleanP,
      hasCustomProbabilities
    }));
    localStorage.setItem(LOCKED_KEY, JSON.stringify(cleanLocked));
  } catch (_) {}
}

function getProbabilityPercent(name) {
  if (!hasCustomProbabilities && names.length) return (100 / names.length).toFixed(1);
  return (((probabilities[name] || 0) * 100).toFixed(1));
}

function adjustProbability(name, delta) {
  const cur         = parseFloat(getProbabilityPercent(name)) || 0;
  const maxPossible = 100 - (names.length - 1) * 0.1;
  const next        = Math.max(0.1, Math.min(maxPossible, cur + delta));
  setProbabilityManually(name, next);
  createNameInputs();
  updateBalls();
}

function setProbabilityManually(name, percentValue) {
  if (isNaN(percentValue) || percentValue < 0.1 || percentValue > 99.9) return false;

  hasCustomProbabilities = true;
  const newProb          = percentValue / 100;

  const otherLocked      = names.filter((n) => n !== name && lockedParticipants[n]);
  const lockedTotal      = otherLocked.reduce((s, n) => s + (probabilities[n] || 0), 0);
  const minOthers        = (names.length - 1) * 0.001;

  if (newProb + lockedTotal + minOthers > 1) {
    lockedParticipants = {};
    probabilities[name] = newProb;
    lockedParticipants[name] = true;

    const others  = names.filter((n) => n !== name);
    const remain  = 1 - newProb;
    const share   = remain / (others.length || 1);
    others.forEach((n) => probabilities[n] = share);

    normalizeProbabilities();
    saveProbabilities();
    return true;
  }

  lockedParticipants[name] = true;

  const free   = names.filter((n) => n !== name && !lockedParticipants[n]);
  const locked = names.filter((n) => n !== name && lockedParticipants[n]);

  if (free.length) {
    probabilities[name] = newProb;
    const lockedSum = locked.reduce((s, n) => s + (probabilities[n] || 0), 0) + newProb;
    let remain       = Math.max(0, 1 - lockedSum);

    const freeSum = free.reduce((s, n) => s + (probabilities[n] || 0), 0);
    if (freeSum > 0) {
      const k = remain / freeSum;
      free.forEach((n) => probabilities[n] = (probabilities[n] || 0) * k);
    } else {
      free.forEach((n) => probabilities[n] = remain / free.length);
    }

    free.forEach((n) => { if (probabilities[n] < 0.001) probabilities[n] = 0.001; });
  } else {
    const others = names.filter((n) => n !== name).sort((a, b) => (probabilities[a] || 0) - (probabilities[b] || 0));
    const victim = others[0];
    delete lockedParticipants[victim];

    probabilities[name] = newProb;
    const stillLocked   = names.filter((n) => n !== name && lockedParticipants[n]);
    const lockedSum     = stillLocked.reduce((s, n) => s + (probabilities[n] || 0), 0) + newProb;
    const remain        = 1 - lockedSum;

    probabilities[victim] = Math.max(0.001, remain);
  }

  normalizeProbabilities();
  saveProbabilities();
  return true;
}

function equalizeProbabilities() {
  setEqualProbabilities();
  createNameInputs();
  updateBalls();
}

// ===== UI: —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ =====
const namesList = document.getElementById('namesList');
const addNameBtn = document.getElementById('addNameBtn');
const newNameInput = document.getElementById('newNameInput');
const equalizeBtn = document.getElementById('equalizeBtn');
const burgerBtn = document.getElementById('burgerBtn');
const menuDropdown = document.getElementById('menuDropdown');

// –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Å–µ—Ö –∏–º—ë–Ω
function validateAllNames() {
  let allValid = true;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–º–µ–Ω–∞
  const nameInputs = namesList.querySelectorAll('.name-input');
  nameInputs.forEach(input => {
    const value = input.value.trim();
    // –ò–º—è –≤–∞–ª–∏–¥–Ω–æ –µ—Å–ª–∏: –Ω–µ –ø—É—Å—Ç–æ–µ –ò –Ω–µ –¥–ª–∏–Ω–Ω–µ–µ 15 —Å–∏–º–≤–æ–ª–æ–≤
    if (!value || value.length === 0 || input.value.length > 15) {
      allValid = false;
    }
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
  mixBtn.disabled = !allValid || isDrawing;
  drawBtn.disabled = !allValid || isDrawing;

  return allValid;
}

// –§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI –≤–æ –≤—Ä–µ–º—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞
function setUILocked(locked) {
  mixBtn.disabled = locked;
  drawBtn.disabled = locked;

  addNameBtn.disabled = locked;
  newNameInput.disabled = locked;
  equalizeBtn.disabled = locked;

  const allInputs = namesList.querySelectorAll('.name-input, .probability-input');
  const allButtons = namesList.querySelectorAll('.prob-btn, .remove-btn');

  allInputs.forEach(input => input.disabled = locked);
  allButtons.forEach(button => button.disabled = locked);

  if (locked) {
    document.querySelector('.settings-panel').style.opacity = '0.5';
    document.querySelector('.settings-panel').style.pointerEvents = 'none';
  } else {
    document.querySelector('.settings-panel').style.opacity = '1';
    document.querySelector('.settings-panel').style.pointerEvents = 'auto';
    validateAllNames();
  }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–∏–º–∏—Ç–∞ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
newNameInput.addEventListener('keydown', (e) => {
  if (newNameInput.value.length >= 15 &&
      !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'].includes(e.key) &&
      !e.ctrlKey && !e.metaKey) {

    newNameInput.style.borderColor = '#ef4444';
    newNameInput.style.background = 'rgba(239,68,68,0.1)';
    newNameInput.placeholder = '‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤';

    setTimeout(() => {
      newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
      if (newNameInput.value.trim()) {
        const dup = names.some((n) => n.toLowerCase() === newNameInput.value.trim().toLowerCase());
        if (!dup) {
          newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
          newNameInput.style.background = 'rgba(255,255,255,0.1)';
        }
      } else {
        newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
        newNameInput.style.background = 'rgba(255,255,255,0.1)';
      }
    }, 1500);
  }
});

// ===== –ë–£–†–ì–ï–†-–ú–ï–ù–Æ =====
let menuOpen = false;

function toggleMenu() {
  menuOpen = !menuOpen;
  menuDropdown.classList.toggle('active', menuOpen);
  burgerBtn.classList.toggle('active', menuOpen);
}

if (burgerBtn) {
  burgerBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleMenu();
  });

  document.addEventListener('click', (e) => {
    if (menuOpen && !menuDropdown.contains(e.target) && !burgerBtn.contains(e.target)) {
      toggleMenu();
    }
  });
}

function createNameInputs(){
  namesList.innerHTML='';

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Å–æ—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
  if (names.length >= 10) {
    namesList.classList.add('full-height');
  } else {
    namesList.classList.remove('full-height');
  }

  names.forEach((name,idx)=>{
    const row=document.createElement('div'); 
    row.className='name-item';
    
    const input=document.createElement('input');
    input.type='text'; input.className='name-input'; input.value=name; input.placeholder='–í–≤–µ–¥–∏—Ç–µ –∏–º—è'; input.maxLength=15;

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–∏–º–∏—Ç–∞ —Å–∏–º–≤–æ–ª–æ–≤
    input.addEventListener('keydown', (e) => {
      if (input.value.length >= 15 &&
          !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'].includes(e.key) &&
          !e.ctrlKey && !e.metaKey) {

        input.classList.add('error-state');
        input.style.borderColor = '#ef4444';
        input.style.background = 'rgba(239,68,68,0.1)';
        const originalPlaceholder = input.placeholder;
        input.placeholder = '‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤';

        setTimeout(() => {
          input.placeholder = originalPlaceholder;
          if (input.value.trim()) {
            input.classList.remove('error-state');
            input.style.borderColor = 'rgba(255,255,255,0.2)';
            input.style.background = 'rgba(255,255,255,0.1)';
          }
        }, 1500);
      }
    });

    input.addEventListener('input', ()=>{
      const v=input.value.trim();

      // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined
      const safeValue = v || '';

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      if (!safeValue || safeValue.length === 0) {
        input.classList.add('error-state');
        input.style.borderColor = '#ef4444';
        input.style.background = 'rgba(239,68,68,0.1)';

        const oldName = names[idx];
        if (oldName in probabilities) {
          probabilities[''] = probabilities[oldName];
          delete probabilities[oldName];
        }
        if (oldName in lockedParticipants) {
          lockedParticipants[''] = true;
          delete lockedParticipants[oldName];
        }
        names[idx] = '';
        saveNames();
        saveProbabilities();
        updateBalls();
        validateAllNames();
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç (–ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –ö–ê–ñ–î–û–ú –∏–Ω–ø—É—Ç–µ)
      const isDup = names.some((n,i)=> i!==idx && (n || '').toLowerCase() === safeValue.toLowerCase());
      if (isDup){
        input.classList.add('error-state');
        input.style.borderColor='#ef4444';
        input.style.background='rgba(239,68,68,0.1)';
        validateAllNames();
        return; // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç
      } else {
        input.classList.remove('error-state');
        input.style.borderColor='rgba(255,255,255,0.2)';
        input.style.background='rgba(255,255,255,0.1)';
      }
      
      const oldName = names[idx];
      if (oldName in probabilities) {
        probabilities[safeValue] = probabilities[oldName];
        delete probabilities[oldName];
      }
      if (oldName in lockedParticipants) {
        lockedParticipants[safeValue] = true;
        delete lockedParticipants[oldName];
      }

      names[idx]=safeValue;
      saveNames();
      saveProbabilities();
      updateBalls();
      validateAllNames();
    });

    input.addEventListener('blur', () => {
      const v = input.value.trim();

      // –ï—Å–ª–∏ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ - –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∏–º—è, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–Ω—ã–º
      if (!v || v.length === 0) {
        input.value = '';
        input.classList.add('error-state');
        input.style.borderColor = '#ef4444';
        input.style.background = 'rgba(239,68,68,0.1)';
        input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
        validateAllNames();
        return;
      }

      const isDup = names.some((n,i)=> i!==idx && n.toLowerCase()===v.toLowerCase());
      if (isDup) {
        input.value = names[idx];
        input.classList.remove('error-state');
        input.style.borderColor='rgba(255,255,255,0.2)';
        input.style.background='rgba(255,255,255,0.1)';
        input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
      } else {
        input.classList.remove('error-state');
        input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
      }
      validateAllNames();
    });

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ placeholder –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
    input.addEventListener('focus', () => {
      if (input.placeholder === '–í–≤–µ–¥–∏—Ç–µ –∏–º—è') {
        input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
      }
      // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –ø—É—Å—Ç–æ–µ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ, —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –æ—à–∏–±–∫–∏
      if (input.value.trim()) {
        input.classList.remove('error-state');
      }
    });

    const probControls = document.createElement('div');
    probControls.className = 'probability-controls';

    const decreaseBtn = document.createElement('button');
    decreaseBtn.className = 'prob-btn';
    decreaseBtn.textContent = '‚àí';
    decreaseBtn.onclick = () => { adjustProbability(name, -1); };

    const probInput = document.createElement('input');
    probInput.type = 'text';
    probInput.inputMode = 'decimal';
    probInput.className = 'probability-input';
    probInput.value = getProbabilityPercent(name);
    
    if (lockedParticipants[name]) {
      probInput.classList.add('manual');
    }

    let lastValid = probInput.value;

    probInput.addEventListener('focus', () => {
      probInput.value = probInput.value.replace('%','');
      lastValid = probInput.value;
    });

    probInput.addEventListener('input', () => {
      const value = probInput.value.replace('%','').trim();
      const num = parseFloat(value);
      if (value === '' || (num >= 0.1 && num <= 99.9)) {
        probInput.classList.remove('error');
      } else {
        probInput.classList.add('error');
      }
    });

    probInput.addEventListener('blur', () => {
      const value = probInput.value.replace('%','').trim();
      const num = parseFloat(value);
      if (value === '' || isNaN(num) || num < 0.1 || num > 99.9) {
        probInput.value = lastValid;
        probInput.classList.remove('error');
        playSound(300, 0.1, 0.2);
      } else {
        if (setProbabilityManually(name, num)) {
          lastValid = getProbabilityPercent(name);
          createNameInputs();
          updateBalls();
        } else {
          probInput.value = lastValid;
          probInput.classList.remove('error');
        }
      }
    });

    probInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); probInput.blur(); }
      if (!/[\d.]/.test(e.key) && e.key !== 'Enter') e.preventDefault();
    });

    const increaseBtn = document.createElement('button');
    increaseBtn.className = 'prob-btn';
    increaseBtn.textContent = '+';
    increaseBtn.onclick = () => { adjustProbability(name, 1); };

    probControls.appendChild(decreaseBtn);
    probControls.appendChild(probInput);
    probControls.appendChild(increaseBtn);

    const btn=document.createElement('button');
    btn.className='remove-btn';
    btn.textContent='‚úï';
    btn.onclick=()=>{
      if (names.length <= 2) {
        newNameInput.style.borderColor = '#ef4444';
        newNameInput.style.background = 'rgba(239,68,68,0.1)';
        newNameInput.placeholder = '–ú–∏–Ω–∏–º—É–º 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞';

        setTimeout(() => {
          newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
          if (!newNameInput.value.trim()) {
            newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
            newNameInput.style.background = 'rgba(255,255,255,0.1)';
          }
        }, 2000);
        return;
      }
      const removedName = names[idx];
      
      const bi = ballData.findIndex(b => b.name === removedName);
      if (bi !== -1) {
        const b = ballData[bi];
        b.element.style.transition='transform .3s, opacity .3s';
        b.element.style.transform='scale(0)'; 
        b.element.style.opacity='0';
        setTimeout(()=>{ 
          b.element.remove(); 
          ballData.splice(bi,1); 
          balls.splice(bi,1); 
        },300);
      }

      names.splice(idx,1);
      delete probabilities[removedName];
      delete lockedParticipants[removedName];

      saveNames();
      normalizeProbabilities();
      saveProbabilities();
      
      createNameInputs();
      updateBalls();
    };

    row.appendChild(input);
    row.appendChild(probControls);
    row.appendChild(btn);
    namesList.appendChild(row);
  });

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
  validateAllNames();
}

function addNewParticipant(){
  const v=newNameInput.value.trim();

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞–∫—Å–∏–º—É–º 10 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  if (names.length >= 10) {
    newNameInput.style.borderColor = '#ef4444';
    newNameInput.style.background = 'rgba(239,68,68,0.1)';
    newNameInput.placeholder = '–ú–∞–∫—Å–∏–º—É–º 10 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤';
    newNameInput.value = '';

    setTimeout(() => {
      newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
      newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
      newNameInput.style.background = 'rgba(255,255,255,0.1)';
    }, 2000);
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  if (!v || v.length === 0) {
    newNameInput.style.borderColor = '#ef4444';
    newNameInput.style.background = 'rgba(239,68,68,0.1)';
    newNameInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª';

    setTimeout(() => {
      newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
      if (!newNameInput.value.trim()) {
        newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
        newNameInput.style.background = 'rgba(255,255,255,0.1)';
      }
    }, 2000);
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
  const isDup = names.some(n=> n.toLowerCase()===v.toLowerCase());
  if (isDup){
    newNameInput.style.borderColor = '#ef4444';
    newNameInput.style.background = 'rgba(239,68,68,0.1)';
    newNameInput.placeholder = '–¢–∞–∫–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å';
    newNameInput.value = '';

    setTimeout(() => {
      newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
      newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
      newNameInput.style.background = 'rgba(255,255,255,0.1)';
    }, 2000);
    return;
  }

  newNameInput.value = '';
  newNameInput.placeholder = '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫';
  newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
  newNameInput.style.background = 'rgba(255,255,255,0.1)';

  names.push(v);
  saveNames();

  probabilities[v] = 1 / names.length;
  normalizeProbabilities();
  saveProbabilities();

  createNameInputs();
  addBallFor(v);
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –ø–æ–ª–µ "–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫"
newNameInput.addEventListener('input', () => {
  const v = newNameInput.value.trim();

  if (!v || v.length === 0) {
    newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
    newNameInput.style.background = 'rgba(255,255,255,0.1)';
    return;
  }

  const dup = names.some((n) => n.toLowerCase() === v.toLowerCase());
  if (dup) {
    newNameInput.style.borderColor = '#ef4444';
    newNameInput.style.background = 'rgba(239,68,68,0.1)';
  } else {
    newNameInput.style.borderColor = 'rgba(255,255,255,0.2)';
    newNameInput.style.background = 'rgba(255,255,255,0.1)';
  }
});

addNameBtn.addEventListener('click', addNewParticipant);
newNameInput.addEventListener('keypress', e=>{ if(e.key==='Enter') addNewParticipant(); });
equalizeBtn.addEventListener('click', equalizeProbabilities);

// ===== –ó–≤—É–∫ =====
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(f, d, v){ 
  const o=audioCtx.createOscillator(), g=audioCtx.createGain(); 
  o.type='sine'; o.frequency.value=f; g.gain.value=v||0.1; 
  o.connect(g); g.connect(audioCtx.destination); 
  const t=audioCtx.currentTime; o.start(t); o.stop(t+(d||0.1)); 
}
const playCountdownBeep = ()=>playSound(800,0.1,0.2);
const playFinalBeep = ()=>playSound(1200,0.25,0.28);
function playFanfare(){ [523,659,784,1046,784,1046,1319,1568].forEach((f,i)=> setTimeout(()=>playSound(f,0.18,0.15),i*150)); }

// ===== –¶–≤–µ—Ç–∞ —à–∞—Ä–æ–≤ =====
const colors = [
  'linear-gradient(135deg,#ff6b6b,#c92a2a)','linear-gradient(135deg,#ffd43b,#fab005)',
  'linear-gradient(135deg,#51cf66,#2f9e44)','linear-gradient(135deg,#339af0,#1864ab)',
  'linear-gradient(135deg,#da77f2,#9c36b5)','linear-gradient(135deg,#66d9e8,#15aabf)',
  'linear-gradient(135deg,#fb923c,#ea580c)','linear-gradient(135deg,#ec4899,#db2777)',
  'linear-gradient(135deg,#8b5cf6,#7c3aed)','linear-gradient(135deg,#14b8a6,#0f766e)',
  'linear-gradient(135deg,#f97316,#ea580c)','linear-gradient(135deg,#06b6d4,#0891b2)'
];
const getBallColor = i => colors[i % colors.length];

// ===== –ì–µ–æ–º–µ—Ç—Ä–∏—è –±–∞–Ω–∫–∏ / —Ñ–∏–∑–∏–∫–∞ =====
const BALL_R = 30;
const JAR_BORDER = 3;
const JAR_BOTTOM_RADIUS = 60;
const JAR_TOP_RADIUS = 20;

const GRAVITY = 1.45;
const FRICTION = 0.992;
const RESTITUTION = 0.95;
const COLLISION_DAMPING = 0.985;

const jar = document.getElementById('jar');
const mixBtn = document.getElementById('mixBtn');
const drawBtn = document.getElementById('drawBtn');
const resultText = document.getElementById('resultText');
const drumrollOverlay = document.getElementById('drumrollOverlay');
const countdown = document.getElementById('countdown');
const selectedBallContainer = document.getElementById('selectedBallContainer');
const selectedBall = document.getElementById('selectedBall');

let balls = [];
let ballData = [];
let mixingIntensity = 0;
let isDrawing = false;
let rafId = null;

function getJarSize(){ return { w: jar.clientWidth, h: jar.clientHeight }; }

function createCelebrationEmojis(){
  const emojis = ['üéâ','üéä','üèÜ','‚≠ê','‚ú®','üéØ','üî•','üí´','üåü','üëè','üôå','üéà','üéÜ','üí•'];
  for (let i=0;i<20;i++){
    setTimeout(()=>{
      const e=document.createElement('div');
      e.className='celebration-emoji';
      e.textContent=emojis[Math.floor(Math.random()*emojis.length)];
      e.style.left=(Math.random()*100)+'%';
      e.style.top=(Math.random()*100)+'%';
      e.style.animationDelay=(Math.random()*0.5)+'s';
      document.body.appendChild(e);
      setTimeout(()=>e.remove(),3500);
    }, i*100);
  }
}
function createCelebrationWords(){
  const words = ['–í–ê–£','–ß–ï–ú–ü–ò–û–ù','–ú–û–õ–û–î–ï–¶','–ö–†–ê–°–ê–í–ê','–õ–ï–ì–ï–ù–î–ê','–í–ü–ï–†–Å–î','–¢–û–ü–ß–ò–ö','–ü–û–ë–ï–î–ê','–û–ì–û–ù–¨','–¢–´ –õ–£–ß–®–ò–ô','–î–ê–í–ê–ô –ï–©–Å','–ù–ï–í–ï–†–û–Ø–¢–ù–û','–°–£–ü–ï–†','–ù–ê–î–û –ñ–ï –ö–¢–û –í–´–ü–ê–õ','–ö–†–ê–°–ê–í–ß–ò–ö','–ú–ê–°–¢–ï–†','–ì–ï–ù–ò–ô','–ë–û–°–°','–ö–¢–û –ë–´ –ú–û–ì –ü–û–î–£–ú–ê–¢–¨','–≠–ü–ò–ß–ù–û','–ë–†–ê–í–û','–ì–ì','–†–ï–°–ü–ï–ö–¢','–®–ò–ö–ê–†–ù–û','–ò–ú–ë–ê','–ö–†–£–¢–Ø–ö','–ú–û–©–ù–û','–ó–ê –ü–û–ë–ï–î–£','–í–û–¢ –≠–¢–û –î–ê','–ö–†–£–¢–û','–§–ê–ô–ï–†','–ë–û–ú–ë–ê','–¢–û–ü-1','–ü–†–û','–õ–ï–ì–ï–ù–î–ê –í–û–ó–í–†–ê–©–ê–ï–¢–°–Ø','–ë–ï–ó–£–ü–†–ï–ß–ù–û','–ú–ê–ì–ò–Ø','–ß–£–î–û','–§–ê–ù–¢–ê–°–¢–ò–ö–ê'];
  const cols=4, rows=3, pos=[];
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) pos.push({left:(c*(100/cols))+(100/cols/2), top:(r*(100/rows))+(100/rows/2)});
  pos.sort(()=>Math.random()-0.5);
  for(let i=0;i<12;i++){
    setTimeout(()=>{
      const w=document.createElement('div');
      w.className='celebration-word';
      w.textContent=words[Math.floor(Math.random()*words.length)];
      const p=pos[i%pos.length];
      w.style.left=(p.left+(Math.random()-0.5)*10)+'%';
      w.style.top =(p.top +(Math.random()-0.5)*10)+'%';
      w.style.animationDelay=(Math.random()*0.3)+'s';
      document.body.appendChild(w);
      setTimeout(()=>w.remove(),4500);
    }, i*120);
  }
}
function createConfetti(){
  const cs=['#ff6b6b','#ffd43b','#51cf66','#339af0','#da77f2','#66d9e8','#fb923c','#ec4899'];
  for(let i=0;i<100;i++){
    setTimeout(()=>{
      const d=document.createElement('div');
      d.className='confetti';
      d.style.left=(Math.random()*100)+'%';
      d.style.top='0';
      d.style.background=cs[Math.floor(Math.random()*cs.length)];
      d.style.width=(5+Math.random()*10)+'px';
      d.style.height=(5+Math.random()*10)+'px';
      d.style.animationDelay=(Math.random()*0.5)+'s';
      d.style.animationDuration=(2+Math.random()*2)+'s';
      document.body.appendChild(d);
      setTimeout(()=>d.remove(),4000);
    }, i*25);
  }
}

// –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –¥–Ω–µ –±–∞–Ω–∫–∏ (—Å–∫—Ä—É–≥–ª—ë–Ω–Ω–æ–º)
function placeOnFloorRounded(existing){
  const { w, h } = getJarSize();
  const VISUAL_PADDING = 1;
  const R = JAR_BOTTOM_RADIUS - JAR_BORDER - VISUAL_PADDING;
  const minX = JAR_BORDER + BALL_R + VISUAL_PADDING;
  const maxX = w - JAR_BORDER - BALL_R - VISUAL_PADDING;
  const flatLeftEdge  = JAR_BORDER + R + VISUAL_PADDING;
  const flatRightEdge = w - JAR_BORDER - R - VISUAL_PADDING;
  const flatY = h - JAR_BORDER - BALL_R - VISUAL_PADDING;

  let cx = minX + Math.random() * (maxX - minX);
  let cy;

  if (cx >= flatLeftEdge && cx <= flatRightEdge){
    cy = flatY;
  } else {
    const Cx = (cx < flatLeftEdge) ? (JAR_BORDER + R + VISUAL_PADDING) : (w - JAR_BORDER - R - VISUAL_PADDING);
    const Cy = h - JAR_BORDER - R - VISUAL_PADDING;
    const vdx = cx - Cx, vdy = flatY - Cy;
    const dist = Math.hypot(vdx, vdy) || 1;
    const need = (R - BALL_R - VISUAL_PADDING);
    cx = Cx + vdx * (need / dist);
    cy = Cy + vdy * (need / dist);
  }

  let guard = 0;
  while (guard++ < 700){
    let overlap = false;
    for (const p of existing){
      const pcx = p.x + BALL_R, pcy = p.y + BALL_R;
      if (Math.hypot(cx - pcx, cy - pcy) < BALL_R*2){ overlap = true; break; }
    }
    if (!overlap) break;
    cy -= 2;
  }
  return { x: cx - BALL_R, y: cy - BALL_R };
}

// –û—Ç—Ä–∞–∂–µ–Ω–∏—è / —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
function reflectInJar(d){
  const { w, h } = getJarSize();
  const cx = d.x + BALL_R, cy = d.y + BALL_R;
  const VISUAL_PADDING = 1;
  const minX = JAR_BORDER + BALL_R + VISUAL_PADDING;
  const maxX = w - JAR_BORDER - BALL_R - VISUAL_PADDING;
  const topY = JAR_BORDER + BALL_R + (JAR_TOP_RADIUS ? (JAR_TOP_RADIUS - BALL_R) : 0) + VISUAL_PADDING;
  const flatY = h - JAR_BORDER - BALL_R - VISUAL_PADDING;
  const R = JAR_BOTTOM_RADIUS - JAR_BORDER - VISUAL_PADDING;
  const leftCx  = JAR_BORDER + R + VISUAL_PADDING;
  const rightCx = w - JAR_BORDER - R - VISUAL_PADDING;
  const cornerRadius = R - BALL_R - VISUAL_PADDING;

  if (cx < minX){ d.x = minX - BALL_R; d.vx = -d.vx * RESTITUTION; d.vy *= RESTITUTION; }
  if (cx > maxX){ d.x = maxX - BALL_R; d.vx = -d.vx * RESTITUTION; d.vy *= RESTITUTION; }
  if (cy < topY){ d.y = topY - BALL_R; d.vy = -d.vy * RESTITUTION; d.vx *= RESTITUTION; }

  if (cx >= leftCx && cx <= rightCx){
    if (cy > flatY){ d.y = flatY - BALL_R; d.vy = -d.vy * RESTITUTION; d.vx *= RESTITUTION; }
    return;
  }

  const Cx = (cx < leftCx) ? leftCx : rightCx;
  const Cy = h - JAR_BORDER - R - VISUAL_PADDING;
  const vx = cx - Cx, vy = cy - Cy;
  const dist = Math.hypot(vx, vy);

  if (dist > cornerRadius){
    const nx = vx / (dist || 1), ny = vy / (dist || 1);
    const projX = Cx + nx * cornerRadius, projY = Cy + ny * cornerRadius;
    d.x = projX - BALL_R; d.y = projY - BALL_R;
    const dot = d.vx * nx + d.vy * ny;
    d.vx -= 2 * dot * nx; d.vy -= 2 * dot * ny;
    d.vx *= 0.98; d.vy *= RESTITUTION;
    const tx = -ny, ty = nx;
    const tang = d.vx * tx + d.vy * ty;
    d.vx -= tx * tang * 0.08;
    d.vy -= ty * tang * 0.08;
  }
}
function checkCollision(a,b){
  const dx=(a.x+BALL_R)-(b.x+BALL_R), dy=(a.y+BALL_R)-(b.y+BALL_R);
  return Math.hypot(dx,dy) < (a.radius + b.radius);
}
function resolveCollision(a,b){
  const dx=(b.x+BALL_R)-(a.x+BALL_R), dy=(b.y+BALL_R)-(a.y+BALL_R);
  const dist=Math.hypot(dx,dy); if(dist<1e-6) return;
  const nx=dx/dist, ny=dy/dist;
  const dvx=b.vx - a.vx, dvy=b.vy - a.vy;
  const dvn=dvx*nx + dvy*ny; if(dvn>0) return;
  const impulse=(2*dvn)/(a.mass + b.mass);
  a.vx += impulse*b.mass*nx*COLLISION_DAMPING;
  a.vy += impulse*b.mass*ny*COLLISION_DAMPING;
  b.vx -= impulse*a.mass*nx*COLLISION_DAMPING;
  b.vy -= impulse*a.mass*ny*COLLISION_DAMPING;
  const overlap=(a.radius + b.radius) - dist;
  if(overlap>0){ const c=overlap*0.5; a.x-=nx*c; a.y-=ny*c; b.x+=nx*c; b.y+=ny*c; }
}

// –ú–æ–¥–µ–ª—å —à–∞—Ä–æ–≤
function initBalls(){
  jar.innerHTML=''; balls=[]; ballData=[];
  names.forEach((name,i)=>{
    const el=document.createElement('div');
    el.className='ball';
    el.style.background=getBallColor(i);
    const fs = name.length>10?8:name.length>8?10:name.length>6?9:10;
    el.style.fontSize=fs+'px';
    const inner=document.createElement('div'); inner.textContent=name; el.appendChild(inner);
    const pos=placeOnFloorRounded(ballData);
    el.style.left=pos.x+'px'; el.style.top=pos.y+'px';
    jar.appendChild(el); balls.push(el);
    ballData.push({ element:el, x:pos.x, y:pos.y, vx:0, vy:0, radius:BALL_R, mass:1, name, color:getBallColor(i) });
  });
  void jar.offsetHeight;
}

function addBallFor(name){
  const i = names.indexOf(name);
  if (i < 0) return;
  const el=document.createElement('div');
  el.className='ball';
  el.style.background=getBallColor(i);
  const fs = name.length>10?8:name.length>8?10:name.length>6?9:10;
  el.style.fontSize=fs+'px';
  const inner=document.createElement('div'); inner.textContent=name; el.appendChild(inner);
  const pos=placeOnFloorRounded(ballData);
  el.style.left=pos.x+'px'; el.style.top=pos.y+'px';
  jar.appendChild(el); balls.push(el);
  ballData.push({ element:el, x:pos.x, y:pos.y, vx:0, vy:-2-Math.random()*2, radius:BALL_R, mass:1, name, color:getBallColor(i) });
}

function updateBalls(){
  const valid = names.map(s=>s.trim()).filter(Boolean);
  if(!valid.length) return;
  names = valid; saveNames();
  initBalls();
  requestAnimationFrame(()=> {
    ballData.forEach(d=>{ d.vy = -1.5 - Math.random()*1; d.vx = (Math.random()-0.5)*1; });
    startPhysics();
  });
}

// –§–∏–∑–∏—á–µ—Å–∫–∏–π —Ü–∏–∫–ª
function step(){
  for (const d of ballData){
    if (d.element.style.display==='none') continue;
    if (mixingIntensity > 0 || Math.abs(d.vx)>0.1 || Math.abs(d.vy)>0.1) d.vy += GRAVITY;

    if (mixingIntensity>0){
      const rf = mixingIntensity*1.2;
      d.vx += (Math.random()-0.5)*rf;
      d.vy += (Math.random()-0.5)*rf*0.7;
    }

    if (mixingIntensity > 0.5){ d.vx *= FRICTION; d.vy *= FRICTION; }
    else if (mixingIntensity > 0){ d.vx *= 0.96; d.vy *= 0.96; }
    else { d.vx *= 0.88; d.vy *= 0.88; if (Math.abs(d.vx)<0.02) d.vx=0; if (Math.abs(d.vy)<0.02) d.vy=0; }

    d.x += d.vx; d.y += d.vy; reflectInJar(d);
  }

  for(let i=0;i<ballData.length;i++){
    if (ballData[i].element.style.display==='none') continue;
    for(let j=i+1;j<ballData.length;j++){
      if (ballData[j].element.style.display==='none') continue;
      if (checkCollision(ballData[i], ballData[j])) resolveCollision(ballData[i], ballData[j]);
    }
  }

  for(let k=0;k<2;k++){
    for(let i=0;i<ballData.length;i++){
      for(let j=i+1;j<ballData.length;j++){
        const a=ballData[i], b=ballData[j];
        const dx=(b.x+BALL_R)-(a.x+BALL_R), dy=(b.y+BALL_R)-(a.y+BALL_R);
        const dist=Math.hypot(dx,dy); 
        const overlap=(a.radius+b.radius)-dist;
        if (overlap>0){
          const nx=dx/(dist||1), ny=dy/(dist||1), c=overlap*0.5;
          a.x-=nx*c; a.y-=ny*c; 
          b.x+=nx*c; b.y+=ny*c;
        }
      }
    }
  }

  for (const d of ballData){
    if (d.element.style.display!=='none'){
      d.element.style.left = d.x+'px';
      d.element.style.top  = d.y+'px';
    }
  }

  if (mixingIntensity>0) mixingIntensity = Math.max(0, mixingIntensity - 0.02);
  rafId = requestAnimationFrame(step);
}
function startPhysics(){ if (rafId) return; rafId = requestAnimationFrame(step); }
function stopPhysics(){ if (!rafId) return; cancelAnimationFrame(rafId); rafId=null; }
function addMixingForce(intensity){
  mixingIntensity = Math.min(15, mixingIntensity + intensity);
  ballData.forEach(d=>{
    if (d.element.style.display==='none') return;
    for(let k=0;k<4;k++){
      const ang=Math.random()*Math.PI*2;
      const force=intensity*(1.2+Math.random()*1.5);
      d.vx += Math.cos(ang)*force*1.3;
      d.vy += Math.sin(ang)*force*1.0 - intensity*0.4;
    }
  });
}

// –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
function mixBalls(){ 
  if(isDrawing) return; 
  addMixingForce(9); 
  jar.classList.add('shaking'); 
  setTimeout(()=>jar.classList.remove('shaking'),1000); 
}

async function drawBall(){
  if (isDrawing) return;
  isDrawing = true;
  setUILocked(true);
  resultText.innerHTML='';
  selectedBallContainer.classList.remove('show');
  startPhysics();

  jar.classList.add('shaking');
  for(let i=0;i<25;i++){ 
    addMixingForce(0.7 + i*0.22); 
    await new Promise(r=>setTimeout(r,100)); 
  }

  drumrollOverlay.classList.add('active');
  for (let i=5;i>0;i--){
    addMixingForce(8.5);
    countdown.textContent=i; 
    countdown.classList.add('show'); 
    playCountdownBeep();
    await new Promise(r=>setTimeout(r,900));
    countdown.classList.remove('show');
    await new Promise(r=>setTimeout(r,100));
  }

  await new Promise(r=>setTimeout(r,300));
  drumrollOverlay.classList.remove('active');
  drumrollOverlay.classList.add('flash');
  document.body.classList.add('shake');
  setTimeout(()=>document.body.classList.remove('shake'), 500);
  await new Promise(r=>setTimeout(r,300));
  jar.classList.remove('shaking'); 
  playFinalBeep();
  await new Promise(r=>setTimeout(r,200));
  drumrollOverlay.classList.remove('flash');
  await new Promise(r=>setTimeout(r,300));

  const available = ballData.filter(d=>d.element.style.display!=='none');

  // === –í–ó–í–ï–®–ï–ù–ù–´–ô –í–´–ë–û–† –° –í–ï–†–û–Ø–¢–ù–û–°–¢–Ø–ú–ò ===
  const weightedPool = [];
  available.forEach(d => {
    const weight = probabilities[d.name] || (1 / available.length);
    const count = Math.max(1, Math.round(weight * 1000));
    for (let i = 0; i < count; i++) weightedPool.push(d);
  });
  const winnerData = weightedPool[Math.floor(Math.random() * weightedPool.length)];
  const winner = winnerData.element;

  winner.classList.add('extracting');
  await new Promise(r=>setTimeout(r,800));
  winner.style.display='none';

  selectedBall.style.background = winnerData.color;
  selectedBall.innerHTML = '<div>' + winnerData.name + '</div>';
  selectedBall.className='selected-ball pulsing';
  selectedBallContainer.classList.add('show');

  playFanfare(); 
  createConfetti();
  createCelebrationEmojis();
  createCelebrationWords();

  await new Promise(r=>setTimeout(r,600));
  resultText.innerHTML = '<div class="result-text">üéâ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ' + winnerData.name + '! üéâ</div>';
  await new Promise(r=>setTimeout(r,3500));
  selectedBallContainer.classList.remove('show');
  winner.classList.remove('extracting');
  winner.style.display='block';
  winnerData.vx = (Math.random()-0.5)*8;
  winnerData.vy = -10 - Math.random()*5;
  addMixingForce(4);

  isDrawing=false;
  setUILocked(false);
}

mixBtn.addEventListener('click', mixBalls);
drawBtn.addEventListener('click', drawBall);

// ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
function boot(){
  initProbabilities();
  createNameInputs();
  initBalls();
  requestAnimationFrame(() => {
    ballData.forEach(d=>{ d.vy = -1.5 - Math.random()*1; d.vx = (Math.random()-0.5)*1; });
    startPhysics();
  });
}
boot();

// –†–∞–∑–±—É–¥–∏—Ç—å AudioContext –Ω–∞ iOS/Android
(function () {
  var unlocked = false;
  function unlock() {
    try { if (typeof audioCtx !== 'undefined' && audioCtx.state === 'suspended') audioCtx.resume(); } catch(e) {}
    if (!unlocked) {
      unlocked = true;
      window.removeEventListener('touchstart', unlock, {passive:true});
      window.removeEventListener('pointerdown', unlock, {passive:true});
      window.removeEventListener('click', unlock, {passive:true});
    }
  }
  window.addEventListener('touchstart', unlock, {passive:true});
  window.addEventListener('pointerdown', unlock, {passive:true});
  window.addEventListener('click', unlock, {passive:true});
})();

// –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
let resizeTimeout;
window.addEventListener('resize', ()=>{ 
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    ballData.forEach(d => {
      if (d.element.style.display !== 'none') {
        const { w, h } = getJarSize();
        const cx = d.x + BALL_R;
        const cy = d.y + BALL_R;
        if (cx > w - JAR_BORDER - BALL_R) { d.x = w - JAR_BORDER - BALL_R*2; d.vx = -Math.abs(d.vx)*0.5; }
        if (cy > h - JAR_BORDER - BALL_R) { d.y = h - JAR_BORDER - BALL_R*2; d.vy = -Math.abs(d.vy)*0.5; }
        d.vy += 0.5;
      }
    });
    addMixingForce(2);
  }, 150);
});
</script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
(function(m,e,t,r,i,k,a){ m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)}; m[i].l=1*new Date(); for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }} k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a) })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=104849796', 'ym'); ym(104849796, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/104849796" style="position:absolute; left:-9999px;" alt=""/></div></noscript>
<!-- /Yandex.Metrika counter -->
</body>
</html>
