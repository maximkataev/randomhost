<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>–¢—Ä–µ–π–¥–∏–Ω–≥ –†–æ–∑—ã–≥—Ä—ã—à ‚Äî —Ä–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ</title>
  <meta name="description" content="–ñ–∏–≤–æ–π –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫: —Å–≤–µ—á–∏, —Ç–∏–∫–∏, –∑–æ–Ω—ã-—É—á–∞—Å—Ç–Ω–∏–∫–∏. –ü–æ–±–µ–¥–∏—Ç–µ–ª—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∑–∞–∫—Ä—ã—Ç–∏—è. –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤—ã—Å–æ—Ç–µ –∑–æ–Ω." />
  <meta name="theme-color" content="#764ba2">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4c8.svg">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --glass: rgba(255,255,255,0.1);
      --glass-2: rgba(255,255,255,0.06);
      --text:#fff;
      --accent:#ffd43b;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      display:flex;align-items:center;justify-content:center;
      min-height:100vh;padding:20px;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      font-family:'Montserrat',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
      color:var(--text);
    }

    /* ===== –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é (—Å–∫—Ä—ã—Ç–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ) ===== */
    .menu-container {
      display: none;
    }

    /* ===== –í–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é ===== */
    .top-buttons {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      gap: 12px;
      z-index: 1000;
    }
    .top-btn {
      background: linear-gradient(135deg, rgba(102,126,234,0.95), rgba(118,75,162,0.95));
      color: #fff;
      text-decoration: none;
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      transition: 0.25s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .top-btn:hover {
      background: linear-gradient(135deg, rgba(118,75,162,1), rgba(102,126,234,1));
      transform: translateY(-2px);
    }

    /* ===== –õ—ç–π–∞—É—Ç ===== */
    .layout{
      display:grid;
      grid-template-columns: 414px minmax(520px,1fr);
      gap:48px;
      width:min(1400px,100%);
      align-items:center;
      max-height: calc(100vh - 40px);
    }

    /* ===== –ö–∞—Ä—Ç–æ—á–∫–∏ ===== */
    .card{
      border-radius:22px;
      background: linear-gradient(145deg, var(--glass), var(--glass-2));
      backdrop-filter: blur(10px);
      box-shadow:
        0 0 0 10px rgba(255,255,255,0.08),
        0 0 0 15px rgba(255,255,255,0.05),
        0 18px 48px rgba(0,0,0,0.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    /* ===== –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å ===== */
    .card.participants-panel {
      height: fit-content;
      max-height: calc(100vh - 40px);
    }

    .panel-header{
      display:flex;align-items:center;justify-content:space-between;
      padding:20px 24px;
      flex-shrink: 0;
    }
    .panel-title{
      font-size:28px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.25);
    }
    .equalize-btn{
      padding:8px 18px;border-radius:12px;border:2px solid rgba(255,255,255,0.35);
      background:linear-gradient(135deg, rgba(102,126,234,0.9), rgba(118,75,162,0.9));
      color:#fff;font-weight:800;cursor:pointer;transition:.25s;
      box-shadow:0 6px 18px rgba(0,0,0,0.25);white-space:nowrap
    }
    .equalize-btn:hover{ transform:translateY(-2px); border-color:rgba(255,255,255,0.6)}
    .panel-body{ 
      padding:0 20px 20px 20px; 
      display:flex; 
      flex-direction:column; 
      gap:12px;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
    .headers-row {
      display: flex;
      align-items: center;
      gap: 0px;
      margin-bottom: 10px;
      padding: 0 5px;
      color: rgba(255,255,255,0.75);
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .header-name { flex: 1; text-align: left; }
    .header-probability { width: 120px; text-align: center; flex-shrink: 0; }
    .header-remove { width: 44px; }

    /* –°–ø–∏—Å–æ–∫ –∏–º—ë–Ω */
    .names-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow-y:auto;
      overflow-x:hidden;
      padding-right:6px;
      flex: 1;
      min-height: 0;
      max-height: calc(100vh - 350px); /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
      scrollbar-width:none; /* Firefox */
      -ms-overflow-style:none; /* IE and Edge */
    }
    /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
    .names-list::-webkit-scrollbar{
      width:0px;
      display:none;
    }

    .name-item{
      display:flex;gap:8px;align-items:center;
      flex-shrink: 0;
    }
    .name-input{
      flex:1; padding:10px 15px; border:2px solid rgba(255,255,255,0.2);
      border-radius:10px; background:rgba(255,255,255,0.1); color:#fff; font-size:16px; transition:.3s;
    }
    .name-input:focus{ outline:none; border-color:rgba(255,255,255,0.5); background:rgba(255,255,255,0.2); }
    .name-input::placeholder{ color:rgba(255,255,255,0.5); }

    /* –ë–ª–æ–∫ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π */
    .probability-controls {
      display: flex;
      gap: 5px;
      width: 120px;
      flex-shrink: 0;
      justify-content: center;
      align-items: center;
    }
    .prob-btn {
      padding: 5px 10px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: .2s;
    }
    .prob-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }
    .prob-btn:active { transform: scale(0.95); }

    .probability-input {
      width: 55px;
      padding: 4px;
      background: rgba(255,255,255,0.1);
      color: #ffd43b;
      border: 2px solid rgba(255,212,59,0.3);
      border-radius: 5px;
      text-align: center;
      font-weight: 800;
      font-size: 14px;
      transition: .2s;
    }
    .probability-input:focus {
      outline: none;
      border-color: rgba(255,212,59,0.6);
      background: rgba(255,255,255,0.15);
    }
    .probability-input.error {
      border-color: rgba(239,68,68,0.8);
      background: rgba(239,68,68,0.2);
    }

    .remove-btn{
      padding:8px 11px; background:rgba(239,68,68,.7); color:#fff; border:none; border-radius:8px;
      cursor:pointer; font-size:18px; transition:.3s; width:44px; text-align:center;
    }
    .remove-btn:hover{ background:rgba(239,68,68,.9); transform:scale(1.05); }

    .probability-input.manual {
      border-color: #FBBF24;
      box-shadow: 0 0 0 3px rgba(251,191,36,.25);
    }

    .add-name-container{
      display:flex; 
      gap:10px; 
      margin-top:6px;
      flex-shrink: 0;
    }
    #newNameInput{ flex:1 }
    .add-btn-small{
      padding:10px 15px; background:rgba(34,197,94,.85); color:#fff; border:none; border-radius:10px;
      cursor:pointer; font-size:20px; transition:.2s;
    }
    .add-btn-small:hover{ transform:translateY(-1px) }

    /* –¢—É–ª—Ç–∏–ø –¥–ª—è –æ—à–∏–±–æ–∫ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π */
    .probability-error-tooltip {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(220,38,38,0.95));
      color: #fff;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      z-index: 1002;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      max-width: 400px;
      animation: tooltipAppear 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: none;
    }

    @keyframes tooltipAppear {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    /* ===== –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ) ===== */
    .board{
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:16px;
      height: fit-content;
    }
    .title{
      text-align:center;font-size:44px;font-weight:800;margin-top:4px;
      text-shadow:2px 2px 6px rgba(0,0,0,0.35);animation:glow 2s ease-in-out infinite alternate
    }
    @keyframes glow{
      from{ text-shadow:2px 2px 6px rgba(0,0,0,0.35),0 0 10px rgba(255,255,255,.25)}
      to  { text-shadow:2px 2px 6px rgba(0,0,0,0.35),0 0 24px rgba(255,255,255,.45)}
    }

    .chart-wrap{
      position:relative; width:100%; aspect-ratio:16/9; margin:0 auto;
      border-radius:20px; background:linear-gradient(145deg, rgba(0,0,0,0.20), rgba(0,0,0,0.10));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
      overflow:hidden; flex:1;
      min-height:320px;
    }
    canvas#chart{width:100%;height:100%;display:block}

    .controls{ display:flex; justify-content:center; }
    .btn{
      padding:16px 28px;border-radius:50px;border:none;cursor:pointer;color:#fff;font-weight:800;font-size:18px;
      background:linear-gradient(135deg,var(--bg1),var(--bg2)); box-shadow:0 10px 30px rgba(0,0,0,0.35);
      transition:.25s; position:relative; overflow:hidden
    }
    .btn:hover{ transform:translateY(-2px) }
    .btn:disabled{ opacity:.55; cursor:not-allowed }

    .winner-announcement{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:linear-gradient(135deg, rgba(102,126,234,0.95), rgba(118,75,162,0.95));
      padding:40px 60px;
      border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
      display:none;
      z-index:1001;
    }
    .winner-announcement.show{ 
      display:block; 
      animation:winnerAppear 1s cubic-bezier(.68,-0.55,.265,1.55), winnerPulse 1s ease-in-out 1s infinite;
    }
    .winner-announcement h2{
      color:#fff;
      font-size:36px;
      margin:0;
      text-align:center;
      text-shadow:2px 2px 4px rgba(0,0,0,0.3);
      animation: textGlow 1.5s ease-in-out infinite;
    }
    @keyframes winnerAppear{ 
      0%{ transform:translate(-50%,-50%) scale(0) rotate(-180deg); opacity:0; } 
      100%{ transform:translate(-50%,-50%) scale(1) rotate(0deg); opacity:1; } 
    }
    @keyframes winnerPulse{
      0%, 100% { 
        box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 0 0 rgba(255,212,59,0.7);
      }
      50% { 
        box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 0 20px rgba(255,212,59,0);
      }
    }
    @keyframes textGlow{
      0%, 100% {
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 10px rgba(255,212,59,0.5);
      }
      50% {
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 30px rgba(255,212,59,0.9);
      }
    }
    
    /* –í—Å–ø—ã—à–∫–∞ —ç–∫—Ä–∞–Ω–∞ */
    .screen-flash {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle, rgba(255,212,59,0.4) 0%, transparent 70%);
      z-index: 997;
      pointer-events: none;
      animation: flashScreen 0.5s ease-out;
    }
    @keyframes flashScreen {
      0% {
        opacity: 0;
      }
      50% {
        opacity: 1;
      }
      100% {
        opacity: 0;
      }
    }
    
    /* –§–µ–π–µ—Ä–≤–µ—Ä–∫–∏ */
    .firework {
      position: fixed;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      z-index: 996;
      pointer-events: none;
    }
    @keyframes firework-burst {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      100% {
        opacity: 0;
      }
    }
    
    /* –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      z-index: 999;
      pointer-events: none;
      animation: confetti-fall 3s ease-out forwards;
    }
    @keyframes confetti-fall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
    
    /* –°–º–∞–π–ª–∏–∫–∏ –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏—è */
    .celebration-emoji {
      position: fixed;
      font-size: 60px;
      z-index: 998;
      pointer-events: none;
      animation: emojiCelebrate 3s ease-out forwards;
    }
    @keyframes emojiCelebrate {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
      }
      20% {
        transform: scale(1.5) rotate(180deg);
        opacity: 1;
      }
      80% {
        opacity: 1;
      }
      100% {
        transform: scale(0.5) rotate(360deg);
        opacity: 0;
      }
    }
    
    /* –ö—Ä—É—Ç—ã–µ —Å–ª–æ–≤–∞ */
    .celebration-word {
      position: fixed;
      font-size: 40px;
      font-weight: 800;
      color: #fff;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
      z-index: 998;
      pointer-events: none;
      opacity: 0.7;
      animation: wordFloat 4s ease-out forwards;
    }
    @keyframes wordFloat {
      0% {
        transform: scale(0) translateY(0) rotate(-15deg);
        opacity: 0;
      }
      15% {
        transform: scale(1.2) translateY(-20px) rotate(5deg);
        opacity: 0.9;
      }
      50% {
        opacity: 0.8;
      }
      100% {
        transform: scale(0.8) translateY(-150px) rotate(15deg);
        opacity: 0;
      }
    }

    /* ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */
    @media (max-width:980px){
      body { 
        padding: clamp(60px, 12vh, 90px) 12px 12px 12px;
      }
      
      .layout {
        gap: 20px;
        grid-template-columns: 1fr;
      }
      
      .top-buttons {
        top: calc(env(safe-area-inset-top, 0px) + 8px);
        left: calc(env(safe-area-inset-left, 0px) + 8px);
        right: calc(env(safe-area-inset-right, 0px) + 8px);
        gap: 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      .top-buttons::-webkit-scrollbar { display: none; }
      .top-btn { 
        padding: 8px 14px; 
        font-size: 14px; 
        border-radius: 9px; 
        flex: 0 0 auto;
        white-space: nowrap;
      }
      
      .card.participants-panel {
        max-height: none; /* –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
        order: 2;
      }
      
      .board {
        padding: 16px;
        gap: 12px;
        order: 1;
      }
      
      .title {
        font-size: clamp(32px, 8vw, 44px);
        margin-top: 0;
        margin-bottom: 8px;
      }
      
      .chart-wrap {
        min-height: 420px; /* 280px * 1.5 = 420px */
        aspect-ratio: 4/3;
      }
      
      .panel-header {
        padding: 16px 20px;
      }
      
      .panel-title {
        font-size: 24px;
      }
      
      .equalize-btn {
        padding: 7px 14px;
        font-size: 13px;
      }
      
      .panel-body {
        padding: 0 16px 16px 16px;
        gap: 10px;
      }
      
      .headers-row {
        font-size: 13px;
        margin-bottom: 8px;
      }
      
      .names-list {
        gap: 8px;
        max-height: none; /* –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã */
        overflow-y: visible; /* –£–±–∏—Ä–∞–µ–º —Å–∫—Ä–æ–ª–ª */
      }

      /* –£–±–∏—Ä–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
      .names-list::-webkit-scrollbar{
        display: none;
      }
      
      .name-item {
        gap: 6px;
      }
      
      .name-input {
        padding: 10px 12px;
        font-size: 15px;
        border-radius: 8px;
      }
      
      .probability-controls { 
        width: 100px; 
        gap: 3px; 
      }
      
      .prob-btn {
        padding: 6px 9px;
        font-size: 13px;
        border-radius: 4px;
      }
      
      .probability-input { 
        width: 52px; 
        font-size: 13px; 
        padding: 6px 3px;
      }
      
      .remove-btn { 
        padding: 8px 10px; 
        font-size: 16px; 
        width: 38px;
      }
      
      .add-name-container {
        margin-top: 8px;
        gap: 8px;
      }
      
      .add-btn-small {
        padding: 10px 13px;
        font-size: 18px;
      }
      
      .btn {
        padding: 14px 24px;
        font-size: 16px;
        border-radius: 40px;
        width: 100%;
        max-width: 320px;
      }
      
      .winner-announcement {
        padding: 24px 32px;
        border-radius: 16px;
        max-width: calc(100vw - 32px);
      }
      
      .winner-announcement h2 {
        font-size: clamp(18px, 5.5vw, 28px);
        line-height: 1.3;
      }
      
      .celebration-emoji {
        font-size: clamp(40px, 10vw, 50px);
      }
      
      .celebration-word {
        font-size: clamp(24px, 6vw, 32px);
      }

      .probability-error-tooltip {
        max-width: 90%;
        padding: 16px 20px;
        font-size: 14px;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: clamp(60px, 12vh, 90px) 8px 8px 8px;
      }
      
      .card {
        border-radius: 18px;
      }
      
      .title {
        font-size: clamp(28px, 7vw, 36px);
      }
      
      .chart-wrap {
        min-height: 360px; /* 240px * 1.5 = 360px */
        border-radius: 16px;
      }
      
      .panel-header {
        padding: 14px 16px;
      }
      
      .panel-title {
        font-size: 22px;
      }
      
      .equalize-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
      
      .panel-body {
        padding: 0 12px 12px 12px;
      }
      
      .name-input {
        padding: 9px 10px;
        font-size: 14px;
      }
      
      .probability-controls {
        width: 90px;
        gap: 2px;
      }
      
      .prob-btn {
        padding: 5px 7px;
        font-size: 12px;
      }
      
      .probability-input {
        width: 48px;
        font-size: 12px;
        padding: 5px 2px;
      }
      
      .remove-btn {
        padding: 7px 9px;
        font-size: 15px;
        width: 36px;
      }
      
      .winner-announcement {
        padding: 20px 24px;
        max-width: calc(100vw - 24px);
      }
      
      .winner-announcement h2 {
        font-size: clamp(16px, 5vw, 24px);
      }
    }
    
    /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (hover: none) and (pointer: coarse) {
      .top-btn:hover,
      .prob-btn:hover,
      .equalize-btn:hover,
      .add-btn-small:hover,
      .remove-btn:hover,
      .btn:hover {
        transform: none !important;
      }
      
      .top-btn:active,
      .prob-btn:active,
      .equalize-btn:active,
      .add-btn-small:active,
      .remove-btn:active,
      .btn:active {
        transform: scale(0.96) !important;
      }
      
      /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç–∏ –∫–∞—Å–∞–Ω–∏—è */
      .prob-btn,
      .remove-btn,
      .add-btn-small {
        min-height: 44px;
      }
      
      .probability-input {
        min-height: 40px;
      }

      /* –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é */
      .menu-container {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        padding: 12px 16px;
        background: linear-gradient(180deg, rgba(102,126,234,0.95) 0%, rgba(118,75,162,0.85) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }

      .menu-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .menu-title {
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }

      .burger-btn {
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 4px;
        transition: all 0.3s ease;
        min-width: 44px;
        min-height: 44px;
        align-items: center;
        justify-content: center;
      }

      .burger-btn:hover {
        background: rgba(255,255,255,0.3);
      }

      .burger-btn span {
        display: block;
        width: 24px;
        height: 3px;
        background: #fff;
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      .burger-btn.active span:nth-child(1) {
        transform: rotate(45deg) translateY(7px);
      }

      .burger-btn.active span:nth-child(2) {
        opacity: 0;
      }

      .burger-btn.active span:nth-child(3) {
        transform: rotate(-45deg) translateY(-7px);
      }

      .menu-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, rgba(102,126,234,0.98) 0%, rgba(118,75,162,0.98) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .menu-dropdown.active {
        max-height: 500px;
      }

      .menu-dropdown a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        color: #fff;
        text-decoration: none;
        font-size: 16px;
        font-weight: 600;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        transition: background 0.2s ease;
        min-height: 56px;
      }

      .menu-dropdown a:last-child {
        border-bottom: none;
      }

      .menu-dropdown a:hover {
        background: rgba(255,255,255,0.15);
      }

      .menu-dropdown a:active {
        background: rgba(255,255,255,0.25);
      }

      /* –°–∫—Ä—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
      .top-buttons {
        display: none;
      }
    }

    /* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 980px) and (orientation: landscape) {
      body {
        padding: 56px 12px 12px 12px;
      }
      
      .layout {
        grid-template-columns: 380px 1fr;
        gap: 24px;
        align-items: start;
      }
      
      .board {
        order: 2;
      }
      
      .card.participants-panel {
        order: 1;
        max-height: none; /* –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
      }
      
      .chart-wrap {
        aspect-ratio: 16/9;
        min-height: 200px;
      }
      
      .names-list {
        max-height: none; /* –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã */
        overflow-y: visible; /* –£–±–∏—Ä–∞–µ–º —Å–∫—Ä–æ–ª–ª */
      }

      /* –£–±–∏—Ä–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
      .names-list::-webkit-scrollbar{
        display: none;
      }
    }

    @media (prefers-reduced-motion: reduce){
      *{animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important;}
      .confetti, .celebration-emoji, .celebration-word, .firework, .screen-flash {
        display: none !important;
      }
    }

    /* –ú–∏–∫—Ä–æ-–∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ iOS */
    @supports (-webkit-touch-callout: none) {
      body { background-attachment: scroll; }
    }
  </style>
</head>
<body>
  <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
  <div class="menu-container">
    <div class="menu-header">
      <button class="burger-btn" id="burgerBtn" aria-label="–ú–µ–Ω—é">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <nav class="menu-dropdown" id="menuDropdown">
      <a href="index.html">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      <a href="wheel-of-fortune.html">üé° –ö–æ–ª–µ—Å–æ</a>
      <a href="lottery-drum.html">üé± –õ–æ—Ç–æ—Ç—Ä–æ–Ω</a>
      <a href="crystal-ball.html">üîÆ –®–∞—Ä</a>
      <a href="plinko.html">üéØ –ü–ª–∏–Ω–∫–æ</a>
      <a href="racing.html">üèÅ –ì–æ–Ω–∫–∏</a>
      <a href="trading.html">üìà –¢—Ä–µ–π–¥–∏–Ω–≥</a>
    </nav>
  </div>

  <!-- –î–µ—Å–∫—Ç–æ–ø–Ω–æ–µ –º–µ–Ω—é -->
  <div class="top-buttons">
    <a href="index.html" class="top-btn">üè† –ì–ª–∞–≤–Ω–∞—è</a>
    <a href="wheel-of-fortune.html" class="top-btn">üé° –ö–æ–ª–µ—Å–æ</a>
    <a href="lottery-drum.html" class="top-btn">üé± –õ–æ—Ç–æ—Ç—Ä–æ–Ω</a>
    <a href="crystal-ball.html" class="top-btn">üîÆ –®–∞—Ä</a>
    <a href="plinko.html" class="top-btn">üéØ –ü–ª–∏–Ω–∫–æ</a>
    <a href="racing.html" class="top-btn">üèÅ –ì–æ–Ω–∫–∏</a>
    <a href="trading.html" class="top-btn">üìà –¢—Ä–µ–π–¥–∏–Ω–≥</a>
  </div>

  <div class="layout">
    <!-- –ü–∞–Ω–µ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
    <section class="card participants-panel">
      <div class="panel-header">
        <div class="panel-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
        <button class="equalize-btn" id="equalizeBtn">‚öñÔ∏è –£—Ä–∞–≤–Ω—è—Ç—å</button>
      </div>

      <div class="panel-body">
        <div class="headers-row">
          <div class="header-name">–ò–º—è</div>
          <div class="header-probability">üìä –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</div>
          <div class="header-remove"></div>
        </div>

        <div class="names-list" id="namesList"></div>

        <div class="add-name-container">
          <input id="newNameInput" class="name-input" type="text" placeholder="–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫" maxlength="15" />
          <button class="add-btn-small" id="addNameBtn" title="–î–æ–±–∞–≤–∏—Ç—å">‚ûï</button>
        </div>
      </div>
    </section>

    <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
    <section class="card board">
      <h1 class="title">üìà –¢–†–ï–ô–î–ò–ù–ì</h1>
      <div class="chart-wrap"><canvas id="chart"></canvas></div>
      <div class="controls"><button class="btn" id="runBtn">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é</button></div>
    </section>
  </div>

  <div class="winner-announcement" id="winnerAnnouncement">
    <h2 id="winnerText"></h2>
  </div>

<script>
/* ============================== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ============================== */
const colors = ['#ff6b6b','#ffd43b','#51cf66','#339af0','#da77f2','#66d9e8','#fb923c','#ec4899','#8b5cf6','#14b8a6','#f97316','#06b6d4'];
const NAMES_KEY = 'shared_names_v1';
const PROB_KEY = 'shared_probabilities_v2';
const LOCKED_KEY = 'shared_locked_v1';

/* ============================== –°–æ—Å—Ç–æ—è–Ω–∏–µ ============================== */
let names = ['–î–∏–º–∞','–°–∞—à–∞','–ù–∏–∫–∏—Ç–∞','–ú–∞–∫—Å–∏–º','–ö–∏—Ä–∏–ª–ª'];
let probabilities          = {};
let lockedParticipants     = {};
let hasCustomProbabilities = false;
let isLoadingFromStorage   = false;
let gameHasFinished        = false; // –§–ª–∞–≥, —á—Ç–æ –±—ã–ª–∞ —Å–µ—Å—Å–∏—è –∏ –æ–Ω–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å

/* ============================== –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã ============================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(freq, duration, volume = 0.1) {
  try {
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    
    oscillator.type = 'sine';
    oscillator.frequency.value = freq;
    gainNode.gain.value = volume;
    
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    const currentTime = audioCtx.currentTime;
    oscillator.start(currentTime);
    oscillator.stop(currentTime + duration);
  } catch(e) {}
}

function playWinFanfare() {
  const notes = [523, 659, 784, 1046, 784, 1046, 1319, 1568];
  notes.forEach((freq, i) => {
    setTimeout(() => playSound(freq, 0.2, 0.15), i * 150);
  });
}

function unlockAudio() {
  if(audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
}
document.addEventListener('touchstart', unlockAudio, {once: true});
document.addEventListener('click', unlockAudio, {once: true});

/* ============================== –¢—É–ª—Ç–∏–ø—ã ============================== */
function showErrorTooltip(message) {
  const existing = document.querySelector('.probability-error-tooltip');
  if (existing) existing.remove();
  
  const tooltip = document.createElement('div');
  tooltip.className = 'probability-error-tooltip';
  tooltip.textContent = message;
  document.body.appendChild(tooltip);
  
  playSound(300, 0.1, 0.2);
  
  setTimeout(() => {
    tooltip.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    tooltip.style.opacity = '0';
    tooltip.style.transform = 'translate(-50%, -50%) scale(0.8)';
    setTimeout(() => tooltip.remove(), 300);
  }, 2000);
}

/* ============================== DOM ============================== */
const chart = document.getElementById('chart');
const ctx   = chart.getContext('2d');
const namesList = document.getElementById('namesList');
const addNameBtn = document.getElementById('addNameBtn');
const newNameInput = document.getElementById('newNameInput');
const equalizeBtn = document.getElementById('equalizeBtn');
const runBtn = document.getElementById('runBtn');
const winnerAnnouncement = document.getElementById('winnerAnnouncement');
const winnerText = document.getElementById('winnerText');

/* ============================== –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é ============================== */
const burgerBtn = document.getElementById('burgerBtn');
const menuDropdown = document.getElementById('menuDropdown');
let menuOpen = false;

function toggleMenu() {
  menuOpen = !menuOpen;
  menuDropdown.classList.toggle('active', menuOpen);
  burgerBtn.classList.toggle('active', menuOpen);
}

if (burgerBtn) {
  burgerBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleMenu();
  });

  document.addEventListener('click', (e) => {
    if (menuOpen && !menuDropdown.contains(e.target) && !burgerBtn.contains(e.target)) {
      toggleMenu();
    }
  });
}

/* ============================== LocalStorage –∏–º–µ–Ω ============================== */
try{
  const saved = JSON.parse(localStorage.getItem(NAMES_KEY) || '[]');
  if (Array.isArray(saved) && saved.length) names = saved;
  else localStorage.setItem(NAMES_KEY, JSON.stringify(names));
}catch(e){}
const saveNames = ()=>{ try{ localStorage.setItem(NAMES_KEY, JSON.stringify(names)); }catch(e){} };

/* ============================== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏ ============================== */
function initProbabilities() {
  isLoadingFromStorage = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏

  try {
    const saved = JSON.parse(localStorage.getItem(PROB_KEY) || '{}');
    const savedLocked = JSON.parse(localStorage.getItem(LOCKED_KEY) || '{}');

    if (saved?.hasCustomProbabilities && saved?.probabilities && Object.keys(saved.probabilities).length) {
      probabilities = { ...saved.probabilities };
      lockedParticipants = { ...savedLocked };
      hasCustomProbabilities = true;

      // –£–¥–∞–ª—è–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ names
      Object.keys(probabilities).forEach((n) => { if (!names.includes(n)) delete probabilities[n]; });
      Object.keys(lockedParticipants).forEach((n) => { if (!names.includes(n)) delete lockedParticipants[n]; });

      // –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–µ—Å–ª–∏ –±—ã–ª–∏ –æ–±—Ä–µ–∑–∞–Ω—ã –¥–æ 20)
      names.forEach((n) => { if (!(n in probabilities)) probabilities[n] = 0.05; });

      // –í–∞–ª–∏–¥–∞—Ü–∏—è 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –º–µ–Ω–µ–µ 5%
      validateAndFixProbabilities();

      // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º - –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Å—Ç–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã
    } else {
      setEqualProbabilities();
    }
  } catch(_) {
    setEqualProbabilities();
  }

  isLoadingFromStorage = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
}

function validateAndFixProbabilities() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –º–µ–Ω–µ–µ 5%
  const belowMin = names.filter(n => (probabilities[n] ?? 0) < 0.05);

  if (belowMin.length === 0) {
    // –í—Å—ë –æ–∫, –ø—Ä–æ—Å—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
    const sum = names.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
    if (Math.abs(sum - 1) > 1e-4) {
      const k = 1 / sum;
      names.forEach((nm) => probabilities[nm] = (probabilities[nm] || 0) * k);
    }
    return;
  }

  // –ï—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é < 5%
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º 5%
  belowMin.forEach(n => probabilities[n] = 0.05);

  // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ 5%
  const fixedSum = belowMin.length * 0.05;
  const others = names.filter(n => !belowMin.includes(n));

  if (others.length === 0) {
    // –í—Å–µ –±—ã–ª–∏ –Ω–∏–∂–µ 5% - –¥–µ–ª–∞–µ–º —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
    setEqualProbabilities();
    return;
  }

  // –°—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—É–º–º—É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
  const othersSum = others.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
  const remainForOthers = 1 - fixedSum;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ–º –ª–∏ –º—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
  if (othersSum > 0) {
    const scale = remainForOthers / othersSum;
    others.forEach(nm => probabilities[nm] = (probabilities[nm] || 0) * scale);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—Ç–∞–ª –ª–∏ –∫—Ç–æ-—Ç–æ –º–µ–Ω—å—à–µ 5% –ø–æ—Å–ª–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    const stillBelowMin = others.some(nm => (probabilities[nm] ?? 0) < 0.05);

    if (stillBelowMin) {
      // –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ - —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
      setEqualProbabilities();
    }
  } else {
    // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–ø–æ—Ä—Ü–∏—è—Ö - —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
    setEqualProbabilities();
  }
}

function setEqualProbabilities() {
  const p = 1 / (names.length || 1);
  probabilities = {};
  names.forEach((nm) => probabilities[nm] = p);
  lockedParticipants = {};
  hasCustomProbabilities = false;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ù–ï –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
  if (!isLoadingFromStorage) {
    saveProbabilities();
  }
}

function clampProbabilitiesMin(min = 0.05) {
  names.forEach((nm) => { if ((probabilities[nm] ?? 0) < min) probabilities[nm] = min; });
}

function normalizeProbabilities() {
  // –ï—Å–ª–∏ –Ω–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π - –ø—Ä–æ—Å—Ç–æ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
  if (!hasCustomProbabilities) {
    const exact = 1 / (names.length || 1);
    names.forEach((nm) => probabilities[nm] = exact);
    return;
  }

  // –†–∞–∑–¥–µ–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏ –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
  const locked = names.filter(n => lockedParticipants[n]);
  const unlocked = names.filter(n => !lockedParticipants[n]);

  // –ï—Å–ª–∏ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã - –ø—Ä–æ—Å—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
  if (unlocked.length === 0) {
    const sum = names.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
    if (sum > 0 && Math.abs(sum - 1) > 1e-4) {
      const k = 1 / sum;
      names.forEach((nm) => probabilities[nm] = (probabilities[nm] || 0) * k);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º—É–º 5% —Å –±–û–ª—å—à–µ–π –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å—é
    const hasViolation = names.some(nm => (probabilities[nm] ?? 0) < 0.049);
    if (hasViolation) {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å—ë
      setEqualProbabilities();
    }
    return;
  }

  // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
  const lockedSum = locked.reduce((s, nm) => s + (probabilities[nm] || 0), 0);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–æ–∑–º–æ–∂–Ω–æ –ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
  const minUnlockedTotal = unlocked.length * 0.05; // –º–∏–Ω–∏–º—É–º –¥–ª—è –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
  const remainForUnlocked = 1 - lockedSum;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å –±–û–ª—å—à–µ–π –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å—é
  const lockedViolation = locked.some(nm => (probabilities[nm] ?? 0) < 0.049);

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å 0.001 (0.1%) –≤–º–µ—Å—Ç–æ 1e-6
  if (lockedViolation || remainForUnlocked < minUnlockedTotal - 0.001 || lockedSum > 1.001) {
    // –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–±–ª—é—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ 5% - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∏–∫—Å–∞—Ü–∏–∏
    setEqualProbabilities();
    return;
  }

  // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –ø–æ—Ä–æ–≤–Ω—É –º–µ–∂–¥—É –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏
  const sharePerUnlocked = remainForUnlocked / unlocked.length;
  unlocked.forEach(nm => probabilities[nm] = sharePerUnlocked);

  // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∏–Ω–∏–º—É–º 5% —Å –±–û–ª—å—à–µ–π –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å—é
  const finalViolation = names.some(nm => (probabilities[nm] ?? 0) < 0.049);
  if (finalViolation) {
    setEqualProbabilities();
  }
}

function saveProbabilities() {
  try {
    const cleanP = {};
    names.forEach((nm) => cleanP[nm] = probabilities[nm] ?? 0);

    const cleanLocked = {};
    names.forEach((nm) => { if (lockedParticipants[nm]) cleanLocked[nm] = true; });

    localStorage.setItem(PROB_KEY, JSON.stringify({
      probabilities: cleanP,
      hasCustomProbabilities
    }));
    localStorage.setItem(LOCKED_KEY, JSON.stringify(cleanLocked));
  } catch (_) {}
}

function getRealisticMaxPercent(name) {
  // –í—Å–µ –¥—Ä—É–≥–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ
  const otherLocked = names.filter(n => lockedParticipants[n] && n !== name);
  // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ (–æ–Ω –±—É–¥–µ—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ –≤–≤–æ–¥–µ)
  const willBeUnlocked = names.filter(n => !lockedParticipants[n] && n !== name);

  const otherLockedSum = otherLocked.reduce(
    (s, nm) => s + (probabilities[nm] || 0),
    0
  );

  // –ú–∏–Ω–∏–º—É–º –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö (–ø–æ 5%)
  const minUnlockedTotal = willBeUnlocked.length * 0.05;

  // –°–∫–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ –æ—Ç–¥–∞—Ç—å —Ç–µ–∫—É—â–µ–º—É, —á—Ç–æ–±—ã –æ—Å—Ç–∞–ª—å–Ω—ã–º —Ö–≤–∞—Ç–∏–ª–æ –Ω–∞ –∏—Ö 5%
  const rawMax = (1 - otherLockedSum - minUnlockedTotal) * 100;

  // –û–±—Ä–µ–∑–∞–µ–º –æ—Ç 5 –¥–æ 100, —á—Ç–æ–±—ã –Ω–µ —É—Ö–æ–¥–∏—Ç—å –≤ –±—Ä–µ–¥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  return Math.max(5, Math.min(100, rawMax));
}

function getProbabilityPercent(name) {
  if (!hasCustomProbabilities && names.length) return (100 / names.length).toFixed(1);
  return (((probabilities[name] || 0) * 100).toFixed(1));
}

function adjustProbability(name, delta) {
  const cur = parseFloat(getProbabilityPercent(name)) || 0;
  const maxPossible = 100 - (names.length - 1) * 5;
  const next = Math.max(5, Math.min(maxPossible, cur + delta));

  // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º/–º–∏–Ω–∏–º—É–º), –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  if (Math.abs(next - cur) < 0.01) {
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏–≤–µ–¥—ë—Ç –ª–∏ —ç—Ç–æ –∫ –Ω–∞—Ä—É—à–µ–Ω–∏—é –ø—Ä–∞–≤–∏–ª–∞ 5%
  // –¢–µ–∫—É—â–∏–π —É—á–∞—Å—Ç–Ω–∏–∫ –ë–£–î–ï–¢ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è
  const otherLocked = names.filter(n => lockedParticipants[n] && n !== name);
  const willBeUnlocked = names.filter(n => !lockedParticipants[n] && n !== name);
  const otherLockedSum = otherLocked.reduce((s, nm) => s + (probabilities[nm] || 0), 0);
  const newProbForThis = next / 100;
  const remainForUnlocked = 1 - otherLockedSum - newProbForThis;
  const minUnlockedTotal = willBeUnlocked.length * 0.05;

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å 0.001 (0.1%) –≤–º–µ—Å—Ç–æ 1e-6
  if (remainForUnlocked < minUnlockedTotal - 0.001) {
    const realisticMax = getRealisticMaxPercent(name);
    showErrorTooltip(`–ú–∏–Ω–∏–º—É–º 5.0%, –º–∞–∫—Å–∏–º—É–º ${realisticMax.toFixed(1)}%`);
    return;
  }

  setProbabilityManually(name, next);
  renderNames();

  // –ï—Å–ª–∏ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–≥—Ä–∞, –æ—á–∏—â–∞–µ–º —Å–≤–µ—á–∏
  if (gameHasFinished) {
    clearCandles();
    gameHasFinished = false;
  }
}

function setProbabilityManually(name, percentValue) {
  const maxPossible = getRealisticMaxPercent(name);

  if (isNaN(percentValue) || percentValue < 5 || percentValue > maxPossible) {
    showErrorTooltip(`–ú–∏–Ω–∏–º—É–º 5.0%, –º–∞–∫—Å–∏–º—É–º ${maxPossible.toFixed(1)}%`);
    return false;
  }

  hasCustomProbabilities = true;

  lockedParticipants[name] = true;
  probabilities[name] = percentValue / 100;

  normalizeProbabilities();
  saveProbabilities();
  return true;
}

function equalizeProbabilities() {
  setEqualProbabilities();
  renderNames();
  rebuildZones();

  // –ï—Å–ª–∏ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–≥—Ä–∞, –æ—á–∏—â–∞–µ–º —Å–≤–µ—á–∏
  if (gameHasFinished) {
    clearCandles();
    gameHasFinished = false;
  } else {
    drawChart();
  }
}

/* ============================== UI –∏–º—ë–Ω ============================== */
function renderNames(){
  namesList.innerHTML='';
  names.forEach((name, idx)=>{
    const row = document.createElement('div'); 
    row.className='name-item';

    const input = document.createElement('input');
    input.className='name-input';
    input.type='text';
    input.value=name;
    input.placeholder='–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
    input.maxLength = 15;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –º–∞–∫—Å–∏–º—É–º–µ 15 —Å–∏–º–≤–æ–ª–æ–≤
    input.addEventListener('keydown', (e) => {
      if (input.value.length >= 15 &&
          !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'].includes(e.key) &&
          !e.ctrlKey && !e.metaKey) {

        input.style.borderColor = '#ef4444';
        input.style.background = 'rgba(239,68,68,0.1)';
        const originalPlaceholder = input.placeholder;
        input.placeholder = '‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤';

        showErrorTooltip('–ú–∞–∫—Å–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤');

        setTimeout(() => {
          input.placeholder = originalPlaceholder;
          if (input.value.trim()) {
            input.style.borderColor = 'rgba(255,255,255,0.2)';
            input.style.background = 'rgba(255,255,255,0.1)';
          }
        }, 1500);
      }
    });

    input.addEventListener('input', ()=>{
      const v=input.value.trim();

      // –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Å—Ç–æ–µ –∏–º—è (0 —Å–∏–º–≤–æ–ª–æ–≤) –∫–∞–∫ –≤ plinko
      if(!v || v.length === 0) {
        input.style.borderColor='#ef4444';
        input.style.background='rgba(239,68,68,0.1)';

        const oldName = names[idx];
        if (oldName in probabilities) {
          probabilities[''] = probabilities[oldName];
          delete probabilities[oldName];
        }
        if (oldName in lockedParticipants) {
          lockedParticipants[''] = true;
          delete lockedParticipants[oldName];
        }
        names[idx] = '';
        saveNames();
        saveProbabilities();
        rebuildZones();
        drawChart();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∏–º–µ–Ω (–∑–∞–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å")
        validateAllNames();
        return;
      }

      const dup = names.some((n,i)=>i!==idx && n.toLowerCase()===v.toLowerCase());
      if (dup){
        input.style.borderColor='#ef4444';
        input.style.background='rgba(239,68,68,0.1)';
        return;
      }

      input.style.borderColor='rgba(255,255,255,0.2)';
      input.style.background='rgba(255,255,255,0.1)';

      const oldName = names[idx];

      if (oldName in probabilities) {
        probabilities[v] = probabilities[oldName];
        delete probabilities[oldName];
      }
      if (oldName in lockedParticipants) {
        lockedParticipants[v] = true;
        delete lockedParticipants[oldName];
      }
      saveProbabilities();

      names[idx]=v;
      saveNames();
      rebuildZones();
      drawChart();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∏–º–µ–Ω
      validateAllNames();
    });

    input.addEventListener('blur', ()=>{
      const v=input.value.trim();
      if(!v) {
        input.value = names[idx];
        input.style.borderColor='rgba(255,255,255,0.2)'; 
        input.style.background='rgba(255,255,255,0.1)';
        return;
      }
      
      const dup = names.some((n,i)=>i!==idx && n.toLowerCase()===v.toLowerCase());
      if(dup) {
        input.value = names[idx];
        input.style.borderColor='rgba(255,255,255,0.2)'; 
        input.style.background='rgba(255,255,255,0.1)';
      }
    });

    const controls = document.createElement('div'); 
    controls.className='probability-controls';

    const minus = document.createElement('button');
    minus.className='prob-btn';
    minus.textContent='‚àí';
    minus.onclick=()=>{
      adjustProbability(name,-1);
      rebuildZones();

      // –°–≤–µ—á–∏ —É–∂–µ –æ—á–∏—â–µ–Ω—ã –≤ adjustProbability –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      if (!gameHasFinished) {
        drawChart();
      }
    };

    const prob = document.createElement('input');
    prob.className='probability-input'; 
    prob.type='text'; 
    prob.inputMode='decimal';
    prob.value = getProbabilityPercent(name);
    if (lockedParticipants[name]) {
      prob.classList.add('manual');
    }

    let lastValid = prob.value;

    prob.addEventListener('focus', ()=>{ 
      prob.value = prob.value.replace('%', '');
      lastValid = prob.value; 
    });

    prob.addEventListener('input', ()=>{
      const val = prob.value.replace('%', '').trim();
      const num = parseFloat(val);
      if (val === '' || (num >= 0.1 && num <= 99.9)){
        prob.classList.remove('error');
      } else {
        prob.classList.add('error');
      }
    });

    prob.addEventListener('blur', ()=>{
      const val = prob.value.replace('%', '').trim();
      const num = parseFloat(val);

      if (val === ''){ 
        prob.value = lastValid; 
        prob.classList.remove('error'); 
        showErrorTooltip('–ü–æ–ª–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
        return; 
      }

      if (isNaN(num)){ 
        prob.value = lastValid; 
        prob.classList.remove('error'); 
        showErrorTooltip('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ');
        return; 
      }

      if (num < 0.1){ 
        prob.value = lastValid; 
        prob.classList.remove('error'); 
        showErrorTooltip('–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 0.1%');
        return; 
      }

      if (num > 99.9){ 
        prob.value = lastValid; 
        prob.classList.remove('error'); 
        showErrorTooltip('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 99.9%');
        return; 
      }

      if (setProbabilityManually(name, num)){
        lastValid = getProbabilityPercent(name);
        renderNames();
        rebuildZones();

        // –ï—Å–ª–∏ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–≥—Ä–∞, –æ—á–∏—â–∞–µ–º —Å–≤–µ—á–∏
        if (gameHasFinished) {
          clearCandles();
          gameHasFinished = false;
        } else {
          drawChart();
        }
      } else {
        prob.value = lastValid;
        prob.classList.remove('error');
      }
    });

    prob.addEventListener('keypress', e=>{
      if (e.key==='Enter') { 
        e.preventDefault(); 
        prob.blur(); 
      }
      if (!/[\d.]/.test(e.key) && e.key!=='Enter') e.preventDefault();
    });

    const plus = document.createElement('button');
    plus.className='prob-btn';
    plus.textContent='+';
    plus.onclick=()=>{
      adjustProbability(name,1);
      rebuildZones();

      // –°–≤–µ—á–∏ —É–∂–µ –æ—á–∏—â–µ–Ω—ã –≤ adjustProbability –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      if (!gameHasFinished) {
        drawChart();
      }
    };

    controls.append(minus, prob, plus);

    const del = document.createElement('button'); 
    del.className='remove-btn'; 
    del.textContent='‚úï';
    del.onclick=()=>{
      if (names.length<=2) {
        showErrorTooltip('–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞!');
        return;
      }
      const removedName = names[idx]; 
      names.splice(idx,1); 
      delete probabilities[removedName];
      delete lockedParticipants[removedName];

      saveNames();
      normalizeProbabilities();
      saveProbabilities();
      
      renderNames(); 
      rebuildZones(); 
      drawChart();
    };

    row.append(input, controls, del);
    namesList.appendChild(row);
  });

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∏–º–µ–Ω –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
  validateAllNames();
}

function validateAllNames() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—É—Å—Ç—ã–µ –∏–º–µ–Ω–∞ (0 —Å–∏–º–≤–æ–ª–æ–≤)
  const hasEmptyNames = names.some(name => !name || name.trim().length === 0);

  // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—É—Å—Ç—ã–µ –∏–º–µ–Ω–∞, –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é"
  if (hasEmptyNames) {
    runBtn.disabled = true;
    runBtn.style.opacity = '0.5';
    runBtn.style.cursor = 'not-allowed';
  } else {
    // –ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã, –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º
    if (!running) {
      runBtn.disabled = false;
      runBtn.style.opacity = '';
      runBtn.style.cursor = '';
    }
  }
}

function lockProbabilityInputs() {
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∏–Ω–ø—É—Ç—ã –∏–º–µ–Ω, –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –∏ –∫–Ω–æ–ø–∫–∏ +/-
  document.querySelectorAll('.name-input, .probability-input, .prob-btn, .remove-btn').forEach(el => {
    el.disabled = true;
    el.style.opacity = '0.5';
    el.style.cursor = 'not-allowed';
  });

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é"
  runBtn.disabled = true;
  runBtn.style.opacity = '0.5';
  runBtn.style.cursor = 'not-allowed';

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
  newNameInput.disabled = true;
  newNameInput.style.opacity = '0.5';
  newNameInput.style.cursor = 'not-allowed';

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–£—Ä–∞–≤–Ω—è—Ç—å"
  equalizeBtn.disabled = true;
  equalizeBtn.style.opacity = '0.5';
  equalizeBtn.style.cursor = 'not-allowed';
}

function unlockProbabilityInputs() {
  // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∏–Ω–ø—É—Ç—ã –∏–º–µ–Ω, –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –∏ –∫–Ω–æ–ø–∫–∏ +/-
  document.querySelectorAll('.name-input, .probability-input, .prob-btn, .remove-btn').forEach(el => {
    el.disabled = false;
    el.style.opacity = '';
    el.style.cursor = '';
  });

  // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é"
  runBtn.disabled = false;
  runBtn.style.opacity = '';
  runBtn.style.cursor = '';

  // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
  newNameInput.disabled = false;
  newNameInput.style.opacity = '';
  newNameInput.style.cursor = '';

  // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–£—Ä–∞–≤–Ω—è—Ç—å"
  equalizeBtn.disabled = false;
  equalizeBtn.style.opacity = '';
  equalizeBtn.style.cursor = '';
}

function addNew(){
  const v=newNameInput.value.trim();

  if(!v) {
    showErrorTooltip('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞');
    newNameInput.style.borderColor='#ef4444';
    newNameInput.style.background='rgba(239,68,68,0.1)';
    setTimeout(()=>{
      newNameInput.style.borderColor='rgba(255,255,255,0.2)';
      newNameInput.style.background='rgba(255,255,255,0.1)';
    },900);
    return;
  }

  if (names.length >= 20) {
    showErrorTooltip('–ú–∞–∫—Å–∏–º—É–º 20 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
    newNameInput.style.borderColor='#ef4444';
    newNameInput.style.background='rgba(239,68,68,0.1)';
    newNameInput.value = '';
    setTimeout(()=>{
      newNameInput.style.borderColor='rgba(255,255,255,0.2)';
      newNameInput.style.background='rgba(255,255,255,0.1)';
    },900);
    return;
  }

  if (names.some(n=>n.toLowerCase()===v.toLowerCase())){
    showErrorTooltip('–£—á–∞—Å—Ç–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
    newNameInput.style.borderColor='#ef4444';
    newNameInput.style.background='rgba(239,68,68,0.1)';
    setTimeout(()=>{
      newNameInput.style.borderColor='rgba(255,255,255,0.2)';
      newNameInput.style.background='rgba(255,255,255,0.1)';
    },900);
    return;
  }

  newNameInput.value='';
  newNameInput.style.borderColor='rgba(255,255,255,0.2)';
  newNameInput.style.background='rgba(255,255,255,0.1)';

  names.push(v);
  saveNames();

  probabilities[v] = 1 / names.length;
  normalizeProbabilities();
  saveProbabilities();

  renderNames();
  rebuildZones();
  drawChart();
}

addNameBtn.addEventListener('click', addNew);
newNameInput.addEventListener('keypress', e=>{ if(e.key==='Enter') addNew(); });
equalizeBtn.addEventListener('click', equalizeProbabilities);

/* ============================== –ì—Ä–∞—Ñ–∏–∫ ============================== */
let DPR = Math.max(1, Math.min(3, window.devicePixelRatio||1));
let W=0, H=0, PADDING_LEFT=80, PADDING_RIGHT=50, PADDING_TOP=50, PADDING_BOTTOM=50;
const MAX_CANDLES=48;

function resize(){
  const wrap = document.querySelector('.chart-wrap');
  const cssW = wrap.clientWidth, cssH=wrap.clientHeight;
  DPR = Math.max(1, Math.min(3, window.devicePixelRatio||1));
  chart.style.width = cssW+'px'; chart.style.height = cssH+'px';
  chart.width = Math.round(cssW*DPR); chart.height = Math.round(cssH*DPR);
  ctx.setTransform(1,0,0,1,0,0); ctx.scale(DPR,DPR);
  W=cssW; H=cssH;
  
  if(window.innerWidth <= 480) {
    PADDING_LEFT = 60;
    PADDING_RIGHT = 35;
    PADDING_TOP = 40;
    PADDING_BOTTOM = 40;
  } else if(window.innerWidth <= 980) {
    PADDING_LEFT = 70;
    PADDING_RIGHT = 40;
    PADDING_TOP = 45;
    PADDING_BOTTOM = 45;
  } else {
    PADDING_LEFT = 80;
    PADDING_RIGHT = 50;
    PADDING_TOP = 50;
    PADDING_BOTTOM = 50;
  }
  
  rebuildZones(); drawChart();
}
window.addEventListener('resize', ()=>{ clearTimeout(window.__rs); window.__rs=setTimeout(resize,120); });

let zones=[];
function rebuildZones(){
  zones=[];
  const top=PADDING_TOP, bottom=H-PADDING_BOTTOM;
  let acc=top;
  names.forEach((n,i)=>{
    const h = Math.max(8,(probabilities[n]||0)*(bottom-top));
    const y0 = acc, y1 = Math.min(bottom, acc+h); acc=y1;
    zones.push({name:n,y0,y1,color:colors[i%colors.length]});
  });
}

let candles=[];
function clearCandles(){
  candles = [];
  drawChart();
}

function seedCandles(){
  candles=[];
  const top=PADDING_TOP, bottom=H-PADDING_BOTTOM;
  let price = top + Math.random()*(bottom-top);
  const BASE = Math.max(8, (bottom-top)*0.035);
  const isMobile = window.innerWidth <= 980;
  const WICK = isMobile ? Math.max(3, (bottom-top)*0.0125) : Math.max(6, (bottom-top)*0.025); // –í 2 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö
  const dojiChance = isMobile ? 0.2 : 0; // 20% —à–∞–Ω—Å –¥–æ–¥–∂–∏ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö
  const highLowBarChance = isMobile ? 0.15 : 0; // 15% —à–∞–Ω—Å High-Low Bar –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö
  const hist=17;
  for(let i=0;i<hist;i++){
    const rand = Math.random();
    const isHighLowBar = isMobile && rand < highLowBarChance;
    const isDoji = isMobile && !isHighLowBar && rand < (highLowBarChance + dojiChance);
    let drift, o, c, hi, lo;

    if(isHighLowBar) {
      // High-Low Bar: –Ω–µ—Ç —Ç–µ–ª–∞, —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
      drift = 0; // –ù–µ—Ç —Ç–µ–ª–∞ –≤–æ–æ–±—â–µ
      o = price;
      c = price; // open == close
      hi = price - (Math.random()*WICK*1.5 + WICK*0.5);
      lo = price + (Math.random()*WICK*1.5 + WICK*0.5);
    } else if(isDoji) {
      // –î–æ–¥–∂–∏: –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–æ–µ —Ç–µ–ª–æ, –¥–ª–∏–Ω–Ω—ã–µ —Ñ–∏—Ç–∏–ª–∏
      drift = (Math.random()-0.5) * BASE * 0.1; // –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π drift
      o = price;
      c = price + drift;
      // –î–ª–∏–Ω–Ω—ã–µ —Ñ–∏—Ç–∏–ª–∏ –¥–ª—è –¥–æ–¥–∂–∏
      hi = Math.min(o,c) - (Math.random()*WICK*2 + WICK);
      lo = Math.max(o,c) + (Math.random()*WICK*2 + WICK);
    } else {
      // –û–±—ã—á–Ω–∞—è —Å–≤–µ—á–∞
      drift = (Math.random()-0.5)*BASE*2;
      o = price;
      c = price + drift;
      hi = Math.min(o,c) - (Math.random()*WICK+2);
      lo = Math.max(o,c) + (Math.random()*WICK+2);
    }

    candles.push({o, h:Math.min(hi,o,c), l:Math.max(lo,o,c), c, isHighLowBar});
    price=c;
    if(price<top+8) price=top+8+Math.random()*12;
    if(price>bottom-8) price=bottom-8-Math.random()*12;
  }
}

function drawChart(priceY=null, elapsed=0, total=1){
  ctx.clearRect(0,0,W,H);

  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'rgba(102,126,234,.08)'); grad.addColorStop(1,'rgba(118,75,162,.08)');
  ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);

  const nameSize = window.innerWidth <= 480 ? 11 : window.innerWidth <= 980 ? 12 : 14;
  const timerSize = window.innerWidth <= 480 ? 13 : window.innerWidth <= 980 ? 14 : 16;
  const finishSize = window.innerWidth <= 480 ? 11 : window.innerWidth <= 980 ? 12 : 14;
  const candleWidth = window.innerWidth <= 480 ? 1 : window.innerWidth <= 980 ? 1.5 : 6;
  const lineThickness = window.innerWidth <= 480 ? 3 : 4;

  zones.forEach(z=>{
    ctx.fillStyle = z.color + '1a';
    ctx.fillRect(PADDING_LEFT,z.y0,W-PADDING_LEFT-PADDING_RIGHT,z.y1-z.y0);
    ctx.strokeStyle='rgba(255,255,255,0.15)';
    ctx.beginPath(); ctx.moveTo(PADDING_LEFT,z.y1); ctx.lineTo(W-PADDING_RIGHT,z.y1); ctx.stroke();
    
    const zoneHeight = z.y1 - z.y0;
    if(zoneHeight > 20) {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à—Ä–∏—Ñ—Ç –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
      const fontStyle = `800 ${nameSize}px Montserrat, sans-serif`;
      ctx.font = fontStyle;
      ctx.fillStyle='rgba(255,255,255,0.85)';
      ctx.textAlign='left';
      const maxWidth = PADDING_LEFT - 12;
      let displayName = z.name;

      // –ï—Å–ª–∏ –∏–º—è –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
      if(z.name.length < 8) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–ª–µ–∑–∞–µ—Ç –ª–∏ –æ–Ω–æ –≤ maxWidth
        if(ctx.measureText(displayName).width > maxWidth) {
          displayName = z.name.substring(0, 3) + '..';
        }
      } else {
        // –ï—Å–ª–∏ 8+ —Å–∏–º–≤–æ–ª–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
        if(ctx.measureText(displayName).width > maxWidth) {
          displayName = z.name.substring(0, 3) + '..';
        }
      }
      // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —à—Ä–∏—Ñ—Ç –≤—Å—ë –µ—â—ë —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
      ctx.font = fontStyle;
      ctx.fillText(displayName, 6, (z.y0+z.y1)/2+4);
    }
  });

  ctx.strokeStyle='rgba(255,255,255,0.08)';
  const gridLines = window.innerWidth <= 480 ? 4 : 6;
  for(let i=0;i<gridLines;i++){
    const x=PADDING_LEFT+(W-PADDING_LEFT-PADDING_RIGHT)*(i/(gridLines-1));
    ctx.beginPath(); ctx.moveTo(x,PADDING_TOP); ctx.lineTo(x,H-PADDING_BOTTOM); ctx.stroke();
  }

  ctx.setLineDash([8,8]); 
  ctx.strokeStyle='rgba(255,212,59,0.95)'; 
  ctx.lineWidth=lineThickness;
  ctx.shadowColor='rgba(255,212,59,0.8)'; 
  ctx.shadowBlur=12;
  ctx.beginPath(); 
  ctx.moveTo(W-PADDING_RIGHT,PADDING_TOP); 
  ctx.lineTo(W-PADDING_RIGHT,H-PADDING_BOTTOM); 
  ctx.stroke();
  ctx.shadowBlur=0;
  ctx.setLineDash([]);
  
  ctx.fillStyle='#ffd43b'; 
  ctx.font=`800 ${finishSize}px Montserrat, sans-serif`; 
  ctx.textAlign='center';
  ctx.fillText('üèÅ –§–ò–ù–ò–®', W-PADDING_RIGHT, PADDING_TOP-12);

  const leftMs = Math.max(0,total-elapsed);
  ctx.fillStyle='#ffd43b'; ctx.font=`800 ${timerSize}px Montserrat, sans-serif`; ctx.textAlign='left';
  ctx.shadowColor='rgba(0,0,0,0.3)'; ctx.shadowBlur=4;
  ctx.fillText(`‚è± ${(leftMs/1000).toFixed(1)}s`, PADDING_LEFT+4, PADDING_TOP-12); ctx.shadowBlur=0;

  const p=Math.max(0,Math.min(1,elapsed/total));
  const progressHeight = window.innerWidth <= 480 ? 6 : 8;
  ctx.fillStyle='rgba(255,255,255,0.15)'; 
  ctx.fillRect(PADDING_LEFT, H-PADDING_BOTTOM+8, W-PADDING_LEFT-PADDING_RIGHT, progressHeight);
  const pg = ctx.createLinearGradient(PADDING_LEFT,0,W-PADDING_RIGHT,0);
  pg.addColorStop(0,'#667eea'); pg.addColorStop(1,'#764ba2');
  ctx.fillStyle=pg; 
  ctx.fillRect(PADDING_LEFT, H-PADDING_BOTTOM+8, (W-PADDING_LEFT-PADDING_RIGHT)*p, progressHeight);

  const plotW=W-PADDING_LEFT-PADDING_RIGHT;
  const step=plotW/(MAX_CANDLES-1);
  for(let i=0;i<candles.length;i++){
    const x=PADDING_LEFT+i*step, c=candles[i];

    if(c.isHighLowBar) {
      // High-Low Bar: —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π —á—ë—Ä—Ç–æ—á–∫–æ–π
      ctx.strokeStyle='rgba(255,255,255,0.6)';
      ctx.lineWidth=window.innerWidth <= 480 ? 1.5 : 2;
      ctx.beginPath();
      ctx.moveTo(x,c.h);
      ctx.lineTo(x,c.l);
      ctx.stroke();

      // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —á—ë—Ä—Ç–æ—á–∫–∞ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ (close price)
      const tickWidth = candleWidth * 2;
      ctx.strokeStyle='#ffd43b';
      ctx.lineWidth=window.innerWidth <= 480 ? 1.5 : 2;
      ctx.beginPath();
      ctx.moveTo(x-tickWidth, c.c);
      ctx.lineTo(x+tickWidth, c.c);
      ctx.stroke();
    } else {
      // –û–±—ã—á–Ω–∞—è —Å–≤–µ—á–∞ –∏–ª–∏ –¥–æ–¥–∂–∏
      ctx.strokeStyle='rgba(255,255,255,0.5)';
      ctx.lineWidth=window.innerWidth <= 480 ? 1.5 : 2;
      ctx.beginPath();
      ctx.moveTo(x,c.h);
      ctx.lineTo(x,c.l);
      ctx.stroke();

      const up=c.c<=c.o;
      ctx.fillStyle=up?'#51cf66':'#ff6b6b';
      const y=Math.min(c.o,c.c);
      const h=Math.max(4,Math.abs(c.o-c.c));
      ctx.fillRect(x-candleWidth,y,candleWidth*2,h);
      ctx.strokeStyle=up?'#40c057':'#fa5252';
      ctx.lineWidth=window.innerWidth <= 480 ? 1 : 1.5;
      ctx.strokeRect(x-candleWidth,y,candleWidth*2,h);
    }
  }

  if(priceY!=null){
    const priceLineWidth = window.innerWidth <= 480 ? 2.5 : 3;
    const priceCircleR = window.innerWidth <= 480 ? 5 : 6;
    ctx.strokeStyle='#ffd43b'; ctx.lineWidth=priceLineWidth; ctx.shadowColor='rgba(255,212,59,0.5)'; ctx.shadowBlur=8;
    ctx.beginPath(); ctx.moveTo(PADDING_LEFT,priceY); ctx.lineTo(W-PADDING_RIGHT,priceY); ctx.stroke(); ctx.shadowBlur=0;
    ctx.fillStyle='#ffd43b'; ctx.beginPath(); ctx.arc(W-PADDING_RIGHT,priceY,priceCircleR,0,Math.PI*2); ctx.fill();
  }
}

/* ============================== –°–∏–º—É–ª—è—Ü–∏—è ============================== */
let animId=null, running=false, startTime=0, duration=6000;
let lastCandleTime=0, candlePeriod=190;
let priceY=null, vel=0;

function announce(name){
  winnerText.textContent = 'üéâ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ' + name + ' üéâ';
  winnerAnnouncement.classList.add('show');

  createScreenFlash();
  playWinFanfare();

  setTimeout(() => createConfetti(), 100);
  setTimeout(() => createFireworks(), 200);
  setTimeout(() => createCelebrationEmojis(), 300);
  setTimeout(() => createCelebrationWords(), 500);

  // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω–ø—É—Ç—ã –ø–æ—Å–ª–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
  unlockProbabilityInputs();

  setTimeout(()=>winnerAnnouncement.classList.remove('show'), 3500);
}

/* ============================== –ü—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ ============================== */
function createScreenFlash(){
  const flash = document.createElement('div');
  flash.className = 'screen-flash';
  document.body.appendChild(flash);
  setTimeout(() => flash.remove(), 600);
}

function createConfetti(){
  const colors = ['#ff6b6b','#ffd43b','#51cf66','#339af0','#da77f2','#66d9e8','#fb923c','#ec4899','#8b5cf6','#14b8a6'];
  const isMobile = window.innerWidth <= 980;
  const count = isMobile ? 60 : 120;
  
  for(let i=0; i<count; i++){
    setTimeout(()=>{
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = (Math.random() * 100) + '%';
      confetti.style.top = '-20px';
      confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.width = (5 + Math.random() * 10) + 'px';
      confetti.style.height = (5 + Math.random() * 10) + 'px';
      confetti.style.animationDelay = (Math.random() * 0.5) + 's';
      confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 4000);
    }, i * 25);
  }
}

function createCelebrationEmojis(){
  const emojis = ['üéâ', 'üéä', 'üèÜ', '‚≠ê', '‚ú®', 'üéØ', 'üî•', 'üí´', 'üåü', 'üëè', 'üôå', 'üéà', 'üéÜ', 'üí•', 'ü•≥', 'üéÅ', 'üçæ', 'ü•á', 'üíé'];
  const isMobile = window.innerWidth <= 980;
  const count = isMobile ? 15 : 25;
  
  for(let i=0; i<count; i++){
    setTimeout(()=>{
      const emoji = document.createElement('div');
      emoji.className = 'celebration-emoji';
      emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      emoji.style.left = (Math.random() * 100) + '%';
      emoji.style.top = (Math.random() * 100) + '%';
      emoji.style.animationDelay = (Math.random() * 0.5) + 's';
      document.body.appendChild(emoji);
      setTimeout(() => emoji.remove(), 3500);
    }, i * 120);
  }
}

function createCelebrationWords(){
  const words = [
    '–í–ê–£', '–ß–ï–ú–ü–ò–û–ù', '–ú–û–õ–û–î–ï–¶', '–ö–†–ê–°–ê–í–ê', '–õ–ï–ì–ï–ù–î–ê', '–í–ü–ï–†–Å–î', '–¢–û–ü–ß–ò–ö', '–ü–û–ë–ï–î–ê',
    '–û–ì–û–ù–¨', '–¢–´ –õ–£–ß–®–ò–ô', '–î–ê–í–ê–ô –ï–©–Å', '–ù–ï–í–ï–†–û–Ø–¢–ù–û', '–°–£–ü–ï–†', '–ö–†–ê–°–ê–í–ß–ò–ö', '–ú–ê–°–¢–ï–†',
    '–ì–ï–ù–ò–ô', '–ë–û–°–°', '–≠–ü–ò–ß–ù–û', '–ë–†–ê–í–û', '–ì–ì', '–†–ï–°–ü–ï–ö–¢', '–®–ò–ö–ê–†–ù–û', '–ö–†–£–¢–Ø–ö', '–ú–û–©–ù–û',
    '–ö–†–£–¢–û', '–§–ê–ô–ï–†', '–ë–û–ú–ë–ê', '–¢–û–ü-1', '–ü–†–û', '–ú–ê–ì–ò–Ø', '–ß–£–î–û', '–§–ê–ù–¢–ê–°–¢–ò–ö–ê', '–ò–ú–ë–ê',
    '–ë–ï–ó LEVERAGE', '–ë–ï–ó –°–¢–û–ü-–ê–£–¢–û–í', '–¢–≠–ô–ö –ü–†–û–§–ò–¢!', '–ö–û–†–û–õ–¨',
    'TO THE MOON', 'DIAMOND HANDS', '–ö–£–ü–ò –õ–ê–ú–ë–£', 'BULL RUN', '–®–û–†–¢ –ó–ê–ö–†–´–¢',
    '–î–ï–†–ñ–ò –î–û –õ–£–ù–´', '–ù–ï –°–õ–ò–í–ê–ô', '–ü–ê–ú–ü –ò–î–Å–¢', 'WHALE MODE', '–ö–†–ò–ü–¢–û–ë–û–ì'
  ];
  
  const isMobile = window.innerWidth <= 980;
  const gridCols = isMobile ? 3 : 5;
  const gridRows = isMobile ? 4 : 3;
  const positions = [];
  
  for(let row = 0; row < gridRows; row++){
    for(let col = 0; col < gridCols; col++){
      positions.push({
        left: (col * (100 / gridCols)) + (100 / gridCols / 2),
        top: (row * (100 / gridRows)) + (100 / gridRows / 2)
      });
    }
  }
  
  positions.sort(() => Math.random() - 0.5);
  
  const wordsToShow = isMobile ? 8 : 12;
  
  for(let i = 0; i < wordsToShow; i++){
    setTimeout(() => {
      const word = document.createElement('div');
      word.className = 'celebration-word';
      word.textContent = words[Math.floor(Math.random() * words.length)];
      
      const pos = positions[i % positions.length];
      word.style.left = (pos.left + (Math.random() - 0.5) * 15) + '%';
      word.style.top = (pos.top + (Math.random() - 0.5) * 15) + '%';
      word.style.animationDelay = (Math.random() * 0.3) + 's';
      word.style.color = '#fff';
      
      document.body.appendChild(word);
      setTimeout(() => word.remove(), 4500);
    }, i * 150);
  }
}

function createFireworks(){
  const isMobile = window.innerWidth <= 980;
  const fireworkCount = isMobile ? 3 : 5;
  
  for(let f = 0; f < fireworkCount; f++){
    setTimeout(() => {
      const x = 20 + Math.random() * 60;
      const y = 20 + Math.random() * 40;
      const particleCount = isMobile ? 30 : 50;
      const colors = ['#ff6b6b','#ffd43b','#51cf66','#339af0','#da77f2','#66d9e8'];
      const color = colors[Math.floor(Math.random() * colors.length)];
      
      for(let i = 0; i < particleCount; i++){
        const particle = document.createElement('div');
        particle.className = 'firework';
        particle.style.left = x + '%';
        particle.style.top = y + '%';
        particle.style.background = color;
        
        const angle = (Math.PI * 2 * i) / particleCount;
        const velocity = 100 + Math.random() * 100;
        const tx = Math.cos(angle) * velocity;
        const ty = Math.sin(angle) * velocity;
        
        particle.style.animation = `firework-burst ${0.8 + Math.random() * 0.4}s ease-out forwards`;
        particle.style.transform = `translate(${tx}px, ${ty}px) scale(0)`;
        
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 1500);
      }
    }, f * 600);
  }
}

function startSession(){
  if(running) return;
  running=true;
  winnerAnnouncement.classList.remove('show');

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∏–Ω–ø—É—Ç—ã –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –∏ –∫–Ω–æ–ø–∫—É
  lockProbabilityInputs();

  rebuildZones(); seedCandles(); drawChart();
  priceY = candles[candles.length-1]?.c ?? (PADDING_TOP + (H-PADDING_TOP-PADDING_BOTTOM)/2);
  vel = (Math.random()-0.5)*10; startTime=performance.now(); lastCandleTime=startTime;

  const bucket=[];
  names.forEach(n=>{ const w=Math.max(1,Math.round((probabilities[n]||0)*1000)); for(let i=0;i<w;i++) bucket.push(n); });
  const winner=bucket[Math.floor(Math.random()*bucket.length)];
  const z=zones.find(zz=>zz.name===winner) || zones[0];
  const targetY=(z.y0+z.y1)/2;

  function frame(t){
    animId=requestAnimationFrame(frame);
    const elapsed=t-startTime;

    const noise=(Math.random()-0.5)*4.5; 
    vel=vel*0.92+noise; 
    priceY+=vel;
    
    if(priceY<PADDING_TOP+8){ priceY=PADDING_TOP+8; vel=Math.abs(vel)*0.8 }
    if(priceY>H-PADDING_BOTTOM-8){ priceY=H-PADDING_BOTTOM-8; vel=-Math.abs(vel)*0.8 }

    if(t-lastCandleTime>=candlePeriod){
      const prev=candles[candles.length-1] || {o:priceY,h:priceY,l:priceY,c:priceY};
      const isMobile = window.innerWidth <= 980;
      const BASE_WICK = isMobile ? 4 : 8; // –í 2 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö
      const dojiChance = isMobile ? 0.2 : 0; // 20% —à–∞–Ω—Å –¥–æ–¥–∂–∏ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö
      const highLowBarChance = isMobile ? 0.15 : 0; // 15% —à–∞–Ω—Å High-Low Bar –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö

      const rand = Math.random();
      const isHighLowBar = isMobile && rand < highLowBarChance;
      const isDoji = isMobile && !isHighLowBar && rand < (highLowBarChance + dojiChance);

      let drift, o, c, h, l;

      if(isHighLowBar) {
        // High-Low Bar: –Ω–µ—Ç —Ç–µ–ª–∞, —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
        drift = 0;
        o = prev.c;
        c = prev.c; // open == close
        h = c - (BASE_WICK*1.5 + Math.random()*BASE_WICK);
        l = c + (BASE_WICK*1.5 + Math.random()*BASE_WICK);
      } else if(isDoji) {
        // –î–æ–¥–∂–∏: –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–æ–µ —Ç–µ–ª–æ, –¥–ª–∏–Ω–Ω—ã–µ —Ñ–∏—Ç–∏–ª–∏
        drift = (Math.random()-0.5) * 2; // –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π drift
        o = prev.c;
        c = priceY + drift;
        h = Math.min(o,c) - (BASE_WICK*2 + Math.random()*BASE_WICK*2);
        l = Math.max(o,c) + (BASE_WICK*2 + Math.random()*BASE_WICK*2);
      } else {
        // –û–±—ã—á–Ω–∞—è —Å–≤–µ—á–∞
        drift = (Math.random()-0.5)*16;
        o = prev.c;
        c = priceY + drift;
        h = Math.min(o,c) - (BASE_WICK + Math.random()*(isMobile ? 6 : 12));
        l = Math.max(o,c) + (BASE_WICK + Math.random()*(isMobile ? 6 : 12));
      }

      candles.push({o, h:Math.min(h,o,c), l:Math.max(l,o,c), c, isHighLowBar});
      if(candles.length>MAX_CANDLES) candles.shift();
      lastCandleTime=t;
    }else{
      const last=candles[candles.length-1];
      if(last){ 
        last.c=priceY; 
        last.h=Math.min(last.h,priceY); 
        last.l=Math.max(last.l,priceY); 
      }
    }

    const left=duration-elapsed;
    if(left<=850){
      const k=1-Math.max(0,left)/850, ease= p=>1-Math.pow(1-p,3);
      const b=ease(k); priceY=priceY*(1-b)+targetY*b; vel*=0.6;
    }

    drawChart(priceY, elapsed, duration);

    if(elapsed>=duration){
      cancelAnimationFrame(animId);
      running=false;
      gameHasFinished = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã

      const winZone = zones.find(zz=>priceY>=zz.y0 && priceY<=zz.y1) || z;
      announce(winZone.name);
    }
  }
  requestAnimationFrame(frame);
}

/* ============================== –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ ============================== */
window.addEventListener('storage', (e) => {
  if (e.key === NAMES_KEY || e.key === PROB_KEY || e.key === LOCKED_KEY) {
    try {
      const savedNames = JSON.parse(localStorage.getItem(NAMES_KEY) || '[]');
      if (Array.isArray(savedNames) && savedNames.length) names = savedNames;
    } catch (_) {}

    initProbabilities();
    renderNames();
    rebuildZones();
    drawChart();
  }
});

/* ============================== INIT ============================== */
function init(){
  initProbabilities();
  renderNames();
  resize();
  drawChart();
}

// –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
if (document.fonts && document.fonts.ready) {
  document.fonts.ready.then(() => {
    runBtn.addEventListener('click', startSession);
    init();
  });
} else {
  // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
  runBtn.addEventListener('click', startSession);
  init();
}
</script>

  <!-- Yandex.Metrika counter --> <script type="text/javascript"> (function(m,e,t,r,i,k,a){ m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)}; m[i].l=1*new Date(); for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }} k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a) })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=104849796', 'ym'); ym(104849796, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true}); </script> <noscript><div><img src="https://mc.yandex.ru/watch/104849796" style="position:absolute; left:-9999px;" alt="" /></div></noscript> <!-- /Yandex.Metrika counter -->
</body>
</html>